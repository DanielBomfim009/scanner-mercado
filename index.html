<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body{background:#eef3ff;font-family:Arial;margin:0}
.container{max-width:900px;margin:auto;padding:12px}
.logo{text-align:center;margin-top:10px}
.logo img{width:160px;height:160px;border-radius:50%;border:5px solid #fff;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.box{background:white;border-radius:18px;padding:16px;margin-top:15px;box-shadow:0 0 15px #00000010}
button{width:100%;padding:14px;border:none;font-size:16px;border-radius:12px;margin-top:8px}
.btnStart{background:#2e6bff;color:white}
.btnStop{background:#6b6b6b;color:white}

#camera{width:100%;height:260px;background:black;border-radius:18px;margin-top:10px;overflow:hidden;position:relative}
#camera video{width:100%;height:100%;object-fit:cover}

.scan-line{
 position:absolute;left:5%;width:90%;height:2px;
 background:linear-gradient(90deg,transparent,#ff003c,transparent);
 box-shadow:0 0 8px #ff003c,0 0 16px #ff003c;
 animation:scanMove 2s linear infinite;pointer-events:none;
}
@keyframes scanMove{0%{top:10%}50%{top:90%}100%{top:10%}}

input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px}
table{width:100%;border-collapse:collapse}
td,th{padding:10px}
tr:nth-child(even){background:#f5f5f5}

#areaProdutosConteudo{display:none}
.toggleBtn{background:#ffb703}

#carrinhoIcone{
 position:fixed;right:18px;bottom:18px;width:70px;height:70px;
 border-radius:50%;background:#2e6bff;color:white;
 display:flex;align-items:center;justify-content:center;
 font-size:28px;box-shadow:0 8px 20px rgba(0,0,0,.35)
}

.modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none}
.modal-content{background:white;width:92%;margin:40px auto;padding:12px;border-radius:18px}
.total{text-align:right;font-weight:bold}
</style>
</head>

<body>
<div class="container">

<div class="logo"><img src="logo.jpg"></div>
<h1 style="text-align:center">üõí Compras do m√™s</h1>

<div class="box">
<button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
<button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>

<div id="camera">
 <video id="video" playsinline></video>
 <div class="scan-line"></div>
</div>

<p><b>C√≥digo detectado:</b> <span id="detected">‚Äî</span></p>
<p><b>Produto:</b> <span id="produtoDetectado">‚Äî</span></p>
</div>

<div class="box">
<h2>üì¶ Produtos cadastrados</h2>
<button class="toggleBtn" onclick="toggleProdutos()">Mostrar / Ocultar</button>

<div id="areaProdutosConteudo">
<table id="produtosTable">
<thead>
<tr><th>C√≥digo</th><th>Nome</th><th>Tipo</th><th>Pre√ßo</th><th>A√ß√£o</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="box">
<h2>‚úèÔ∏è Edi√ß√£o de produto</h2>
<input id="codigo" placeholder="C√≥digo">
<input id="nome" placeholder="Nome">
<select id="tipo">
<option>Unidade (UN)</option>
<option>Peso (KG)</option>
</select>
<input id="valor" type="number" step="0.01" placeholder="Valor">
<button onclick="salvarProduto()">Salvar</button>
</div>
</div>

<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è</div>

<div id="modalCarrinho" class="modal">
<div class="modal-content">
<h2>Carrinho</h2>
<table id="tabelaCarrinho"></table>
<p id="total" class="total"></p>
<button onclick="fecharCarrinho()">Fechar</button>
</div>
</div>

<script>
let produtos=JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho=[];
let stream=null,reader=null,buffer=[];
let lendo=false;
const repeticoes=3;
const beep=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

function toggleProdutos(){
 let d=document.getElementById("areaProdutosConteudo");
 d.style.display=d.style.display==="block"?"none":"block";
}

function atualizarTabela(){
 let tb=document.querySelector("#produtosTable tbody");
 tb.innerHTML="";
 produtos.forEach(p=>{
  tb.innerHTML+=`
  <tr>
   <td>${p.codigo}</td>
   <td>${p.nome}</td>
   <td>${p.tipo}</td>
   <td>${p.valor}</td>
   <td><button onclick="excluirProduto('${p.codigo}')">üóëÔ∏è</button></td>
  </tr>`;
 });
}
atualizarTabela();

function excluirProduto(c){
 if(confirm("Excluir produto?")){
  produtos=produtos.filter(p=>p.codigo!==c);
  localStorage.setItem("produtos",JSON.stringify(produtos));
  atualizarTabela();
 }
}

function salvarProduto(){
 let p={codigo:codigo.value,nome:nome.value,tipo:tipo.value,valor:Number(valor.value)};
 produtos=produtos.filter(x=>x.codigo!==p.codigo);
 produtos.push(p);
 localStorage.setItem("produtos",JSON.stringify(produtos));
 atualizarTabela();
 alert("Produto salvo");
 iniciarScanner();
}

async function iniciarScanner(){
 pararScanner();
 lendo=false;
 const video=document.getElementById("video");
 stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 video.srcObject=stream;
 video.onloadedmetadata=()=>{
  video.play();
  reader=new ZXing.BrowserMultiFormatReader();
  buffer=[];
  reader.decodeFromVideoElementContinuously(video,(res)=>{
   if(!res||lendo) return;

   const code=res.text.trim();
   detected.innerText=code;
   codigo.value=code;

   const prod=produtos.find(p=>p.codigo===code);
   produtoDetectado.innerText=prod?prod.nome:"Produto n√£o cadastrado";
   produtoDetectado.style.color=prod?"green":"red";

   buffer.push(code);
   if(buffer.length>repeticoes) buffer.shift();

   if(buffer.length===repeticoes && buffer.every(v=>v===code)){
    lendo=true;
    buffer=[];
    beep.play();
    pararScanner();

    if(prod){
     let qtd=prompt("Produto: "+prod.nome+"\nQuantidade:");
     if(qtd){
      carrinho.push({codigo:code,nome:prod.nome,valor:prod.valor,qtd:Number(qtd)});
      atualizarCarrinho();
      abrirCarrinho();
     }
    }else{
     alert("Produto n√£o cadastrado ‚Äî preencha abaixo.");
    }
   }
  });
 };
}

function pararScanner(){
 if(reader) reader.reset();
 if(stream) stream.getTracks().forEach(t=>t.stop());
}

function abrirCarrinho(){modalCarrinho.style.display="block";atualizarCarrinho()}
function fecharCarrinho(){modalCarrinho.style.display="none"}

function atualizarCarrinho(){
 let t=document.getElementById("tabelaCarrinho");
 let total=0;
 t.innerHTML="<tr><th>Nome</th><th>Qtd</th><th>Subtotal</th><th></th></tr>";
 carrinho.forEach((i,idx)=>{
  let sub=i.valor*i.qtd;
  total+=sub;
  t.innerHTML+=`
  <tr>
   <td>${i.nome}</td>
   <td>${i.qtd}</td>
   <td>R$ ${sub.toFixed(2)}</td>
   <td><button onclick="carrinho.splice(${idx},1);atualizarCarrinho()">Excluir</button></td>
  </tr>`;
 });
 totalEl.innerText="Total: R$ "+total.toFixed(2);
}
const totalEl=document.getElementById("total");

startButton.onclick=iniciarScanner;
stopButton.onclick=pararScanner;
</script>
</body>
</html>
