<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner com validaÃ§Ã£o precisa</title>

<style>
video{
  width:100%;
  max-width:450px;
  border:2px solid #444;
  border-radius:10px;
}

#area{
  position:relative;
  display:inline-block;
}

#roi{
  position:absolute;
  top:35%;
  left:15%;
  width:70%;
  height:30%;
  border:3px solid lime;
  border-radius:8px;
  box-shadow:0 0 10px #0f0 inset;
}
</style>

</head>
<body>

<h2>Scanner com validaÃ§Ã£o tripla</h2>

<div id="area">
  <video id="video" playsinline></video>
  <div id="roi"></div>
</div>

<p id="msg" style="color:red"></p>
<p id="lido"></p>
<p id="confirmado" style="color:green;font-weight:bold"></p>

<button onclick="iniciar()">ðŸ“· Iniciar cÃ¢mera</button>
<button onclick="parar()">ðŸ›‘ Parar</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let codeReader = null;
let stream = null;
let buffer = [];
const repeticoes = 3;

function validarEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  let sum = 0;
  for(let i=0;i<12;i++){
    sum += parseInt(code[i]) * (i%2===0?1:3);
  }
  let check = (10 - (sum % 10)) % 10;
  return check === parseInt(code[12]);
}

async function iniciar(){
  document.getElementById("msg").innerText = "Solicitando cÃ¢mera...";

  try{

    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:"environment",
        width:{ ideal:1920 },
        height:{ ideal:1080 },
        focusMode:"continuous"
      }
    });

    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    codeReader = new ZXing.BrowserMultiFormatReader();

    // ðŸ‘‡ forÃ§a somente EAN-13
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13]);

    codeReader = new ZXing.BrowserMultiFormatReader(hints);

    codeReader.decodeFromVideoElementContinuously(video, (resultado, err)=>{

      if(resultado){

        const code = resultado.text;

        document.getElementById("lido").innerText = "Lido: " + code;

        if(!validarEAN13(code)){
          document.getElementById("msg").innerText =
            "âš ï¸ CÃ³digo rejeitado (checksum invÃ¡lido)";
          buffer = [];
          return;
        }

        buffer.push(code);
        if(buffer.length > repeticoes) buffer.shift();

        if(
          buffer.length === repeticoes &&
          buffer.every(v => v === buffer[0])
        ){
          document.getElementById("confirmado").innerText =
            "âœ” Confirmado com precisÃ£o: " + code;

          buffer = [];

          new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
        }
      }
    });

    document.getElementById("msg").innerText =
      "Aponte o cÃ³digo DENTRO do retÃ¢ngulo verde âœ”";

  }catch(e){
    document.getElementById("msg").innerText =
      "âŒ ERRO: " + e.name + " â€” " + e.message;
  }
}

function parar(){
  if(codeReader) codeReader.reset();
  if(stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("msg").innerText = "Scanner parado";
}
</script>

</body>
</html>
