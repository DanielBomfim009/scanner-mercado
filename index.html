<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner EAN-13 com validação</title>

<script type="module">
import {
  BrowserMultiFormatReader,
  BarcodeFormat,
  DecodeHintType
} from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

let reader;
let video;
let lastCodes = [];
const requiredMatches = 3;

// validação oficial EAN-13
function isValidEAN13(code) {
    if (!/^[0-9]{13}$/.test(code)) return false;

    let sum = 0;
    for (let i = 0; i < 12; i++) {
        sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
    }
    let check = (10 - (sum % 10)) % 10;
    return check === parseInt(code[12]);
}

function startScanner() {
    video = document.getElementById("preview");

    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.EAN_13]);

    reader = new BrowserMultiFormatReader(hints);

    reader.decodeFromVideoDevice(null, video, (result, err) => {
        if (result) {
            const code = result.text;

            document.getElementById("lido").innerText = "Lido: " + code;

            // rejeita EAN inválido
            if (!isValidEAN13(code)) {
                document.getElementById("status").innerText =
                  "⚠️ Código rejeitado por checksum";
                lastCodes = [];
                return;
            }

            // guarda leitura
            lastCodes.push(code);
            if (lastCodes.length > requiredMatches) lastCodes.shift();

            document.getElementById("status").innerText =
                "Leituras: " + lastCodes.join(" | ");

            // confirma se 3 iguais
            if (
                lastCodes.length === requiredMatches &&
                lastCodes.every(v => v === lastCodes[0])
            ) {
                document.getElementById("confirmado").innerText =
                    "✔ Código confirmado: " + code;

                lastCodes = [];
            }
        }
    });
}

function stopScanner() {
    if (reader) reader.reset();
    document.getElementById("status").innerText = "Scanner parado";
}

window.onload = startScanner;

</script>
</head>

<body>

<h2>Scanner com validação EAN-13</h2>

<video id="preview" width="100%" style="max-width:400px;"></video>

<p id="lido"></p>
<p id="status"></p>
<h3 id="confirmado" style="color:green;"></h3>

<button onclick="startScanner()">Iniciar</button>
<button onclick="stopScanner()">Parar</button>

</body>
</html>
