<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema com Scanner</title>

<style>

body{
    font-family: Arial;
    margin:0;
    background:#f3f3f3;
}

/* --------- LOGO --------- */
.header{
    text-align:center;
    padding:15px 0;
}

.header img{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    box-shadow:0 5px 18px rgba(0,0,0,0.35);
    border:3px solid white;
}

/* --------- CONTAINERS --------- */
.container{
    max-width:900px;
    margin:auto;
    padding:10px 15px 40px 15px;
}

/* --------- CARD --------- */
.card{
    background:white;
    border-radius:18px;
    padding:18px;
    box-shadow:0 5px 18px rgba(0,0,0,0.20);
    margin-top:12px;
}

/* --------- TITULOS --------- */
h2{
    margin-top:0;
}

/* --------- INPUTS --------- */
input, select{
    width:100%;
    padding:8px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid #bbb;
}

/* --------- GRID CAMPOS --------- */
.grid3{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
}

/* --------- BOT칏ES --------- */
button{
    padding:10px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    background:#1a73e8;
    color:white;
}
button.red{
    background:#d22424;
}

/* --------- VIDEO --------- */
#preview{
    width:100%;
    border-radius:18px;
    background:black;
}

/* --------- CARRINHO ICON --------- */
.cart-btn{
    position:fixed;
    right:20px;
    top:20px;
    background:#1a73e8;
    width:60px;
    height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:50%;
    color:white;
    font-size:26px;
    box-shadow:0 5px 18px rgba(0,0,0,0.25);
}

/* --------- MODAL DO CARRINHO --------- */
.modal{
    position:fixed;
    left:0;
    top:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
}

.modal-content{
    background:white;
    border-radius:18px;
    width:92%;
    max-width:600px;
    max-height:85%;
    overflow-y:auto;
    padding:18px;
}

/* --------- TABELA --------- */
table{
    width:100%;
    border-collapse:collapse;
}

th, td{
    padding:8px;
    border-bottom:1px solid #ddd;
}

.total{
    font-size:20px;
    text-align:right;
    margin-top:10px;
    font-weight:bold;
}
</style>

</head>

<body>

<div class="header">
    <img src="logo.jpg">
</div>

<div class="container">

    <div class="card">
        <h2>Scanner de C칩digo de Barras</h2>
        <video id="preview"></video>
    </div>

    <div class="card">
        <h2>Cadastro / Edi칞칚o de Produto</h2>

        <div class="grid3">
            <div>
                <label>C칩digo</label>
                <input id="codigo">
            </div>

            <div>
                <label>Nome</label>
                <input id="nome">
            </div>

            <div>
                <label>Valor</label>
                <input id="valor" type="number" step="0.01">
            </div>
        </div>

        <label>Tipo</label>
        <select id="tipo">
            <option>UN</option>
            <option>KG</option>
            <option>LT</option>
        </select>

        <br><br>
        <button onclick="salvarProduto()">Salvar / Atualizar</button>
    </div>

</div>

<!-- Bot칚o Carrinho -->
<div class="cart-btn" onclick="abrirCarrinho()">游</div>

<!-- Modal Carrinho -->
<div id="modalCarrinho" class="modal">
    <div class="modal-content">
        <h2>Carrinho</h2>

        <table id="tabelaCarrinho"></table>

        <div id="valorTotal" class="total"></div>

        <br>
        <button class="red" onclick="fecharCarrinho()">Fechar</button>
    </div>
</div>

<!-- JS -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script>

let produtos = {};
let carrinho = [];

/* ------------------ SCANNER ------------------ */

function iniciarScanner(){

    Quagga.stop();

    Quagga.init({
        inputStream:{
            type:"LiveStream",
            constraints:{
                facingMode:"environment" // for칞a traseira
            }
        },
        decoder:{
            readers:["ean_reader","ean_13_reader","code_128_reader"]
        },
        locate:true,
    }, function(err){
        if(err){ console.log(err); return; }
        Quagga.start();
    });

    // melhora precis칚o: exige mesma leitura repetida
    let ultimo = "";
    let repeticoes = 0;

    Quagga.onDetected(function(data){

        const code = data.codeResult.code;

        if(code === ultimo){
            repeticoes++;
        } else {
            repeticoes = 0;
            ultimo = code;
        }

        if(repeticoes >= 3){ // precisa confirmar
            Quagga.stop();
            processarCodigo(code);
        }
    });
}

function processarCodigo(code){

    // j치 existe produto
    if(produtos[code]){

        let qtd = prompt("Quantidade adicionar ao carrinho?");

        if(!qtd || qtd<=0) return;

        carrinho.push({
            codigo:code,
            nome:produtos[code].nome,
            valor:produtos[code].valor,
            qtd:Number(qtd)
        });

        atualizarCarrinho();
        iniciarScanner();

    } else {

        // preenche para cadastro
        document.getElementById("codigo").value = code;
        alert("Produto n칚o cadastrado. Preencha abaixo para salvar.");
        iniciarScanner();
    }
}

/* ------------------ PRODUTOS ------------------ */

function salvarProduto(){

    let codigo = codigo.value;
    produtos[codigo] = {
        nome:nome.value,
        valor:Number(valor.value),
        tipo:tipo.value
    };

    alert("Produto salvo.");
}

/* ------------------ CARRINHO ------------------ */

function abrirCarrinho(){
    document.getElementById("modalCarrinho").style.display = "flex";
    atualizarCarrinho();
}

function fecharCarrinho(){
    document.getElementById("modalCarrinho").style.display = "none";
}

function removerItem(i){
    carrinho.splice(i,1);
    atualizarCarrinho();
}

function atualizarCarrinho(){

    let tabela = document.getElementById("tabelaCarrinho");
    let total = 0;

    tabela.innerHTML = `
        <tr>
            <th>C칩digo</th>
            <th>Nome</th>
            <th>Qtd</th>
            <th>Valor</th>
            <th>A칞칚o</th>
        </tr>
    `;

    carrinho.forEach((item,i)=>{
        let subtotal = item.valor * item.qtd;
        total += subtotal;

        tabela.innerHTML += `
        <tr>
            <td>${item.codigo}</td>
            <td>${item.nome}</td>
            <td>${item.qtd}</td>
            <td>R$ ${subtotal.toFixed(2)}</td>
            <td><button class="red" onclick="removerItem(${i})">Excluir</button></td>
        </tr>`;
    });

    document.getElementById("valorTotal").innerHTML =
        "Total: R$ " + total.toFixed(2);
}

/* iniciar ao abrir */
window.onload = iniciarScanner;

</script>

</body>
</html>
