<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>

body{
    background:#eef3ff;
    font-family: Arial;
    margin:0;
}

.container{
    max-width:900px;
    margin:auto;
    padding:12px;
}

/* LOGO */
.logo{
    text-align:center;
    margin-top:10px;
}
.logo img{
    width:140px;
    border-radius:12px;
}

/* HEADER + CARRINHO */
.headerRow{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:14px;
}

.cartIcon{
    font-size:32px;
    cursor:pointer;
}

/* BOX */
.box{
    background:white;
    border-radius:18px;
    padding:16px;
    margin-top:15px;
    box-shadow:0 0 15px #00000010;
}

/* BOT√ïES */
button{
    width:100%;
    padding:14px;
    border:none;
    font-size:16px;
    border-radius:12px;
    margin-top:8px;
}
.btnStart{ background:#2e6bff; color:white; }
.btnStop{ background:#6b6b6b; color:white; }

#camera{
    width:100%;
    border-radius:16px;
}

input, select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid #ccc;
    margin-top:8px;
    box-sizing:border-box;
}

/* TABLE */
table{
    width:100%;
    border-collapse:collapse;
}

td,th{
    padding:10px;
}

tr:nth-child(even){
    background:#f5f5f5;
}

/* CARRINHO */
#carrinhoBox{
    display:none;
}

.total{
    font-size:20px;
    font-weight:bold;
    text-align:right;
    margin-top:10px;
}

</style>
</head>

<body>

<div class="container">

    <!-- LOGO -->
    <div class="logo">
        <img src="logo.jpg">
    </div>

    <div class="headerRow">
        <h1>üõí Compras do m√™s</h1>
        <span class="cartIcon" onclick="toggleCarrinho()">üõçÔ∏è</span>
    </div>

    <!-- SCANNER -->
    <div class="box">
        <button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
        <button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>

        <div id="camera"></div>

        <p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
    </div>

    <!-- CARRINHO -->
    <div class="box" id="carrinhoBox">
        <h2>üõçÔ∏è Carrinho</h2>

        <table id="carrinhoTable">
            <thead>
            <tr>
                <th>Produto</th>
                <th>Qtd</th>
                <th>Pre√ßo</th>
                <th>Subtotal</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <p class="total">Total: R$ <span id="totalValor">0.00</span></p>
    </div>

    <!-- PRODUTOS -->
    <div class="box">
        <h2>üì¶ Produtos cadastrados</h2>

        <table id="produtosTable">
            <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Pre√ßo</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- EDI√á√ÉO -->
    <div class="box">
        <h2>‚úèÔ∏è Edi√ß√£o de produto</h2>

        <label>C√≥digo</label>
        <input id="codigo">

        <label>Nome</label>
        <input id="nome">

        <label>Tipo</label>
        <select id="tipo">
            <option>Unidade (UN)</option>
            <option>Peso (KG)</option>
        </select>

        <label>Valor</label>
        <input id="valor" type="number" step="0.01">

        <button onclick="salvarProduto()">Salvar</button>
    </div>

</div>

<script>

let produtos = JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho = [];

/* ---------- TABELAS ---------- */
function atualizarTabela(){
    const tb = document.querySelector("#produtosTable tbody");
    tb.innerHTML="";
    produtos.forEach(p=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.codigo}</td><td>${p.nome}</td><td>${p.tipo}</td><td>${p.valor}</td>`;
        tb.appendChild(tr);
    });
}
atualizarTabela();

/* ---------- SALVAR PRODUTO ---------- */
function salvarProduto(){
    let p={
        codigo:codigo.value,
        nome:nome.value,
        tipo:tipo.value,
        valor:parseFloat(valor.value||0)
    };

    produtos = produtos.filter(x=>x.codigo!==p.codigo);
    produtos.push(p);

    localStorage.setItem("produtos",JSON.stringify(produtos));

    atualizarTabela();
    alert("Produto salvo com sucesso!");
}

/* ---------- CARRINHO ---------- */

function toggleCarrinho(){
    let box=document.getElementById("carrinhoBox");
    box.style.display = (box.style.display=="none"||box.style.display=="") ? "block" : "none";
}

function atualizarCarrinho(){

    const tb=document.querySelector("#carrinhoTable tbody");
    tb.innerHTML="";

    let total=0;

    carrinho.forEach(item=>{

        let prod = produtos.find(p=>p.codigo==item.codigo);
        if(!prod) return;

        let subtotal = item.qtd * parseFloat(prod.valor||0);
        total += subtotal;

        let tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${prod.nome}</td>
            <td>${item.qtd}</td>
            <td>R$ ${prod.valor}</td>
            <td>R$ ${subtotal.toFixed(2)}</td>
        `;
        tb.appendChild(tr);
    });

    document.getElementById("totalValor").innerText = total.toFixed(2);
}

/* ---------- SCANNER ---------- */

function iniciarScanner(){

    Quagga.init({
        inputStream:{
            name:"Live",
            type:"LiveStream",
            target:document.querySelector("#camera"),
            constraints:{ facingMode:"environment" }
        },
        locator:{ patchSize:"medium", halfSample:true },
        decoder:{ readers:["ean_reader","ean_13_reader","upc_reader","code_128_reader"] },
        locate:true
    },function(err){
        if(err){console.log(err);return;}
        Quagga.start();
    });

    Quagga.onDetected(function(result){

        let codigo = result.codeResult.code;
        document.getElementById("detected").innerText=codigo;

        tratarCodigo(codigo);

        Quagga.stop();
    });
}

function pararScanner(){
    Quagga.stop();
}

/* ---------- L√ìGICA PRINCIPAL ---------- */
function tratarCodigo(cod){

    let existente = produtos.find(p=>p.codigo==cod);

    if(existente){

        let q = prompt("Quantidade para "+existente.nome);
        if(!q) return;

        carrinho.push({
            codigo:cod,
            qtd:Number(q)
        });

        atualizarCarrinho();
        alert("Adicionado ao carrinho!");
    }
    else{
        alert("Produto n√£o cadastrado. Preencha abaixo.");
        document.getElementById("codigo").value = cod;
        document.getElementById("nome").focus();
    }
}

startButton.onclick=iniciarScanner;
stopButton.onclick=pararScanner;

</script>

</body>
</html>
