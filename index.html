<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4361ee" />
  <title>GoL BUY SMART</title>

  <!-- Bibliotecas externas -->
  <script src="https://unpkg.com/@zxing/library@0.21.2" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #4361ee;
      --secondary: #f72585;
      --background: #f8f9ff;
      --card: #ffffff;
      --text: #212529;
      --radius: 20px;
      --shadow: 0 6px 20px rgba(67, 97, 238, 0.12), 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #121826;
        --card: #1e293b;
        --text: #f1f5f9;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--background);
      font-family: 'Inter', sans-serif;
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 16px;
      line-height: 1.6;
    }

    /* Splash - For√ßa sumir em 1.5s */
    #splash {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeOut 1.5s forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; pointer-events: none; }
    }

    #splash img {
      width: 40vw; /* 40% da largura da tela */
      max-width: 300px;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,0.2));
      margin: 0 auto;
    }

    #splash p {
      margin-top: 16px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      max-width: 80%;
      padding: 0 20px;
    }

    /* Hamburger */
    #hamburger {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 52px;
      height: 52px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 16px;
      z-index: 101;
      font-size: 28px;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.5s 1.5s forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
    #hamburger:hover {
      background: var(--primary-light);
      transform: rotate(90deg) translateY(0);
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 240px;
      background: var(--primary);
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 80px;
      transition: transform 0.3s ease;
      z-index: 100;
      box-shadow: 4px 0 12px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateX(-100%);
      animation: slideIn 0.5s 1.5s forwards;
    }
    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }
    #sidebar.hide {
      transform: translateX(-100%);
    }
    #sidebar button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      width: 100%;
      transition: all 0.2s;
    }
    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
      padding-left: 32px;
    }

    /* Conte√∫do */
    #content {
      margin-left: 240px;
      flex: 1;
      padding: 24px 20px;
      transition: margin-left 0.3s ease;
      opacity: 0;
      animation: fadeInContent 0.5s 1.5s forwards;
    }
    @keyframes fadeInContent {
      to { opacity: 1; }
    }
    #content.full {
      margin-left: 0;
    }

    /* Views */
    .view {
      display: none;
      animation: fadeInUp 0.4s ease;
    }
    .view.active {
      display: block;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: none; }
    }

    /* T√≠tulos */
    h2 {
      font-size: 1.875rem;
      font-weight: 800;
      margin: 0 0 24px;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    /* Cards */
    .box {
      background: var(--card);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 28px;
      box-shadow: var(--shadow);
      border: 1px solid #e0e6f0;
    }
    @media (max-width: 480px) {
      .box { padding: 20px 16px; }
    }

    /* Formul√°rios */
    label {
      display: block;
      margin: 20px 0 8px;
      font-weight: 600;
      color: var(--text);
    }
    input, select {
      width: 100%;
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid #e0e6f0;
      font-size: 16px;
      background: var(--card);
      color: var(--text);
      transition: all 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Or√ßamento */
    #orcamentoBarra {
      height: 12px;
      background: #e0e6f0;
      border-radius: 6px;
      margin-top: 12px;
      overflow: hidden;
      border: 1px solid #d1d9e6;
    }
    #orcamentoBarraInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--secondary), #ff4da6);
      border-radius: 6px;
      transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
    }
    #orcamentoBarraInner::after {
      content: attr(data-pct);
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 12px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Scanner */
    #camera {
      position: relative;
      width: 100%;
      height: 280px;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 24px;
      background: #000;
      box-shadow: var(--shadow);
    }
    #camera video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scan-overlay {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      border: 2px solid var(--secondary);
      border-radius: 8px;
      pointer-events: none;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
    }
    .scan-overlay::before,
    .scan-overlay::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid var(--secondary);
    }
    .scan-overlay::before {
      top: -2px; left: -2px;
      border-right: none; border-bottom: none;
    }
    .scan-overlay::after {
      bottom: -2px; right: -2px;
      border-left: none; border-top: none;
    }
    .scan-line {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 3px;
      background: var(--secondary);
      box-shadow: 0 0 10px var(--secondary-light);
      animation: scan 2.5s linear infinite;
    }
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }

    /* Tabelas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 15px;
    }
    th, td {
      padding: 14px 10px;
      text-align: center;
      border-bottom: 1px solid #e0e6f0;
    }
    th { font-weight: 700; }
    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) {
      background: rgba(67, 97, 238, 0.03);
    }

    /* Bot√µes */
    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .editBtn {
      background: #e2e8f0;
      color: var(--primary);
      padding: 8px 14px;
    }
    .editBtn:hover {
      background: #cbd5e1;
      transform: translateY(-2px);
    }
    .deleteBtn {
      background: var(--danger);
      color: white;
      padding: 8px 14px;
    }
    .deleteBtn:hover {
      background: #ef4444;
      transform: translateY(-2px);
    }
    #salvarCadastro,
    #modalCarrinho button:first-of-type {
      background: var(--primary);
      color: white;
      padding: 14px;
      font-size: 17px;
    }
    #salvarCadastro:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }
    #modalCarrinho button:last-of-type {
      background: #6c757d;
      margin-top: 10px;
    }

    /* Hist√≥rico */
    .historico-card {
      background: var(--card);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border: 1px solid #e0e6f0;
    }
    .historico-card h4 {
      color: var(--primary);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .historico-card small {
      color: #6c757d;
      display: block;
      margin-bottom: 10px;
    }

    /* Carrinho */
    #carrinhoIcone {
      position: fixed;
      bottom: 28px;
      right: 28px;
      width: 72px;
      height: 72px;
      background: var(--secondary);
      border: none;
      border-radius: 50%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      z-index: 200;
      box-shadow: 0 6px 16px rgba(247, 37, 133, 0.4);
      transition: all 0.3s;
      opacity: 0;
      transform: scale(0.8);
      animation: fadeInUp 0.5s 1.5s forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: scale(1); }
    }
    #carrinhoIcone:hover {
      transform: scale(1.1) rotate(12deg);
      box-shadow: 0 8px 24px rgba(247, 37, 133, 0.6);
    }
    #carrinhoIcone span {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Modal */
    #modalCarrinho {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      width: 95%;
      max-width: 500px;
      margin: auto;
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid #e0e6f0;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    #modalCarrinho.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    #total {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 16px 0;
      color: var(--primary);
    }

    /* RESPONSIVIDADE PARA CELULAR */
    @media (max-width: 768px) {
      #sidebar {
        width: 200px;
      }
      #content {
        margin-left: 200px;
      }
      #content.full {
        margin-left: 0;
      }
      .box {
        padding: 20px 16px;
      }
      #orcamentoInput {
        font-size: 15px;
      }
      #scannerChartBox canvas {
        height: 120px !important;
      }
      #camera {
        height: 220px;
      }
      #hamburger {
        width: 48px;
        height: 48px;
        font-size: 24px;
      }
      #carrinhoIcone {
        width: 64px;
        height: 64px;
        font-size: 24px;
      }
      #carrinhoIcone span {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }
      #splash img {
        width: 50vw;
        max-width: 280px;
      }
      #splash p {
        font-size: 16px;
        padding: 0 12px;
      }
    }

    @media (max-width: 480px) {
      #sidebar {
        width: 180px;
      }
      #content {
        margin-left: 180px;
      }
      #content.full {
        margin-left: 0;
      }
      .box {
        padding: 16px 12px;
      }
      #orcamentoInput {
        font-size: 14px;
      }
      #scannerChartBox canvas {
        height: 100px !important;
      }
      #camera {
        height: 200px;
      }
      #hamburger {
        width: 44px;
        height: 44px;
        font-size: 22px;
      }
      #carrinhoIcone {
        width: 60px;
        height: 60px;
        font-size: 22px;
      }
      #carrinhoIcone span {
        width: 18px;
        height: 18px;
        font-size: 10px;
      }
      #splash img {
        width: 60vw;
        max-width: 240px;
      }
      #splash p {
        font-size: 14px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <!-- Splash - For√ßa sumir em 1.5s -->
  <div id="splash" role="alert" aria-live="polite">
    <img src="logo.png" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
    <p>Bem-vindo ao seu app de compras inteligente</p>
  </div>

  <!-- Hamburger -->
  <button id="hamburger" aria-label="Abrir menu">‚ò∞</button>

  <!-- Sidebar -->
  <nav id="sidebar" aria-label="Navega√ß√£o principal">
    <button onclick="irPara('home')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      Home
    </button>
    <button onclick="irPara('scanner')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.8 18.4L18.4 19.8 12 13.4 5.6 19.8 4.2 18.4 12 10.6z"/><circle cx="12" cy="12" r="2"/></svg>
      Scanner
    </button>
    <button onclick="irPara('produtos')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.08-.32.18-.62.18-1a2.996 2.996 0 0 0-2.5-3L12 5.5 8.5 2 6 2.5A3 3 0 0 0 6 8.5c0 .38.1.68.18 1H4c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2v-9c0-1.11-.89-2-2-2z"/></svg>
      Produtos
    </button>
    <button onclick="irPara('cadastro')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      Cadastro
    </button>
    <button onclick="irPara('historico')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.11.9 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>
      Hist√≥rico
    </button>
  </nav>

  <!-- Conte√∫do -->
  <main id="content" role="main">
    <!-- Home -->
    <section id="home" class="view active" aria-labelledby="home-title">
      <img src="logo.png" style="width: 300px; height: auto; margin: 0 auto 20px; object-fit: contain;" alt="GoL BUY SMART" />
      <h2 id="home-title">Bem-vindo ao GoL BUY SMART</h2>
      <div id="orcamento" class="box">
        <label for="orcamentoInput">üí∞ Or√ßamento Mensal (R$)</label>
        <input type="number" id="orcamentoInput" placeholder="Ex: 500" min="0" step="0.01" />
        <div id="orcamentoBarra" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div id="orcamentoBarraInner" data-pct="0%"></div>
        </div>
        <p style="margin-top: 12px; color: #6c757d;">
          Gasto atual: <strong>R$ <span id="orcamentoGasto">0.00</span></strong>
        </p>
      </div>
    </section>

    <!-- Scanner -->
    <section id="scanner" class="view" aria-labelledby="scanner-title">
      <div class="box">
        <h2 id="scanner-title">Scanner de Produtos</h2>
        <div id="camera">
          <video id="video" playsinline muted></video>
          <div class="scan-overlay"></div>
          <div class="scan-line"></div>
        </div>
        <p><strong>C√≥digo detectado:</strong> <span id="detected" aria-live="polite">‚Äî</span></p>
        <p><strong>Total de produtos:</strong> <span id="totalProdutos">0</span></p>
        <div id="scannerChartBox">
          <canvas id="categoriaChart" aria-label="Distribui√ß√£o de categorias" height="150"></canvas>
        </div>
      </div>
    </section>

    <!-- Produtos -->
    <section id="produtos" class="view" aria-labelledby="produtos-title">
      <div class="box">
        <h2 id="produtos-title">Produtos Cadastrados</h2>
        <table id="produtosTable">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Cadastro / Edi√ß√£o -->
    <section id="cadastro" class="view" aria-labelledby="cadastro-title">
      <div class="box">
        <h2 id="cadastro-title">Cadastro de Produto</h2>
        <label for="codigoCadastro">C√≥digo</label>
        <input id="codigoCadastro" placeholder="Ex: 123456" />

        <label for="nomeCadastro">Nome</label>
        <input id="nomeCadastro" placeholder="Ex: Arroz 1kg" />

        <label for="categoriaCadastro">Categoria</label>
        <select id="categoriaCadastro">
          <option value="Alimentos">Alimentos</option>
          <option value="Limpeza">Limpeza</option>
          <option value="Bebida">Bebida</option>
          <option value="Farm√°cia">Farm√°cia</option>
          <option value="Higiene">Higiene</option>
          <option value="Outros">Outros</option>
        </select>

        <label for="tipoCadastro">Tipo</label>
        <select id="tipoCadastro">
          <option>UN</option>
          <option>KG</option>
        </select>

        <label for="valorCadastro">Valor (R$)</label>
        <input id="valorCadastro" type="number" step="0.01" placeholder="Ex: 12.99" min="0" />

        <button id="salvarCadastro">Salvar Produto</button>
      </div>
    </section>

    <!-- Hist√≥rico -->
    <section id="historico" class="view" aria-labelledby="historico-title">
      <div class="box">
        <h2 id="historico-title">Hist√≥rico de Compras</h2>
        <div id="historicoConteudo"></div>
      </div>
    </section>
  </main>

  <!-- Carrinho -->
  <button id="carrinhoIcone" aria-label="Abrir carrinho" onclick="abrirCarrinho()">
    üõçÔ∏è<span id="badge">0</span>
  </button>

  <div id="modalCarrinho" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3>Carrinho</h3>
      <table id="tabelaCarrinho">
        <thead><tr><th>Nome</th><th>Qtd</th><th>Subtotal</th></tr></thead>
        <tbody></tbody>
      </table>
      <p id="total">Total: R$ 0,00</p>
      <button onclick="finalizarCompra()">Finalizar Compra</button>
      <button onclick="fecharCarrinho()">Fechar</button>
    </div>
  </div>

  <script>
    // Utilit√°rios seguros
    const $ = id => document.getElementById(id);
    const Storage = {
      get: (k, f = []) => {
        try {
          return JSON.parse(localStorage.getItem(k)) || f;
        } catch (e) {
          console.warn("Erro ao ler localStorage:", k, e);
          return f;
        }
      },
      set: (k, v) => {
        try {
          localStorage.setItem(k, JSON.stringify(v));
        } catch (e) {
          console.warn("Erro ao salvar localStorage:", k, e);
        }
      }
    };

    const escapeHtml = text => {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    // Dados iniciais
    let produtos = [];
    let carrinho = [];
    let historico = [];
    let orcamento = 0;
    let reader = null, stream = null, buffer = [], scannerAtivo = false;
    const repeticoes = 3;
    let categoriaChart;
    let modoEdicao = false;
    let indiceEdicao = -1;

    // Carregar dados com seguran√ßa
    try {
      produtos = Storage.get("produtos");
      carrinho = Storage.get("carrinho");
      historico = Storage.get("historicoCompras");
      orcamento = parseFloat(Storage.get("orcamento")) || 0;
    } catch (e) {
      console.error("Erro ao carregar dados:", e);
    }

    // Sidebar toggle
    const sidebar = $("sidebar");
    const content = $("content");
    const hamburger = $("hamburger");

    if (hamburger && sidebar && content) {
      hamburger.addEventListener('click', () => {
        sidebar.classList.toggle("hide");
        content.classList.toggle("full");
      });
    }

    // Roteamento seguro
    function irPara(tela) {
      try {
        document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
        const target = $(tela);
        if (target) target.classList.add("active");
        
        if (tela === "cadastro" && !modoEdicao) {
          const title = $("cadastro-title");
          if (title) title.textContent = "Cadastro de Produto";
          ["codigoCadastro", "nomeCadastro", "valorCadastro"].forEach(id => {
            const el = $(id);
            if (el) el.value = "";
          });
          const cat = $("categoriaCadastro");
          if (cat) cat.value = "Alimentos";
          const tipo = $("tipoCadastro");
          if (tipo) tipo.value = "UN";
        }
        
        if (tela === "scanner") {
          iniciarScanner();
          setTimeout(() => {
            if (typeof Chart !== 'undefined') {
              atualizarScannerChart();
            }
          }, 100);
        } else {
          pararScanner();
        }
      } catch (e) {
        console.error("Erro ao navegar para:", tela, e);
      }
    }

    // Or√ßamento
    const orcamentoInput = $("orcamentoInput");
    if (orcamentoInput) {
      orcamentoInput.value = orcamento || '';
      orcamentoInput.addEventListener("input", () => {
        orcamento = parseFloat(orcamentoInput.value) || 0;
        Storage.set("orcamento", orcamento);
        atualizarOrcamento();
      });
    }

    function atualizarOrcamento() {
      const gasto = carrinho.reduce((a, b) => a + (b.valor * (b.qtd || 1)), 0);
      const gastoSpan = $("orcamentoGasto");
      if (gastoSpan) gastoSpan.textContent = gasto.toFixed(2);
      
      const pct = orcamento ? Math.min(100, (gasto / orcamento) * 100) : 0;
      const bar = $("orcamentoBarraInner");
      if (bar) {
        bar.style.width = pct + "%";
        bar.setAttribute('data-pct', Math.round(pct) + '%');
      }
    }

    // Produtos
    function atualizarProdutosTable() {
      const tbody = $("produtosTable")?.querySelector("tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";
      produtos.forEach((p, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(p.codigo)}</td>
          <td>${escapeHtml(p.nome)}</td>
          <td>${escapeHtml(p.categoria)}</td>
          <td>${escapeHtml(p.tipo)}</td>
          <td>R$ ${p.valor.toFixed(2)}</td>
          <td>
            <button class="editBtn" onclick="editarProduto(${i})" aria-label="Editar ${p.nome}">‚úèÔ∏è</button>
            <button class="deleteBtn" onclick="excluirProduto(${i})" aria-label="Excluir ${p.nome}">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(row);
      });
      const totalSpan = $("totalProdutos");
      if (totalSpan) totalSpan.textContent = produtos.length;
    }

    function editarProduto(i) {
      modoEdicao = true;
      indiceEdicao = i;
      const p = produtos[i];
      const title = $("cadastro-title");
      if (title) title.textContent = "Editar Produto";
      const codigo = $("codigoCadastro");
      if (codigo) codigo.value = p.codigo;
      const nome = $("nomeCadastro");
      if (nome) nome.value = p.nome;
      const categoria = $("categoriaCadastro");
      if (categoria) categoria.value = p.categoria;
      const tipo = $("tipoCadastro");
      if (tipo) tipo.value = p.tipo;
      const valor = $("valorCadastro");
      if (valor) valor.value = p.valor;
      irPara("cadastro");
    }

    function excluirProduto(i) {
      if (confirm("Tem certeza que deseja excluir este produto?")) {
        produtos.splice(i, 1);
        Storage.set("produtos", produtos);
        atualizarProdutosTable();
      }
    }

    const salvarBtn = $("salvarCadastro");
    if (salvarBtn) {
      salvarBtn.addEventListener('click', () => {
        const novo = {
          codigo: $("codigoCadastro")?.value.trim() || "",
          nome: $("nomeCadastro")?.value.trim() || "",
          categoria: $("categoriaCadastro")?.value || "Alimentos",
          tipo: $("tipoCadastro")?.value || "UN",
          valor: parseFloat($("valorCadastro")?.value) || 0
        };
        
        if (!novo.codigo || !novo.nome || !novo.valor || isNaN(novo.valor) || novo.valor <= 0) {
          alert("Preencha todos os campos corretamente.");
          return;
        }

        if (modoEdicao) {
          produtos[indiceEdicao] = novo;
          modoEdicao = false;
          indiceEdicao = -1;
        } else {
          produtos.push(novo);
        }

        Storage.set("produtos", produtos);
        atualizarProdutosTable();
        const title = $("cadastro-title");
        if (title) title.textContent = "Cadastro de Produto";
        irPara("produtos");
      });
    }

    // Carrinho
    function atualizarCarrinho() {
      const tbody = $("tabelaCarrinho")?.querySelector("tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";
      let total = 0;
      carrinho.forEach(p => {
        const qtd = p.qtd || 1;
        const sub = p.valor * qtd;
        total += sub;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(p.nome)}</td>
          <td>${qtd}</td>
          <td>R$ ${sub.toFixed(2)}</td>`;
        tbody.appendChild(row);
      });
      const totalEl = $("total");
      if (totalEl) totalEl.textContent = "Total: R$ " + total.toFixed(2);
      const badge = $("badge");
      if (badge) badge.textContent = carrinho.length;
      atualizarOrcamento();
    }

    function abrirCarrinho() {
      const modal = $("modalCarrinho");
      if (modal) {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
        atualizarCarrinho();
      }
    }

    function fecharCarrinho() {
      const modal = $("modalCarrinho");
      if (modal) {
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
      }
    }

    function finalizarCompra() {
      if (!carrinho.length) return alert("Carrinho vazio");
      const total = carrinho.reduce((a, b) => a + b.valor * (b.qtd || 1), 0);
      historico.push({
         new Date().toLocaleString("pt-BR"),
        total,
        itens: [...carrinho]
      });
      Storage.set("historicoCompras", historico);
      carrinho = [];
      Storage.set("carrinho", carrinho);
      atualizarCarrinho();
      atualizarHistorico();
      fecharCarrinho();
      alert("‚úÖ Compra finalizada com sucesso!");
    }

    // Hist√≥rico
    function atualizarHistorico() {
      const area = $("historicoConteudo");
      if (!area) return;
      
      area.innerHTML = "";
      if (!historico.length) {
        area.innerHTML = "<p style='text-align:center; color:#6c757d;'>Nenhuma compra registrada.</p>";
        return;
      }
      historico.forEach((compra, idx) => {
        const card = document.createElement('div');
        card.className = 'historico-card';
        card.innerHTML = `
          <h4>Compra #${idx + 1}</h4>
          <small>${escapeHtml(compra.data)}</small>
          <p><strong>Total:</strong> R$ ${compra.total.toFixed(2)}</p>
          <details><summary style="color:var(--primary); cursor:pointer;">Ver itens</summary><ul id="itens-${idx}"></ul></details>`;
        area.appendChild(card);

        const ul = card.querySelector(`#itens-${idx}`);
        if (ul) {
          compra.itens.forEach(it => {
            const li = document.createElement('li');
            li.textContent = `${it.nome} ‚Äî ${it.qtd || 1} x R$ ${it.valor.toFixed(2)} = R$ ${(it.qtd * it.valor).toFixed(2)}`;
            ul.appendChild(li);
          });
        }
      });
    }

    // Scanner
    async function iniciarScanner() {
      if (scannerAtivo) return;
      scannerAtivo = true;
      buffer = [];
      if (!stream) {
        try {
          const constraints = { video: { facingMode: "environment" } };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          const video = $("video");
          if (video) video.srcObject = stream;
          const playPromise = video?.play();
          if (playPromise) {
            playPromise.catch(() => {
              console.warn("Video play falhou");
            });
          }
        } catch (err) {
          alert("‚ö†Ô∏è Permiss√£o da c√¢mera negada.");
          return;
        }
      }
      if (typeof ZXing === 'undefined') {
        console.warn("ZXing n√£o carregado");
        return;
      }
      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoElementContinuously($("video"), (res) => {
        if (!res || !scannerAtivo) return;
        const codigo = res.text.trim();
        buffer.push(codigo);
        if (buffer.length > repeticoes) buffer.shift();
        const count = buffer.filter(v => v === codigo).length;
        const detected = $("detected");
        if (detected) detected.textContent = codigo;
        if (count >= repeticoes) processarCodigo(codigo);
      });
    }

    function processarCodigo(codigo) {
      navigator.vibrate?.(100);
      scannerAtivo = false;
      const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
      beep.play().catch(() => {});
      const produto = produtos.find(x => x.codigo === codigo);
      setTimeout(() => {
        if (produto) {
          const q = prompt(`Produto: ${produto.nome}\nDigite a quantidade:`);
          const qtd = parseInt(q);
          if (qtd > 0) {
            carrinho.push({ ...produto, qtd });
            Storage.set("carrinho", carrinho);
            abrirCarrinho();
          }
        } else {
          alert("‚ùå Produto n√£o cadastrado.");
        }
        scannerAtivo = true;
        buffer = [];
        atualizarCarrinho();
      }, 400);
    }

    function pararScanner() {
      scannerAtivo = false;
      if (reader) reader.reset();
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      const video = $("video");
      if (video) video.srcObject = null;
    }

    // Gr√°fico - S√≥ se Chart.js estiver dispon√≠vel
    function atualizarScannerChart() {
      if (typeof Chart === 'undefined') {
        console.warn("Chart.js n√£o carregado");
        return;
      }
      const ctx = $("categoriaChart");
      if (!ctx || !produtos || produtos.length === 0) return;

      if (categoriaChart) categoriaChart.destroy();

      const categorias = {};
      produtos.forEach(p => {
        categorias[p.categoria] = (categorias[p.categoria] || 0) + 1;
      });

      const labels = Object.keys(categorias);
      if (labels.length === 0) return;

      const data = Object.values(categorias);
      const cores = ['#4361ee', '#f72585', '#4cc9f0', '#7209b7', '#3a0ca3', '#4361ee'];

      categoriaChart = new Chart(ctx, {
        type: 'doughnut',
         { labels, datasets: [{ data, backgroundColor: cores, borderWidth: 0 }] },
        options: {
          responsive: true,
          cutout: '70%',
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { padding: 20, usePointStyle: true, font: { size: 12 } }
            }
          }
        }
      });
    }

    // Modal carrinho
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && $("modalCarrinho")?.style.display !== 'none') fecharCarrinho();
    });
    $("modalCarrinho")?.addEventListener('click', e => {
      if (e.target === $("modalCarrinho")) fecharCarrinho();
    });

    // Inicializa√ß√£o segura
    function inicializarApp() {
      try {
        atualizarHistorico();
        atualizarProdutosTable();
        atualizarCarrinho();
        
        // For√ßa mostrar conte√∫do ap√≥s 1.5s
        setTimeout(() => {
          const splash = $("splash");
          if (splash) splash.style.display = "none";
          
          const hamburger = $("hamburger");
          if (hamburger) hamburger.style.opacity = "1";
          
          const sidebar = $("sidebar");
          if (sidebar) sidebar.style.opacity = "1";
          
          const content = $("content");
          if (content) content.style.opacity = "1";
          
          const carrinhoIcone = $("carrinhoIcone");
          if (carrinhoIcone) carrinhoIcone.style.opacity = "1";
        }, 1500);
      } catch (e) {
        console.error("Erro na inicializa√ß√£o:", e);
      }
    }

    // Executa ap√≥s o DOM carregar
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", inicializarApp);
    } else {
      inicializarApp();
    }
  </script>
</body>
</html>
