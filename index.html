<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GoL BUY SMART - Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Aplicativo web de compras inteligentes com leitor de c√≥digo de barras">
<meta name="theme-color" content="#3b7ddd">

<script src="https://unpkg.com/@zxing/library@0.21.2"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#3b7ddd;
  --secondary:#ffb703;
  --background:#eef3ff;
  --card-bg:#ffffff;
  --text-dark:#1a1a1a;
  --text-light:#ffffff;
  --danger:#ff3b3b;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background:var(--background);overflow-x:hidden;}
.container{max-width:900px;margin:auto;padding:12px;}
.logo{text-align:center;margin-top:20px;}
.logo img{width:200px;height:200px;object-fit:contain;border-radius:50%;border:5px solid var(--text-light);box-shadow:0 10px 30px rgba(0,0,0,.35);}
h1{text-align:center;margin:15px 0;color:var(--primary);}
.box{background:var(--card-bg);border-radius:18px;padding:20px;margin-top:20px;box-shadow:0 4px 20px rgba(0,0,0,.15);}
button{width:100%;padding:14px;border:none;font-size:16px;border-radius:12px;margin-top:10px;cursor:pointer;}
.btnStart{background:var(--primary);color:white;}
.btnStop{background:#6b6b6b;color:white;}
.toggleBtn{background:var(--secondary);color:#000;font-weight:500;}

#camera{width:100%;height:260px;background:#000;border-radius:18px;margin-top:12px;overflow:hidden;position:relative;}
#camera video{width:100%;height:100%;object-fit:cover;}
.scan-line{position:absolute;left:0;right:0;height:2px;background:red;animation:scan 2s linear infinite;}
@keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}

input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px;font-size:15px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
td,th{padding:10px;text-align:center;}
tr:nth-child(even){background:#f5f5f5;}

#carrinhoIcone{
  position:fixed;left:18px;bottom:18px;width:70px;height:70px;border-radius:50%;
  background:var(--primary);color:white;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;box-shadow:0 8px 20px rgba(0,0,0,.35);cursor:pointer;z-index:999;
}
#carrinhoIcone span{
  position:absolute;top:-8px;right:-8px;background:red;color:white;
  width:18px;height:18px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:12px;
}

.modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;z-index:1000;}
.modal-content{background:white;width:92%;max-width:480px;margin:40px auto;padding:20px;border-radius:18px;}
.modal-header{display:flex;justify-content:space-between;align-items:center;}
.total{text-align:right;font-weight:bold;margin-top:10px;}

#cadastroSuspenso{
  position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
  width:90%;max-width:400px;background:white;padding:20px;border-radius:18px;
  box-shadow:0 5px 20px rgba(0,0,0,.3);display:none;z-index:1001;
}

#barraValidacao{height:22px;width:100%;background:#ccc;border-radius:12px;margin-top:6px;}
#barraValidacaoInner{height:100%;width:0%;background:var(--primary);border-radius:12px;text-align:center;color:white;font-weight:bold;}

/* ===== ANIMA√á√ÉO ENTRE TELAS (ADICIONADO) ===== */
.view{animation:fade .25s ease;}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash" style="position:fixed;inset:0;background:#1a1a1a;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:2000;">
  <img src="logo.png" style="width:300px;height:300px;object-fit:contain;">
  <p style="margin-top:15px;font-size:18px;">Bem-vindo ao seu app de compras inteligente</p>
</div>

<div class="container" id="app" style="display:none;">

  <!-- MENU -->
  <div class="box">
    <button class="btnStart" onclick="irPara('home')">üè† Home</button>
    <button class="btnStart" onclick="irPara('scanner')">üì∑ Scanner</button>
    <button class="btnStart" onclick="irPara('produtos')">üì¶ Produtos</button>
    <button class="btnStart" onclick="irPara('historico')">üßæ Hist√≥rico</button>
  </div>

  <!-- HOME -->
  <section class="view" id="home">
    <div class="logo"><img src="logo.png"></div>
    <h1>üõí Compras do m√™s</h1>
  </section>

  <!-- SCANNER -->
  <section class="view" id="scanner" style="display:none;">
    <div class="box">
      <button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
      <button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>
      <div id="camera">
        <video id="video" playsinline></video>
        <div class="scan-line"></div>
      </div>
      <p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
      <div id="barraValidacao"><div id="barraValidacaoInner">0%</div></div>
    </div>
  </section>

  <!-- PRODUTOS -->
  <section class="view" id="produtos" style="display:none;">
    <div class="box">
      <h2>üì¶ Produtos cadastrados</h2>
      <table id="produtosTable">
        <thead>
          <tr><th>C√≥digo</th><th>Nome</th><th>Tipo</th><th>Pre√ßo</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section class="view" id="historico" style="display:none;">
    <div class="box">
      <h2>üßæ Hist√≥rico de compras</h2>
      <button class="toggleBtn" onclick="atualizarHistorico()">Atualizar</button>
      <button class="btnStop" onclick="apagarHistorico()">Apagar</button>
      <div id="historicoConteudo"></div>
    </div>
  </section>

</div>

<!-- CARRINHO -->
<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è<span id="badge">0</span></div>

<div id="modalCarrinho" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Carrinho</h2>
      <button onclick="fecharCarrinho()">Fechar</button>
    </div>
    <table id="tabelaCarrinho"></table>
    <p id="total" class="total">Total: R$ 0,00</p>
    <button class="btnStart" onclick="finalizarCompra()">Finalizar</button>
  </div>
</div>

<!-- CADASTRO (PREPARADO PARA VIRAR TELA FUTURA) -->
<div id="cadastroSuspenso">
  <h2>‚úèÔ∏è Cadastrar Produto</h2>
  <input id="codigoSuspenso" placeholder="C√≥digo">
  <input id="nomeSuspenso" placeholder="Nome">
  <select id="tipoSuspenso">
    <option>Unidade (UN)</option>
    <option>Peso (KG)</option>
  </select>
  <input id="valorSuspenso" type="number" step="0.01" placeholder="Valor">
  <button id="salvarSuspenso" class="btnStart">Salvar</button>
</div>

<script>
/* ================= UTIL ================= */
const $=id=>document.getElementById(id);
const Storage={
  get:(k,f=[])=>{try{const v=JSON.parse(localStorage.getItem(k));return Array.isArray(v)?v:f}catch{return f}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};

/* ================= ESTADO ================= */
let produtos=Storage.get("produtos");
let carrinho=Storage.get("carrinho");
let historicoCompras=Storage.get("historicoCompras");

let reader=null,stream=null,buffer=[],scannerAtivo=false;
const repeticoes=3;
const beep=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

/* ================= SPLASH ================= */
window.onload=()=>setTimeout(()=>{
  $("splash").style.display="none";
  $("app").style.display="block";
  irPara("home");
},1500);

/* ================= SCANNER ================= */
async function iniciarScanner(){
  if(scannerAtivo)return;
  scannerAtivo=true;buffer=[];
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  $("video").srcObject=stream;
  await $("video").play();
reader = new ZXingBrowser.BrowserMultiFormatReader();

reader.decodeFromVideoElementContinuously(
  $("video"),
  (res, err) => {
    if (res) {
      const codigo = res.text;
      buffer.push(codigo);
      if (buffer.length > repeticoes) buffer.shift();

      if (buffer.filter(v => v === codigo).length >= repeticoes) {
        processarCodigo(codigo);
        buffer = [];
      }
    }
  }
);
}
function pararScanner(){
  if(reader)reader.reset();
  if(stream)stream.getTracks().forEach(t=>t.stop());
  scannerAtivo=false;
}

/* ================= ROUTER ================= */
function irPara(tela){
  document.querySelectorAll(".view").forEach(v=>v.style.display="none");
  document.getElementById(tela).style.display="block";
  if(tela==="scanner") iniciarScanner(); else pararScanner();
}
</script>
</body>
</html>
