<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compras do M√™s</title>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f8;
  margin: 0;
}

.container {
  max-width: 480px;
  margin: auto;
  padding: 15px;
}

.logo {
  display: flex;
  justify-content: center;
  margin-top: 15px;
}

.logo img {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 4px 10px rgba(0,0,0,.2);
}

h1 {
  text-align: center;
  margin: 10px 0 20px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  margin-top: 8px;
}

.primary { background: #2f80ed; color: white; }
.gray { background: #828282; color: white; }
.danger { background: #eb5757; color: white; }

#camera {
  width: 100%;
  height: 280px;
  display: none;
  margin-top: 10px;
  border-radius: 10px;
  overflow: hidden;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

ul {
  list-style: none;
  padding: 0;
}

li {
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}

.actions button {
  width: auto;
  padding: 6px 10px;
  font-size: 13px;
}
</style>
</head>

<body>

<div class="container">

  <div class="logo">
    <img src="https://raw.githubusercontent.com/DanielBomfim009/scanner-mercado/main/logo.jpg">
  </div>

  <h1>üõí Compras do M√™s</h1>

  <div class="card">
    <button class="primary" onclick="startScanner()">üì∑ Abrir C√¢mera</button>
    <button class="gray" onclick="stopScanner()">‚èπ Parar</button>
    <div id="camera"></div>
  </div>

  <div class="card" id="cadastro" style="display:none">
    <h3>üì¶ Cadastro / Edi√ß√£o</h3>

    <input id="codigo" readonly placeholder="C√≥digo de barras">
    <input id="nome" placeholder="Nome do produto">

    <select id="tipo">
      <option value="UN">Unidade</option>
      <option value="KG">Kg</option>
    </select>

    <input id="preco" type="number" step="0.01" placeholder="Pre√ßo">
    <button class="primary" onclick="salvarProduto()">Salvar</button>
  </div>

  <div class="card">
    <h3>üì¶ Produtos Cadastrados</h3>
    <ul id="listaProdutos"></ul>
  </div>

  <div class="card">
    <h3>üõí Carrinho</h3>
    <ul id="listaCarrinho"></ul>
    <h2>Total: R$ <span id="total">0.00</span></h2>
    <button class="danger" onclick="limparCarrinho()">Limpar Carrinho</button>
  </div>

</div>

<script>
const camera = document.getElementById("camera");
const cadastro = document.getElementById("cadastro");
const codigoInput = document.getElementById("codigo");
const nome = document.getElementById("nome");
const tipo = document.getElementById("tipo");
const preco = document.getElementById("preco");
const listaProdutos = document.getElementById("listaProdutos");
const listaCarrinho = document.getElementById("listaCarrinho");
const totalSpan = document.getElementById("total");

let produtos = JSON.parse(localStorage.getItem("produtos")) || {};
let carrinho = [];
let codigoAtual = null;
let lendo = false;

/* üîí CONTROLE DE LEITURA */
let ultimoCodigo = null;
let contadorLeitura = 0;
let bloqueado = false;

function startScanner() {
  if (lendo) return;
  lendo = true;
  camera.style.display = "block";

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: camera,
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["ean_reader","code_128_reader"] }
  }, err => {
    if (err) {
      alert("Erro na c√¢mera");
      lendo = false;
      return;
    }
    Quagga.start();
  });

  Quagga.offDetected();
  Quagga.onDetected(res => {
    if (bloqueado) return;

    const cod = res.codeResult.code;

    if (cod === ultimoCodigo) {
      contadorLeitura++;
    } else {
      ultimoCodigo = cod;
      contadorLeitura = 1;
    }

    if (contadorLeitura >= 2) {
      bloqueado = true;
      setTimeout(() => bloqueado = false, 2000);
      stopScanner();
      processarCodigo(cod);
    }
  });
}

function stopScanner() {
  lendo = false;
  try { Quagga.stop(); } catch(e){}
  camera.style.display = "none";
}

function processarCodigo(cod) {
  codigoAtual = cod;

  if (produtos[cod]) {
    pedirQuantidade(produtos[cod]);
  } else {
    cadastro.style.display = "block";
    codigoInput.value = cod;
    nome.value = "";
    tipo.value = "UN";
    preco.value = "";
  }
}

function salvarProduto() {
  if (!nome.value || !preco.value) {
    alert("Preencha tudo");
    return;
  }

  produtos[codigoAtual] = {
    nome: nome.value,
    tipo: tipo.value,
    preco: parseFloat(preco.value)
  };

  localStorage.setItem("produtos", JSON.stringify(produtos));
  cadastro.style.display = "none";
  listarProdutos();
  pedirQuantidade(produtos[codigoAtual]);
}

function listarProdutos() {
  listaProdutos.innerHTML = "";
  Object.keys(produtos).forEach(cod => {
    const p = produtos[cod];
    const li = document.createElement("li");
    li.innerHTML = `
      <b>${p.nome}</b><br>
      C√≥digo: ${cod}<br>
      ${p.tipo} - R$ ${p.preco.toFixed(2)}
      <div class="actions">
        <button onclick="editarProduto('${cod}')">Editar</button>
        <button class="danger" onclick="excluirProduto('${cod}')">Excluir</button>
      </div>`;
    listaProdutos.appendChild(li);
  });
}

function editarProduto(cod) {
  const p = produtos[cod];
  codigoAtual = cod;
  codigoInput.value = cod;
  nome.value = p.nome;
  tipo.value = p.tipo;
  preco.value = p.preco;
  cadastro.style.display = "block";
}

function excluirProduto(cod) {
  if (!confirm("Excluir produto?")) return;
  delete produtos[cod];
  localStorage.setItem("produtos", JSON.stringify(produtos));
  listarProdutos();
}

function pedirQuantidade(p) {
  let q = prompt(p.tipo === "UN" ? "Quantidade:" : "Peso (KG):");
  q = parseFloat(q);
  if (!q) return;

  carrinho.push({ ...p, q, subtotal: q * p.preco });
  atualizarCarrinho();
}

function atualizarCarrinho() {
  listaCarrinho.innerHTML = "";
  let total = 0;

  carrinho.forEach(p => {
    total += p.subtotal;
    const li = document.createElement("li");
    li.textContent = `${p.nome} (${p.q} ${p.tipo}) - R$ ${p.subtotal.toFixed(2)}`;
    listaCarrinho.appendChild(li);
  });

  totalSpan.textContent = total.toFixed(2);
}

function limparCarrinho() {
  carrinho = [];
  atualizarCarrinho();
}

listarProdutos();
</script>

</body>
</html>
