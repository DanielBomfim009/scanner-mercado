<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Compras do MÃªs</title>

<style>
body{
  font-family: Arial;
  background:#f3f4f6;
  margin:0;
}

.container{
  max-width:900px;
  margin:auto;
  padding:15px;
}

.card{
  background:white;
  padding:15px;
  border-radius:12px;
  margin-top:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}

button{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  font-size:16px;
  font-weight:bold;
  color:white;
}

.primary{background:#1e73ff;}
.danger{background:#555;}

#camera-box{
  width:100%;
  max-height:320px;
  overflow:hidden;
  border-radius:12px;
  background:black;
  margin-top:10px;
}

#camera{
  width:100%;
  object-fit:cover;
}

table{
  width:100%;
  border-collapse:collapse;
}

td,th{
  padding:8px;
}

tr:nth-child(even){
  background:#f8f8f8;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

</head>
<body>

<div class="container">

<h2>ğŸ›’ Compras do mÃªs</h2>

<div class="card">

<button class="primary" onclick="startScanner()">ğŸ“· Abrir cÃ¢mera</button>
<button class="danger" onclick="stopScanner()">â¹ Parar</button>

<div id="camera-box">
  <video id="camera"></video>
</div>

<p id="codigoLido"></p>

</div>

<button class="primary" onclick="toggleProdutos()">ğŸ“¦ Ver produtos cadastrados</button>

<div class="card" id="produtosCard" style="display:none">

<h3>ğŸ“‹ Produtos cadastrados</h3>

<table id="tabelaProdutos">
<thead>
<tr>
<th>CÃ³digo</th><th>Nome</th><th>Tipo</th><th>PreÃ§o</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<div class="card">

<h3>Cadastro / EdiÃ§Ã£o</h3>

<p><b id="codigoAtual"></b></p>

<input id="nome" placeholder="Nome do produto">

<select id="tipo">
<option value="UN">Unidade</option>
<option value="KG">Kg</option>
</select>

<input id="preco" type="number" step="0.01" placeholder="PreÃ§o">

<button class="primary" onclick="salvarProduto()">Salvar</button>

</div>

<div class="card">
<h3>ğŸ›’ Carrinho</h3>
<p id="total">Total R$ 0,00</p>
</div>

</div>

<script>

let ultimoCodigo = null;
let banco = JSON.parse(localStorage.getItem("produtos")||"{}");

function startScanner(){

  Quagga.stop();

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector("#camera"),
      constraints:{facingMode:"environment"}
    },
    decoder:{
      readers:["ean_reader","ean_13_reader"]
    },
    locate:true
  }, function(err){
    if(err){alert("Erro cÃ¢mera");return;}
    Quagga.start();
  });

  Quagga.onDetected(e =>{
    const code=e.codeResult.code;

    // evita falso positivo
    if(code===ultimoCodigo) return;
    ultimoCodigo=code;

    document.getElementById("codigoLido").innerText="CÃ³digo lido: "+code;
    document.getElementById("codigoAtual").innerText=code;

    if(banco[code]){
      carregarParaEdicao(code);
    } else {
      limparCampos();
    }
  });
}

function stopScanner(){
  Quagga.stop();
}

function salvarProduto(){
  const codigo=document.getElementById("codigoAtual").innerText;
  banco[codigo]={
    nome:document.getElementById("nome").value,
    tipo:document.getElementById("tipo").value,
    preco:document.getElementById("preco").value
  };
  localStorage.setItem("produtos",JSON.stringify(banco));
  montarTabela();
  alert("Salvo com sucesso!");
}

function toggleProdutos(){
  const d=document.getElementById("produtosCard");
  d.style.display=d.style.display==="none"?"block":"none";
  montarTabela();
}

function carregarParaEdicao(c){
 document.getElementById("nome").value=banco[c].nome;
 document.getElementById("tipo").value=banco[c].tipo;
 document.getElementById("preco").value=banco[c].preco;
}

function limparCampos(){
 document.getElementById("nome").value="";
 document.getElementById("preco").value="";
}

function excluir(c){
 delete banco[c];
 localStorage.setItem("produtos",JSON.stringify(banco));
 montarTabela();
}

function montarTabela(){
 const tbody=document.querySelector("#tabelaProdutos tbody");
 tbody.innerHTML="";
 Object.keys(banco).forEach(c=>{
  let p=banco[c];
  tbody.innerHTML+=`
<tr>
<td>${c}</td>
<td>${p.nome}</td>
<td>${p.tipo}</td>
<td>${p.preco}</td>
<td>
<button onclick="document.getElementById('codigoAtual').innerText='${c}'; carregarParaEdicao('${c}')">Editar</button>
<button onclick="excluir('${c}')">Excluir</button>
</td>
</tr>`;
 })
}

</script>

</body>
</html>
