<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body{background:#eef3ff;font-family:Arial;margin:0;}
.container{max-width:900px;margin:auto;padding:12px;}
.logo{text-align:center;margin-top:20px;}
.logo img{
  width:160px;
  height:160px;
  object-fit:contain;
  border-radius:50%;
  border:5px solid #fff;
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
  background:#eef3ff;
  transition: transform 0.3s;
}
.logo img:hover{transform:scale(1.05);}

.box{background:white;border-radius:18px;padding:16px;margin-top:15px;box-shadow:0 0 15px #00000010;}
button{width:100%;padding:14px;border:none;font-size:16px;border-radius:12px;margin-top:8px;}
.btnStart{background:#2e6bff;color:white;}
.btnStop{background:#6b6b6b;color:white;}

#camera{width:100%;height:260px;background:black;border-radius:18px;margin-top:10px;overflow:hidden;position:relative;}
#camera video{width:100%;height:100%;object-fit:cover;}

.scan-line{
  position:absolute;left:0;right:0;height:2px;
  background:red;box-shadow:0 0 10px red,0 0 20px red;
  animation:scan 2s linear infinite;
}
@keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}

input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px;}
table{width:100%;border-collapse:collapse;}
td,th{padding:10px;}
tr:nth-child(even){background:#f5f5f5;}

#carrinhoIcone{
  position:fixed;left:18px;bottom:18px;width:70px;height:70px;
  border-radius:50%;background:#2e6bff;color:white;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;box-shadow:0 8px 20px rgba(0,0,0,.35);cursor:pointer;
}

.modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;}
.modal-content{background:white;width:92%;margin:40px auto;padding:12px;border-radius:18px;max-height:80vh;overflow-y:auto;}
.total{text-align:right;font-weight:bold;padding-top:10px;}

#areaProdutosConteudo{display:none;}
.toggleBtn{background:#ffb703;color:#000;}

.produtoDetectado{text-align:center;font-weight:bold;color:#2e6bff;margin-top:6px;}

.subtotal{
  background:#e6edff;
  color:#1a3cff;
  padding:4px 8px;
  border-radius:6px;
  font-weight:bold;
}

.btn-trash{
  background:none;border:none;font-size:20px;cursor:pointer;color:#ff3b3b;
}
.btn-trash:hover{transform:scale(1.15);}
.removendo{animation:remover .3s forwards;}
@keyframes remover{to{opacity:0;transform:translateX(-40px);}}
</style>
</head>

<body>

<div class="container">
  <div class="logo"><img src="logo.png" alt="Gael Logo"></div>
  <h1 style="text-align:center">üõí Compras do m√™s üõçÔ∏è</h1>

  <div class="box">
    <button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
    <button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>
    <div id="camera">
      <video id="video" playsinline></video>
      <div class="scan-line"></div>
    </div>
    <p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
    <p id="nomeDetectado" class="produtoDetectado"></p>
    <div id="progressBar" style="width:100%;height:8px;background:#ccc;border-radius:4px;margin-top:6px;">
      <div id="progress" style="width:0%;height:100%;background:#2e6bff;border-radius:4px;"></div>
    </div>
  </div>

  <div class="box">
    <h2>üì¶ Produtos cadastrados</h2>
    <button class="toggleBtn" onclick="toggleProdutos()">Mostrar / Ocultar</button>
    <div id="areaProdutosConteudo">
      <table id="produtosTable">
        <thead><tr><th>C√≥digo</th><th>Nome</th><th>Tipo</th><th>Pre√ßo</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="box" id="cadastroBox" style="display:none;">
    <h2>‚úèÔ∏è Cadastro de produto</h2>
    <label>C√≥digo</label><input id="codigo">
    <label>Nome</label><input id="nome">
    <label>Tipo</label>
    <select id="tipo"><option>Unidade (UN)</option><option>Peso (KG)</option></select>
    <label>Valor</label><input id="valor" type="number" step="0.01">
    <button onclick="salvarProduto()">Salvar</button>
  </div>
</div>

<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è</div>

<div id="modalCarrinho" class="modal">
  <div class="modal-content">
    <h2>Carrinho</h2>
    <table id="tabelaCarrinho"></table>
    <p id="total" class="total">Total: R$ 0,00</p>
    <button onclick="finalizarCompra()" class="btnStart">Finalizar compra</button>
    <button onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho = JSON.parse(localStorage.getItem("carrinho")||"[]");

let stream=null, reader=null, buffer=[], processando=false;
const beep=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

function toggleProdutos(){
  areaProdutosConteudo.style.display =
    areaProdutosConteudo.style.display==="block" ? "none" : "block";
}

function atualizarTabela(){
  const tb=document.querySelector("#produtosTable tbody");
  tb.innerHTML="";
  produtos.forEach((p,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${p.codigo}</td>
        <td>${p.nome}</td>
        <td>${p.tipo}</td>
        <td>R$ ${p.valor.toFixed(2)}</td>
        <td><button onclick="excluirProduto(${i})">‚ùå</button></td>
      </tr>`;
  });
}
atualizarTabela();

function excluirProduto(i){
  if(confirm("Excluir produto?")){
    produtos.splice(i,1);
    localStorage.setItem("produtos",JSON.stringify(produtos));
    atualizarTabela();
  }
}

function salvarProduto(){
  produtos = produtos.filter(p=>p.codigo!==codigo.value);
  const novo={codigo:codigo.value,nome:nome.value,tipo:tipo.value,valor:Number(valor.value)};
  produtos.push(novo);
  localStorage.setItem("produtos",JSON.stringify(produtos));
  atualizarTabela();

  // Pergunta quantidade e adiciona ao carrinho
  const qtd=Number(prompt(`Produto: ${novo.nome}\nQuantidade para o carrinho:`));
  if(qtd>0){
    carrinho.push({...novo,qtd});
    localStorage.setItem("carrinho",JSON.stringify(carrinho));
    atualizarCarrinho();
    abrirCarrinho();
  }

  // Limpa campos
  codigo.value=""; nome.value=""; valor.value=""; tipo.value="Unidade (UN)";
}

function abrirCarrinho(){modalCarrinho.style.display="block"; atualizarCarrinho();}
function fecharCarrinho(){modalCarrinho.style.display="none";}

function removerItem(i){
  const row=document.getElementById("row"+i);
  row.classList.add("removendo");
  setTimeout(()=>{
    carrinho.splice(i,1);
    localStorage.setItem("carrinho",JSON.stringify(carrinho));
    atualizarCarrinho();
  },300);
}

function atualizarCarrinho(){
  let soma=0;
  tabelaCarrinho.innerHTML=`<tr><th>C√≥digo</th><th>Nome</th><th>Qtd</th><th>Subtotal</th><th></th></tr>`;
  carrinho.forEach((x,i)=>{
    let sub=x.valor*x.qtd;
    soma+=sub;
    tabelaCarrinho.innerHTML+=`
      <tr id="row${i}">
        <td>${x.codigo}</td>
        <td>${x.nome}</td>
        <td>${x.qtd}</td>
        <td><span class="subtotal">R$ ${sub.toFixed(2)}</span></td>
        <td><button class="btn-trash" onclick="removerItem(${i})">üóëÔ∏è</button></td>
      </tr>`;
  });
  document.getElementById("total").innerText="Total: R$ "+soma.toFixed(2);
}

function finalizarCompra(){
  if(!carrinho.length) return alert("Carrinho vazio");
  if(confirm("Finalizar compra?")){
    carrinho=[]; localStorage.setItem("carrinho","[]");
    atualizarCarrinho(); fecharCarrinho(); alert("Compra finalizada!");
  }
}

async function iniciarScanner(){
  if(stream || processando) return;
  buffer=[]; processando=false;
  const video=document.getElementById("video");
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  await video.play();
  reader=new ZXing.BrowserMultiFormatReader();
  reader.decodeFromVideoElementContinuously(video,(res)=>{
    if(!res||processando) return;
    detected.innerText=res.text;
    const prod=produtos.find(p=>p.codigo===res.text);
    if(prod){
      nomeDetectado.innerText=prod.nome;
      const qtd=Number(prompt(`Produto: ${prod.nome}\nQuantidade:`));
      if(qtd>0){
        carrinho.push({...prod,qtd});
        localStorage.setItem("carrinho",JSON.stringify(carrinho));
        atualizarCarrinho();
        abrirCarrinho();
      }
      processando=true; pararScanner();
    } else {
      nomeDetectado.innerText="Produto n√£o cadastrado";
      document.getElementById("cadastroBox").style.display="block";
      codigo.value=res.text;
      processando=true; pararScanner();
    }
    beep.currentTime=0; beep.play();
  });
}

function pararScanner(){
  if(reader){reader.reset(); reader=null;}
  if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
  processando=false;
}

startButton.onclick=iniciarScanner;
stopButton.onclick=pararScanner;
</script>

</body>
</html>
