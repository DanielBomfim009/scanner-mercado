<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de CÃ³digo de Barras</title>

<style>
body{
  font-family: Arial;
}

/* vÃ­deo e Ã¡rea */
#area{
  position:relative;
  display:inline-block;
}

video, canvas{
  width:100%;
  max-width:480px;
  border:2px solid #444;
  border-radius:12px;
}

/* retÃ¢ngulo de leitura */
#roi{
  position:absolute;
  top:30%;
  left:10%;
  width:80%;
  height:40%;
  border:3px solid #00ff00;
  border-radius:8px;
  box-shadow:0 0 12px #00ff00 inset;
  pointer-events:none;
}

/* linha vermelha neon animada */
#laser{
  position:absolute;
  left:12%;
  width:76%;
  height:2px;
  background:red;
  box-shadow:0 0 12px red, 0 0 20px #ff0000;
  animation:scan 2.2s linear infinite;
  pointer-events:none;
}

@keyframes scan{
  0%{ top:32%; }
  50%{ top:66%; }
  100%{ top:32%; }
}
</style>
</head>

<body>

<h2>Scanner com validaÃ§Ã£o precisa</h2>

<div id="area">
  <video id="video" playsinline></video>
  <canvas id="captura" style="display:none;"></canvas>

  <div id="roi"></div>
  <div id="laser"></div>
</div>

<p id="msg" style="color:red"></p>
<p id="confirmado" style="color:green;font-weight:bold"></p>

<button onclick="iniciar()">ðŸ“· Iniciar cÃ¢mera</button>
<button onclick="continuar()">ðŸ”„ Continuar escaneando</button>
<button onclick="parar()">ðŸ›‘ Parar</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let codeReader = null;
let stream = null;
let buffer = [];
const repeticoes = 3;
let congelado = false;

function validarEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  let sum = 0;
  for(let i=0;i<12;i++){
    sum += parseInt(code[i]) * (i%2===0?1:3);
  }
  let check = (10 - (sum % 10)) % 10;
  return check === parseInt(code[12]);
}

async function iniciar(){
  congelado = false;
  document.getElementById("captura").style.display = "none";
  document.getElementById("video").style.display = "block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:"environment",
        width:{ ideal:1920 },
        height:{ ideal:1080 },
        focusMode:"continuous"
      }
    });

    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13]);

    codeReader = new ZXing.BrowserMultiFormatReader(hints);

    codeReader.decodeFromVideoElementContinuously(video,(resultado,err)=>{

      if(congelado) return;

      if(resultado){

        const code = resultado.text;

        if(!validarEAN13(code)){
          buffer = [];
          document.getElementById("msg").innerText =
            "âš ï¸ cÃ³digo invÃ¡lido â€” checksum reprovado";
          return;
        }

        buffer.push(code);
        if(buffer.length>repeticoes) buffer.shift();

        if(
          buffer.length===repeticoes &&
          buffer.every(v=>v===buffer[0])
        ){
          confirmar(code);
        }
      }
    });

    document.getElementById("msg").innerText =
      "Aponte o cÃ³digo dentro do retÃ¢ngulo verde";

  }catch(e){
    document.getElementById("msg").innerText =
      "Erro: "+e.message;
  }
}

function confirmar(code){

  congelado = true;

  document.getElementById("confirmado").innerText =
    "âœ” CÃ³digo confirmado: "+code;

  // congela imagem do vÃ­deo
  const video = document.getElementById("video");
  const canvas = document.getElementById("captura");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  document.getElementById("video").style.display="none";
  canvas.style.display="block";

  new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
}

function continuar(){
  buffer = [];
  congelado = false;
  document.getElementById("confirmado").innerText="";
  document.getElementById("captura").style.display="none";
  document.getElementById("video").style.display="block";
}

function parar(){
  if(codeReader) codeReader.reset();
  if(stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("msg").innerText="Scanner parado";
}
</script>

</body>
</html>
