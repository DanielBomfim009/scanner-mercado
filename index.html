<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body{
    background:#eef3ff;
    font-family: Arial;
    margin:0;
}
.container{
    max-width:900px;
    margin:auto;
    padding:12px;
}
.logo{
    text-align:center;
    margin-top:10px;
}
.logo img{
    width:160px;
    height:160px;
    object-fit:cover;
    border-radius:50%;
    border:5px solid #ffffff;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.box{
    background:white;
    border-radius:18px;
    padding:16px;
    margin-top:15px;
    box-shadow:0 0 15px #00000010;
}
button{
    width:100%;
    padding:14px;
    border:none;
    font-size:16px;
    border-radius:12px;
    margin-top:8px;
}
.btnStart{ background:#2e6bff; color:white; }
.btnStop{ background:#6b6b6b; color:white; }

#camera{
    width:100%;
    height:260px;
    background:black;
    border-radius:18px;
    margin-top:10px;
    overflow:hidden;
    position:relative;
}
#camera video{
    width:100%;
    height:100%;
    object-fit:cover;
}

/* linha vermelha neon animada */
.scan-line{
    position:absolute;
    width:100%;
    height:2px;
    background:red;
    box-shadow:0 0 8px red;
    animation:scan 2s linear infinite;
}
@keyframes scan{
    0%{ top:10%; }
    100%{ top:90%; }
}

/* lista minimiz√°vel */
#areaProdutosConteudo{
    display:none;
}
.toggleBtn{
    background:#ffb703;
    color:#000;
}
</style>
</head>

<body>

<div class="container">

    <div class="logo">
        <img src="logo.jpg">
    </div>

    <h1 style="text-align:center">üõí Compras do m√™s üõçÔ∏è</h1>

    <!-- SCANNER -->
    <div class="box">
        <button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
        <button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>

        <div id="camera">
            <video id="video" playsinline></video>
            <div id="scanLine" class="scan-line" style="display:none"></div>
        </div>

        <p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
    </div>

    <!-- lista produtos -->
    <div class="box">
        <h2>üì¶ Produtos cadastrados</h2>

        <button class="toggleBtn" onclick="toggleProdutos()">Mostrar / Ocultar</button>

        <div id="areaProdutosConteudo">
            <table id="produtosTable">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Pre√ßo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- cadastro -->
    <div class="box">
        <h2>‚úèÔ∏è Edi√ß√£o de produto</h2>

        <label>C√≥digo</label>
        <input id="codigo">

        <label>Nome</label>
        <input id="nome">

        <label>Tipo</label>
        <select id="tipo">
            <option>Unidade (UN)</option>
            <option>Peso (KG)</option>
        </select>

        <label>Valor</label>
        <input id="valor" type="number" step="0.01">

        <button onclick="salvarProduto()">Salvar</button>
    </div>

</div>

<script>
/* ---------------- DADOS ---------------- */

let produtos = JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho = [];

/* minimizar lista */
function toggleProdutos(){
    let div = document.getElementById("areaProdutosConteudo");
    div.style.display = (div.style.display==="none"||div.style.display==="") ? "block" : "none";
}

/* tabela */
function atualizarTabela(){
    const tb=document.querySelector("#produtosTable tbody");
    tb.innerHTML="";
    produtos.forEach(p=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.codigo}</td><td>${p.nome}</td><td>${p.tipo}</td><td>${p.valor}</td>`;
        tb.appendChild(tr);
    });
}
atualizarTabela();

/* salvar produto */
function salvarProduto(){

    let p={
        codigo:codigo.value,
        nome:nome.value,
        tipo:tipo.value,
        valor:Number(valor.value)
    };

    produtos = produtos.filter(x=>x.codigo!==p.codigo);
    produtos.push(p);

    localStorage.setItem("produtos",JSON.stringify(produtos));

    atualizarTabela();

    alert("Produto salvo");

    /* limpar campos */
    codigo.value="";
    nome.value="";
    valor.value="";
    tipo.selectedIndex=0;
}

/* -------------- SCANNER PRECISO --------------- */

let stream=null;
let reader=null;
let buffer=[];
const repeticoes=3;

/* valida EAN-13 real */
function validarEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  let sum = 0;
  for(let i=0;i<12;i++){
    sum += parseInt(code[i]) * (i%2===0?1:3);
  }
  let check = (10 - (sum % 10)) % 10;
  return check === parseInt(code[12]);
}

async function iniciarScanner(){

    document.getElementById("scanLine").style.display="block";

    reader = new ZXing.BrowserMultiFormatReader();

    stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"environment" }
    });

    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    reader.decodeFromVideoElementContinuously(video,(result,err)=>{

        if(!result) return;

        let code=result.text;
        detected.innerText=code;

        if(!validarEAN13(code)){
            buffer=[];
            return;
        }

        buffer.push(code);
        if(buffer.length>repeticoes) buffer.shift();

        if(buffer.length===repeticoes && buffer.every(v=>v===buffer[0])){

            /* congela imagem */
            video.pause();

            new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();

            const confirmado = code;
            buffer=[];

            codigo.value = confirmado;

            let prod = produtos.find(p=>p.codigo===confirmado);

            if(prod){

                let qtd = prompt("Produto encontrado:\n"+prod.nome+"\n\nQuantidade?");
                if(qtd){
                    carrinho.push({
                        codigo:confirmado,
                        nome:prod.nome,
                        valor:Number(prod.valor),
                        qtd:Number(qtd)
                    });
                }

            } else {
                alert("Produto n√£o cadastrado ‚Äî j√° coloquei o c√≥digo no formul√°rio.");
            }
        }
    });
}

function pararScanner(){

    document.getElementById("scanLine").style.display="none";

    if(reader) reader.reset();
    if(stream) stream.getTracks().forEach(t=>t.stop());
    buffer=[];
}

document.getElementById("startButton").onclick=iniciarScanner;
document.getElementById("stopButton").onclick=pararScanner;
</script>

</body>
</html>
