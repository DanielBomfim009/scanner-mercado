<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de Compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#eef1f5;
}
.app{
  max-width:420px;
  margin:auto;
  background:#fff;
  min-height:100vh;
  padding:15px;
}
h2{text-align:center;margin:5px 0 15px}
#camera{
  width:100%;
  height:260px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.start{background:#2ecc71;color:#fff}
.stop{background:#e74c3c;color:#fff}
.clear{background:#f39c12;color:#fff}
.reset{background:#7f8c8d;color:#fff}
.lista{
  margin-top:10px;
  font-size:14px;
}
.total{
  margin-top:15px;
  font-size:20px;
  font-weight:bold;
  text-align:center;
}
.footer{
  margin-top:15px;
  font-size:12px;
  text-align:center;
  color:#777;
}
</style>
</head>

<body>
<div class="app">
  <h2>üõí Compras do M√™s</h2>

  <div id="camera"></div>

  <button class="start" onclick="iniciarScanner()">‚ñ∂ Abrir C√¢mera</button>
  <button class="stop" onclick="pararScanner()">‚èπ Parar Scanner</button>
  <button class="clear" onclick="limparCarrinho()">üßπ Limpar Carrinho</button>
  <button class="reset" onclick="limparBanco()">üóë Apagar Produtos</button>

  <div class="lista" id="lista"></div>
  <div class="total" id="total">Total: R$ 0,00</div>

  <div class="footer">Dados salvos no seu celular</div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")) || {};
let carrinho = [];
let total = 0;
let bloqueio = false;

function iniciarScanner(){
  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector("#camera"),
      constraints:{ facingMode:"environment" }
    },
    decoder:{ readers:["ean_reader","ean_13_reader","code_128_reader"] }
  },err=>{
    if(err){ alert("Erro ao acessar c√¢mera"); return; }
    Quagga.start();
  });

  Quagga.onDetected(dado=>{
    if(bloqueio) return;
    bloqueio = true;

    const codigo = dado.codeResult.code;
    processarCodigo(codigo);

    setTimeout(()=>bloqueio=false,1800);
  });
}

function pararScanner(){ Quagga.stop(); }

function processarCodigo(codigo){
  if(produtos[codigo]){
    let qtd = prompt(`Quantidade (${produtos[codigo].unidade})`);
    if(!qtd) return;

    let subtotal = qtd * produtos[codigo].preco;
    total += subtotal;

    carrinho.push(
      `${produtos[codigo].nome} - ${qtd} ${produtos[codigo].unidade} ‚Üí R$ ${subtotal.toFixed(2)}`
    );

    atualizarTela();
  }else{
    let nome = prompt("Nome do produto:");
    if(!nome) return;

    let preco = parseFloat(prompt("Pre√ßo (ex: 10.50)"));
    if(!preco) return;

    let unidade = prompt("Unidade (UN ou KG)").toUpperCase();
    if(unidade !== "UN" && unidade !== "KG"){
      alert("Use UN ou KG");
      return;
    }

    produtos[codigo] = {nome,preco,unidade};
    localStorage.setItem("produtos",JSON.stringify(produtos));

    alert("Produto cadastrado! Escaneie novamente para adicionar.");
  }
}

function atualizarTela(){
  document.getElementById("lista").innerHTML = carrinho.join("<br>");
  document.getElementById("total").innerText =
    `Total: R$ ${total.toFixed(2)}`;
}

function limparCarrinho(){
  carrinho = [];
  total = 0;
  atualizarTela();
}

function limparBanco(){
  if(confirm("Apagar TODOS os produtos cadastrados?")){
    localStorage.removeItem("produtos");
    produtos = {};
    alert("Banco apagado");
  }
}
</script>
</body>
</html>
