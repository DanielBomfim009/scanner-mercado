<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4361ee" />
  <title>GoL BUY SMART</title>

  <!-- Bibliotecas externas (sem espa√ßos!) -->
  <script src="https://unpkg.com/@zxing/library@0.21.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    /* ===== PALETA DE CORES ===== */
    :root {
      /* Claro */
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a56d4;
      --secondary: #f72585;
      --secondary-light: #ff4da6;
      --background: #f8f9ff;
      --card: #ffffff;
      --text: #212529;
      --text-muted: #6c757d;
      --border: #e0e6f0;
      --success: #4ade80;
      --danger: #f87171;
      --radius: 20px;
      --radius-sm: 12px;
      --shadow: 0 6px 20px rgba(67, 97, 238, 0.12), 0 2px 6px rgba(0, 0, 0, 0.06);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
      --transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* ===== MODO ESCURO ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #121826;
        --card: #1e293b;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --border: #334155;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 2px 6px rgba(0, 0, 0, 0.2);
      }
    }

    /* ===== RESET E BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--background);
      font-family: 'Inter', sans-serif;
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 16px;
      line-height: 1.6;
    }

    /* ===== SPLASH SCREEN ===== */
    #splash {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #splash img {
      width: 240px;
      height: 240px;
      object-fit: contain;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,0.2));
    }
    #splash p {
      margin-top: 16px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      max-width: 80%;
    }

    /* ===== HAMBURGER ===== */
    #hamburger {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 52px;
      height: 52px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 16px;
      z-index: 101;
      font-size: 28px;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    #hamburger:hover {
      background: var(--primary-light);
      transform: rotate(90deg);
    }

    /* ===== SIDEBAR ===== */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 240px;
      background: var(--primary);
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 80px;
      transition: transform 0.3s ease;
      z-index: 100;
      box-shadow: 4px 0 12px rgba(0,0,0,0.1);
    }
    #sidebar.hide {
      transform: translateX(-100%);
    }
    #sidebar button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      width: 100%;
      transition: var(--transition);
    }
    #sidebar button:hover, #sidebar button:focus {
      background: rgba(255, 255, 255, 0.15);
      padding-left: 32px;
    }
    #sidebar button svg {
      width: 24px;
      height: 24px;
    }

    /* ===== CONTE√öDO PRINCIPAL ===== */
    #content {
      margin-left: 240px;
      flex: 1;
      padding: 24px 20px;
      transition: margin-left 0.3s ease;
    }
    #content.full {
      margin-left: 0;
    }

    /* ===== VIEWS ===== */
    .view {
      display: none;
      animation: fadeInUp 0.4s ease;
    }
    .view.active {
      display: block;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }

    /* ===== T√çTULOS ===== */
    h2 {
      font-size: 1.875rem; /* 30px */
      font-weight: 800;
      margin: 0 0 24px;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    /* ===== CARDS ===== */
    .box {
      background: var(--card);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 28px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    @media (max-width: 480px) {
      .box {
        padding: 20px 16px;
      }
    }

    /* ===== INPUTS ===== */
    label {
      display: block;
      margin: 20px 0 8px;
      font-weight: 600;
      color: var(--text);
    }
    input, select {
      width: 100%;
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 16px;
      background: var(--card);
      color: var(--text);
      transition: var(--transition);
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* ===== OR√áAMENTO ===== */
    #orcamentoBarra {
      height: 12px;
      background: #e0e6f0;
      border-radius: 6px;
      margin-top: 12px;
      overflow: hidden;
      border: 1px solid #d1d9e6;
    }
    #orcamentoBarraInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--secondary), #ff4da6);
      border-radius: 6px;
      transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
    }
    #orcamentoBarraInner::after {
      content: attr(data-pct);
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 12px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* ===== SCANNER ===== */
    #camera {
      position: relative;
      width: 100%;
      height: 280px;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 24px;
      background: #000;
      box-shadow: var(--shadow-sm);
    }
    #camera video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scan-overlay {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      border: 2px solid var(--secondary);
      border-radius: 8px;
      pointer-events: none;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
    }
    .scan-overlay::before,
    .scan-overlay::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border: 2px solid var(--secondary);
    }
    .scan-overlay::before {
      top: -2px;
      left: -2px;
      border-right: none;
      border-bottom: none;
    }
    .scan-overlay::after {
      bottom: -2px;
      right: -2px;
      border-left: none;
      border-top: none;
    }
    .scan-line {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 3px;
      background: var(--secondary);
      box-shadow: 0 0 10px var(--secondary-light);
      animation: scan 2.5s linear infinite;
    }
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }

    /* ===== TABELAS ===== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 15px;
    }
    th, td {
      padding: 14px 10px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    th {
      font-weight: 700;
      color: var(--text);
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background: rgba(67, 97, 238, 0.03);
    }
    @media (prefers-color-scheme: dark) {
      tr:nth-child(even) {
        background: rgba(67, 97, 238, 0.08);
      }
    }

    /* ===== BOT√ïES ===== */
    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    .editBtn {
      background: #e2e8f0;
      color: var(--primary);
      padding: 8px 14px;
    }
    .editBtn:hover {
      background: #cbd5e1;
      transform: translateY(-2px);
    }
    .deleteBtn {
      background: var(--danger);
      color: white;
      padding: 8px 14px;
    }
    .deleteBtn:hover {
      background: #ef4444;
      transform: translateY(-2px);
    }
    #salvarCadastro,
    #modalCarrinho button {
      background: var(--primary);
      color: white;
      padding: 14px;
      font-size: 17px;
    }
    #salvarCadastro:hover,
    #modalCarrinho button:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    /* ===== HIST√ìRICO ===== */
    .historico-card {
      background: var(--card);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }
    .historico-card h4 {
      color: var(--primary);
      margin-bottom: 8px;
      font-size: 1.25rem;
    }
    .historico-card small {
      color: var(--text-muted);
      display: block;
      margin-bottom: 10px;
    }

    /* ===== CARRINHO ===== */
    #carrinhoIcone {
      position: fixed;
      bottom: 28px;
      right: 28px;
      width: 72px;
      height: 72px;
      background: var(--secondary);
      border: none;
      border-radius: 50%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      z-index: 200;
      box-shadow: 0 6px 16px rgba(247, 37, 133, 0.4);
      transition: var(--transition);
    }
    #carrinhoIcone:hover {
      transform: scale(1.1) rotate(12deg);
      box-shadow: 0 8px 24px rgba(247, 37, 133, 0.6);
    }
    #carrinhoIcone span {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      animation: pulse 0.6s infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.15); }
    }

    /* ===== MODAL ===== */
    #modalCarrinho {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      width: 95%;
      max-width: 500px;
      margin: auto;
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    #modalCarrinho.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    #total {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 16px 0;
      color: var(--primary);
    }

    /* ===== REDUZIR ANIMA√á√ïES ===== */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <!-- Splash Screen -->
  <div id="splash" role="alert" aria-live="polite">
    <img src="logo.png" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
    <p>Bem-vindo ao seu app de compras inteligente</p>
  </div>

  <!-- Menu Hamburger -->
  <button id="hamburger" aria-label="Abrir menu">‚ò∞</button>

  <!-- Sidebar -->
  <nav id="sidebar" aria-label="Navega√ß√£o principal">
    <button onclick="irPara('home')">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      Home
    </button>
    <button onclick="irPara('scanner')">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.8 18.4L18.4 19.8 12 13.4 5.6 19.8 4.2 18.4 12 10.6z"/><path fill="currentColor" d="M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/></svg>
      Scanner
    </button>
    <button onclick="irPara('produtos')">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 6h-2.18c.08-.32.18-.62.18-1a2.996 2.996 0 0 0-2.5-3L12 5.5 8.5 2 6 2.5A3 3 0 0 0 6 8.5c0 .38.1.68.18 1H4c-1.11 0-2 .89-2 2v9c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2v-9c0-1.11-.89-2-2-2z"/></svg>
      Produtos
    </button>
    <button onclick="irPara('cadastro')">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      Cadastro
    </button>
    <button onclick="irPara('historico')">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>
      Hist√≥rico
    </button>
  </nav>

  <!-- Conte√∫do Principal -->
  <main id="content" role="main">
    <!-- Home -->
    <section id="home" class="view active" aria-labelledby="home-title">
      <img src="logo.png" class="logo-home" alt="GoL BUY SMART ‚Äì App de compras inteligente" style="width: 220px; height: 220px; margin: 0 auto 20px;" />
      <h2 id="home-title">Bem-vindo ao GoL BUY SMART</h2>

      <div id="orcamento" class="box">
        <label for="orcamentoInput">üí∞ Or√ßamento Mensal (R$)</label>
        <input type="number" id="orcamentoInput" placeholder="Ex: 500" min="0" step="0.01" />
        <div id="orcamentoBarra" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="orcamentoBarraInner" data-pct="0%"></div>
        </div>
        <p style="margin-top: 12px; color: var(--text-muted);">
          Gasto atual: <strong>R$ <span id="orcamentoGasto">0.00</span></strong>
        </p>
      </div>
    </section>

    <!-- Scanner -->
    <section id="scanner" class="view" aria-labelledby="scanner-title">
      <div class="box">
        <h2 id="scanner-title">Scanner de Produtos</h2>
        <div id="camera">
          <video id="video" playsinline muted></video>
          <div class="scan-overlay"></div>
          <div class="scan-line"></div>
        </div>
        <div id="scannerInfo">
          <p><strong>C√≥digo detectado:</strong> <span id="detected" aria-live="polite">‚Äî</span></p>
          <p><strong>Total de produtos:</strong> <span id="totalProdutos">0</span></p>
          <div id="scannerChartBox">
            <canvas id="categoriaChart" aria-label="Distribui√ß√£o de categorias"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Produtos -->
    <section id="produtos" class="view" aria-labelledby="produtos-title">
      <div class="box">
        <h2 id="produtos-title">Produtos Cadastrados</h2>
        <table id="produtosTable">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Cadastro -->
    <section id="cadastro" class "view" aria-labelledby="cadastro-title">
      <div id="cadastroBox" class="box">
        <h2 id="cadastro-title">Cadastro de Produto</h2>
        <label for="codigoCadastro">C√≥digo</label>
        <input id="codigoCadastro" placeholder="Ex: 123456" />

        <label for="nomeCadastro">Nome</label>
        <input id="nomeCadastro" placeholder="Ex: Arroz 1kg" />

        <label for="categoriaCadastro">Categoria</label>
        <select id="categoriaCadastro">
          <option value="Alimentos">Alimentos</option>
          <option value="Limpeza">Limpeza</option>
          <option value="Bebida">Bebida</option>
          <option value="Farm√°cia">Farm√°cia</option>
          <option value="Higiene">Higiene</option>
          <option value="Outros">Outros</option>
        </select>

        <label for="tipoCadastro">Tipo</label>
        <select id="tipoCadastro">
          <option>UN</option>
          <option>KG</option>
        </select>

        <label for="valorCadastro">Valor (R$)</label>
        <input id="valorCadastro" type="number" step="0.01" placeholder="Ex: 12.99" min="0" />

        <button id="salvarCadastro">Salvar Produto</button>
      </div>
    </section>

    <!-- Hist√≥rico -->
    <section id="historico" class="view" aria-labelledby="historico-title">
      <div class="box">
        <h2 id="historico-title">Hist√≥rico de Compras</h2>
        <div id="historicoConteudo"></div>
      </div>
    </section>
  </main>

  <!-- Carrinho -->
  <button id="carrinhoIcone" aria-label="Abrir carrinho" onclick="abrirCarrinho()">
    üõçÔ∏è<span id="badge">0</span>
  </button>

  <div id="modalCarrinho" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <h3 id="modal-title">Carrinho</h3>
      <table id="tabelaCarrinho">
        <thead>
          <tr><th>Nome</th><th>Qtd</th><th>Subtotal</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="total">Total: R$ 0,00</p>
      <button onclick="finalizarCompra()">Finalizar Compra</button>
      <button onclick="fecharCarrinho()" style="background:#6c757d; margin-top:10px;">Fechar</button>
    </div>
  </div>

  <script>
    // =============== UTILIT√ÅRIOS ===============
    const $ = id => document.getElementById(id);
    const Storage = {
      get: (k, f = []) => JSON.parse(localStorage.getItem(k)) || f,
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };

    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    // =============== DADOS ===============
    let produtos = Storage.get("produtos");
    let carrinho = Storage.get("carrinho");
    let historico = Storage.get("historicoCompras");
    let orcamento = parseFloat(Storage.get("orcamento")) || 0;
    let reader = null, stream = null, buffer = [], scannerAtivo = false;
    const repeticoes = 3;
    const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    let categoriaChart;

    // =============== SPLASH ===============
    window.addEventListener('load', () => {
      setTimeout(() => {
        $("splash").style.display = "none";
      }, 1800);
    });

    // =============== SIDEBAR ===============
    const sidebar = $("sidebar");
    const content = $("content");
    const hamburger = $("hamburger");
    hamburger.addEventListener('click', () => {
      sidebar.classList.toggle("hide");
      content.classList.toggle("full");
    });

    // =============== ROTEAMENTO ===============
    function irPara(tela) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      $(tela).classList.add("active");
      if (tela === "scanner") iniciarScanner();
      else pararScanner();
    }

    // =============== OR√áAMENTO ===============
    $("orcamentoInput").value = orcamento || '';
    $("orcamentoInput").addEventListener("input", () => {
      orcamento = parseFloat($("orcamentoInput").value) || 0;
      Storage.set("orcamento", orcamento);
      atualizarOrcamento();
    });

    function atualizarOrcamento() {
      const gasto = carrinho.reduce((a, b) => a + (b.valor * (b.qtd || 1)), 0);
      $("orcamentoGasto").textContent = gasto.toFixed(2);
      const pct = orcamento ? Math.min(100, (gasto / orcamento) * 100) : 0;
      const bar = $("orcamentoBarraInner");
      bar.style.width = pct + "%";
      bar.setAttribute('data-pct', Math.round(pct) + '%');
      $("orcamentoBarra").setAttribute("aria-valuenow", Math.round(pct));
    }

    // =============== PRODUTOS ===============
    function atualizarProdutosTable() {
      const tbody = $("produtosTable").querySelector("tbody");
      tbody.innerHTML = "";
      produtos.forEach((p, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(p.codigo)}</td>
          <td>${escapeHtml(p.nome)}</td>
          <td>${escapeHtml(p.categoria)}</td>
          <td>${escapeHtml(p.tipo)}</td>
          <td>R$ ${p.valor.toFixed(2)}</td>
          <td>
            <button class="editBtn" onclick="editarProduto(${i})" aria-label="Editar ${p.nome}">‚úèÔ∏è</button>
            <button class="deleteBtn" onclick="excluirProduto(${i})" aria-label="Excluir ${p.nome}">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(row);
      });
      $("totalProdutos").textContent = produtos.length;
    }

    function editarProduto(i) {
      irPara("cadastro");
      const p = produtos[i];
      $("codigoCadastro").value = p.codigo;
      $("nomeCadastro").value = p.nome;
      $("categoriaCadastro").value = p.categoria;
      $("tipoCadastro").value = p.tipo;
      $("valorCadastro").value = p.valor;
      produtos.splice(i, 1);
      Storage.set("produtos", produtos);
    }

    function excluirProduto(i) {
      if (confirm("Tem certeza que deseja excluir este produto?")) {
        produtos.splice(i, 1);
        Storage.set("produtos", produtos);
        atualizarProdutosTable();
        atualizarScannerChart();
      }
    }

    $("salvarCadastro").addEventListener('click', () => {
      const novo = {
        codigo: $("codigoCadastro").value.trim(),
        nome: $("nomeCadastro").value.trim(),
        categoria: $("categoriaCadastro").value,
        tipo: $("tipoCadastro").value,
        valor: parseFloat($("valorCadastro").value)
      };
      if (!novo.codigo || !novo.nome || !novo.valor || isNaN(novo.valor) || novo.valor <= 0) {
        alert("Preencha todos os campos corretamente.");
        return;
      }
      produtos.push(novo);
      Storage.set("produtos", produtos);
      atualizarProdutosTable();
      atualizarScannerChart();
      irPara("produtos");
    });

    // =============== CARRINHO ===============
    function atualizarCarrinho() {
      const tbody = $("tabelaCarrinho").querySelector("tbody");
      tbody.innerHTML = "";
      let total = 0;
      carrinho.forEach(p => {
        const qtd = p.qtd || 1;
        const sub = p.valor * qtd;
        total += sub;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(p.nome)}</td>
          <td>${qtd}</td>
          <td>R$ ${sub.toFixed(2)}</td>`;
        tbody.appendChild(row);
      });
      $("total").textContent = "Total: R$ " + total.toFixed(2);
      $("badge").textContent = carrinho.length;
      atualizarOrcamento();
    }

    function abrirCarrinho() {
      $("modalCarrinho").style.display = "flex";
      setTimeout(() => $("modalCarrinho").classList.add("active"), 10);
      atualizarCarrinho();
    }

    function fecharCarrinho() {
      $("modalCarrinho").classList.remove("active");
      setTimeout(() => $("modalCarrinho").style.display = "none", 300);
    }

    function finalizarCompra() {
      if (!carrinho.length) {
        alert("Carrinho vazio");
        return;
      }
      const total = carrinho.reduce((a, b) => a + b.valor * (b.qtd || 1), 0);
      historico.push({
        data: new Date().toLocaleString("pt-BR"),
        total,
        itens: [...carrinho]
      });
      Storage.set("historicoCompras", historico);
      carrinho = [];
      Storage.set("carrinho", carrinho);
      atualizarCarrinho();
      atualizarHistorico();
      fecharCarrinho();
      alert("‚úÖ Compra finalizada com sucesso!");
    }

    // =============== HIST√ìRICO ===============
    function atualizarHistorico() {
      const area = $("historicoConteudo");
      area.innerHTML = "";
      if (!historico.length) {
        area.innerHTML = "<p style='text-align:center; color:var(--text-muted);'>Nenhuma compra registrada.</p>";
        return;
      }
      historico.forEach((compra, idx) => {
        const card = document.createElement('div');
        card.className = 'historico-card';
        card.innerHTML = `
          <h4>Compra #${idx + 1}</h4>
          <small>${escapeHtml(compra.data)}</small>
          <p><strong>Total:</strong> R$ ${compra.total.toFixed(2)}</p>
          <details><summary style="color:var(--primary); cursor:pointer;">Ver itens</summary><ul id="itens-${idx}"></ul></details>`;
        area.appendChild(card);

        const ul = card.querySelector(`#itens-${idx}`);
        compra.itens.forEach(it => {
          const li = document.createElement('li');
          li.textContent = `${it.nome} ‚Äî ${it.qtd || 1} x R$ ${it.valor.toFixed(2)} = R$ ${(it.qtd * it.valor).toFixed(2)}`;
          ul.appendChild(li);
        });
      });
    }

    // =============== SCANNER ===============
    async function iniciarScanner() {
      if (scannerAtivo) return;
      scannerAtivo = true;
      buffer = [];
      if (!stream) {
        try {
          const constraints = { video: { facingMode: "environment" } };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          $("video").srcObject = stream;
          await $("video").play();
        } catch (err) {
          alert("‚ö†Ô∏è Permiss√£o da c√¢mera negada. O scanner n√£o funcionar√°.");
          console.error(err);
          return;
        }
      }
      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoElementContinuously($("video"), (res) => {
        if (!res || !scannerAtivo) return;
        const codigo = res.text.trim();
        buffer.push(codigo);
        if (buffer.length > repeticoes) buffer.shift();
        const count = buffer.filter(v => v === codigo).length;
        $("detected").textContent = codigo;
        if (count >= repeticoes) processarCodigo(codigo);
      });
    }

    function processarCodigo(codigo) {
      navigator.vibrate?.(100);
      scannerAtivo = false;
      beep.play().catch(() => {});
      const produto = produtos.find(x => x.codigo === codigo);
      setTimeout(() => {
        if (produto) {
          const q = prompt(`Produto: ${produto.nome}\nDigite a quantidade:`);
          const qtd = parseInt(q);
          if (qtd > 0) {
            carrinho.push({ ...produto, qtd });
            Storage.set("carrinho", carrinho);
            abrirCarrinho();
          }
        } else {
          alert("‚ùå Produto n√£o cadastrado.");
        }
        scannerAtivo = true;
        buffer = [];
        atualizarCarrinho();
      }, 400);
    }

    function pararScanner() {
      scannerAtivo = false;
      if (reader) reader.reset();
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      $("video").srcObject = null;
    }

    // =============== GR√ÅFICO ===============
    function atualizarScannerChart() {
      const ctx = $("categoriaChart");
      if (!ctx || !ctx.getContext) return;

      const categorias = {};
      produtos.forEach(p => {
        categorias[p.categoria] = (categorias[p.categoria] || 0) + 1;
      });

      if (categoriaChart) categoriaChart.destroy();

      const labels = Object.keys(categorias);
      const data = Object.values(categorias);
      const cores = [
        '#4361ee', '#f72585', '#4cc9f0', '#7209b7',
        '#3a0ca3', '#4361ee', '#f72585', '#4cc9f0'
      ];

      const chartCtx = ctx.getContext('2d');
      categoriaChart = new Chart(chartCtx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: cores,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          cutout: '70%',
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { 
                padding: 20,
                usePointStyle: true,
                font: { size: 12 }
              }
            }
          }
        }
      });
    }

    // =============== MODAL CARRINHO ===============
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $("modalCarrinho").style.display !== 'none') {
        fecharCarrinho();
      }
    });

    $("modalCarrinho").addEventListener('click', (e) => {
      if (e.target === $("modalCarrinho")) {
        fecharCarrinho();
      }
    });

    // =============== INICIALIZA√á√ÉO ===============
    atualizarHistorico();
    atualizarProdutosTable();
    atualizarCarrinho();
    atualizarScannerChart();
  </script>
</body>
</html>
