<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GoL BUY SMART</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#2f5bd3">

<script src="https://unpkg.com/@zxing/library@0.21.2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#2f5bd3;
  --secondary:#f2b705;
  --background:#f4f6fb;
  --card:#ffffff;
  --danger:#e63946;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
  --transition:.3s;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}

body{
  background:var(--background);
  display:flex;
  min-height:100vh;
}

/* Splash */
#splash{
  position:fixed;
  inset:0;
  background:#1a1a1a;
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:2000;
}
#splash img{width:220px}
#splash p{margin-top:10px}

/* Sidebar */
#sidebar{
  width:220px;
  background:var(--primary);
  color:#fff;
  position:fixed;
  inset:0 auto 0 0;
  padding-top:60px;
  transition:var(--transition);
}
#sidebar.hide{transform:translateX(-100%)}
#sidebar button{
  width:100%;
  padding:14px 20px;
  border:none;
  background:none;
  color:#fff;
  text-align:left;
  font-size:15px;
  cursor:pointer;
  border-radius:10px;
  transition:.2s;
}
#sidebar button:hover{
  background:rgba(255,255,255,.15);
  transform:translateX(4px);
}

/* Hamburger */
#hamburger{
  position:fixed;
  top:12px;left:12px;
  width:48px;height:48px;
  background:var(--primary);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  font-size:26px;
  z-index:100;
  cursor:pointer;
  box-shadow:var(--shadow);
}

/* Content */
#content{
  margin-left:220px;
  flex:1;
  padding:20px;
  transition:var(--transition);
}
#content.full{margin-left:0}

/* Views */
.view{display:none;animation:fade .3s ease}
.view.active{display:block}
@keyframes fade{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:none}
}

/* Box */
.box{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  margin-bottom:20px;
  box-shadow:var(--shadow);
}

/* Home */
#home{text-align:center}
.logo-home{width:220px;margin-bottom:10px}

/* Or√ßamento */
#orcamento input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
}
#orcamentoBarra{
  height:18px;
  background:#ddd;
  border-radius:12px;
  margin-top:10px;
  overflow:hidden;
}
#orcamentoBarraInner{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#2f5bd3,#5f84ff);
  color:#fff;
  font-size:12px;
  text-align:center;
  transition:.4s;
}

/* Scanner */
#camera{
  width:100%;
  height:260px;
  background:#000;
  border-radius:var(--radius);
  overflow:hidden;
  position:relative;
}
#camera video{
  width:100%;
  height:100%;
  object-fit:cover;
}
.scan-line{
  position:absolute;
  left:0;right:0;
  height:4px;
  background:linear-gradient(90deg,transparent,var(--secondary),transparent);
  animation:scan 2s linear infinite;
}
@keyframes scan{
  0%{top:10%}
  50%{top:90%}
  100%{top:10%}
}
#barraValidacao{
  height:18px;
  background:#e0e0e0;
  border-radius:12px;
  margin-top:12px;
  overflow:hidden;
}
#barraValidacaoInner{
  height:100%;
  width:0%;
  background:var(--primary);
  color:#fff;
  font-size:12px;
  text-align:center;
  transition:.3s;
}

/* Tabela */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:center}
tr:nth-child(even){background:#f3f3f3}

/* Carrinho */
#carrinhoIcone{
  position:fixed;
  bottom:20px;right:20px;
  width:68px;height:68px;
  background:var(--primary);
  border-radius:50%;
  color:#fff;
  font-size:26px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
#carrinhoIcone span{
  position:absolute;
  top:-5px;right:-5px;
  width:22px;height:22px;
  background:red;
  border-radius:50%;
  font-size:12px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Modal */
#modalCarrinho{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:1000;
}
.modal-content{
  background:#fff;
  width:95%;
  max-width:480px;
  margin:40px auto;
  padding:20px;
  border-radius:var(--radius);
}
.modal-content button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  margin-top:8px;
  font-weight:700;
  background:var(--primary);
  color:#fff;
}
</style>
</head>

<body>

<div id="splash">
  <img src="logo.png">
  <p>Bem-vindo ao seu app de compras inteligente</p>
</div>

<div id="hamburger">‚ò∞</div>

<div id="sidebar">
  <button onclick="irPara('home')">üè† Home</button>
  <button onclick="irPara('scanner')">üì∑ Scanner</button>
  <button onclick="irPara('produtos')">üì¶ Produtos</button>
  <button onclick="irPara('cadastro')">üìù Cadastro</button>
  <button onclick="irPara('historico')">üßæ Hist√≥rico</button>
</div>

<div id="content">

<section id="home" class="view active">
  <img src="logo.png" class="logo-home">
  <h2>Bem-vindo ao GoL BUY SMART</h2>

  <div id="orcamento" class="box">
    <h3>üí∞ Or√ßamento Mensal</h3>
    <input type="number" id="orcamentoInput">
    <div id="orcamentoBarra"><div id="orcamentoBarraInner">0%</div></div>
    <p>Gasto atual: R$ <span id="orcamentoGasto">0.00</span></p>
  </div>
</section>

<section id="scanner" class="view">
  <div class="box">
    <div id="camera">
      <video id="video" playsinline></video>
      <div class="scan-line"></div>
    </div>
    <p>C√≥digo: <span id="detected">‚Äî</span></p>
    <div id="barraValidacao"><div id="barraValidacaoInner">0%</div></div>
    <canvas id="categoriaChart"></canvas>
  </div>
</section>

<section id="produtos" class="view">
  <div class="box">
    <h2>Produtos</h2>
    <table id="produtosTable">
      <thead>
        <tr><th>C√≥digo</th><th>Nome</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="cadastro" class="view">
  <div class="box">
    <h2>Cadastro</h2>
    <input id="codigoCadastro" placeholder="C√≥digo">
    <input id="nomeCadastro" placeholder="Nome">
    <select id="categoriaCadastro">
      <option>Alimentos</option>
      <option>Limpeza</option>
      <option>Bebida</option>
      <option>Farm√°cia</option>
      <option>Higiene</option>
      <option>Outros</option>
    </select>
    <select id="tipoCadastro">
      <option>UN</option>
      <option>KG</option>
    </select>
    <input id="valorCadastro" type="number" step="0.01" placeholder="Valor">
    <button id="salvarCadastro">Salvar</button>
  </div>
</section>

<section id="historico" class="view">
  <div class="box" id="historicoConteudo"></div>
</section>

</div>

<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è<span id="badge">0</span></div>

<div id="modalCarrinho">
  <div class="modal-content">
    <h3>Carrinho</h3>
    <table id="tabelaCarrinho"></table>
    <p id="total"></p>
    <button onclick="finalizarCompra()">Finalizar</button>
    <button onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const Storage={get:(k,f=[])=>JSON.parse(localStorage.getItem(k))||f,set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

let produtos=Storage.get("produtos");
let carrinho=Storage.get("carrinho");
let historico=Storage.get("historicoCompras");
let orcamento=Number(localStorage.getItem("orcamento"))||0;

let reader=null,stream=null,buffer=[],scannerAtivo=false;
const repeticoes=3;
let chart;

window.onload=()=>setTimeout(()=>$("splash").style.display="none",1200);

$("hamburger").onclick=()=>{
  $("sidebar").classList.toggle("hide");
  $("content").classList.toggle("full");
};

function irPara(t){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  $(t).classList.add("active");
  t==="scanner"?iniciarScanner():pararScanner();
}

/* Or√ßamento */
$("orcamentoInput").value=orcamento;
$("orcamentoInput").oninput=()=>{
  orcamento=Number($("orcamentoInput").value);
  localStorage.setItem("orcamento",orcamento);
  atualizarOrcamento();
};

function atualizarOrcamento(){
  let gasto=carrinho.reduce((a,b)=>a+b.valor*b.qtd,0);
  $("orcamentoGasto").innerText=gasto.toFixed(2);
  let pct=orcamento?Math.min(100,gasto/orcamento*100):0;
  $("orcamentoBarraInner").style.width=pct+"%";
  $("orcamentoBarraInner").innerText=Math.round(pct)+"%";
}

/* Cadastro */
function atualizarProdutos(){
  const tb=$("produtosTable").querySelector("tbody");
  tb.innerHTML="";
  produtos.forEach((p,i)=>{
    tb.innerHTML+=`<tr>
      <td>${p.codigo}</td><td>${p.nome}</td><td>${p.categoria}</td>
      <td>${p.tipo}</td><td>R$ ${p.valor.toFixed(2)}</td>
      <td><button onclick="excluirProduto(${i})">‚ùå</button></td>
    </tr>`;
  });
}

$("salvarCadastro").onclick=()=>{
  let v=Number($("valorCadastro").value);
  if(v<=0||isNaN(v)) return alert("Valor inv√°lido");
  produtos.push({
    codigo:$("codigoCadastro").value,
    nome:$("nomeCadastro").value,
    categoria:$("categoriaCadastro").value,
    tipo:$("tipoCadastro").value,
    valor:v
  });
  Storage.set("produtos",produtos);
  atualizarProdutos();
  atualizarGrafico();
  irPara("produtos");
};

function excluirProduto(i){
  if(confirm("Excluir?")){
    produtos.splice(i,1);
    Storage.set("produtos",produtos);
    atualizarProdutos();
    atualizarGrafico();
  }
}

/* Carrinho */
function abrirCarrinho(){
  $("modalCarrinho").style.display="block";
  atualizarCarrinho();
}
function fecharCarrinho(){
  $("modalCarrinho").style.display="none";
}
function atualizarCarrinho(){
  let total=0;
  $("tabelaCarrinho").innerHTML="<tr><th>Nome</th><th>Qtd</th><th>Subtotal</th></tr>";
  carrinho.forEach(p=>{
    let sub=p.valor*p.qtd;
    total+=sub;
    $("tabelaCarrinho").innerHTML+=`<tr><td>${p.nome}</td><td>${p.qtd}</td><td>R$ ${sub.toFixed(2)}</td></tr>`;
  });
  $("total").innerText="Total: R$ "+total.toFixed(2);
  $("badge").innerText=carrinho.length;
  atualizarOrcamento();
}
function finalizarCompra(){
  if(!carrinho.length) return;
  historico.push({data:new Date().toLocaleString("pt-BR"),total:carrinho.reduce((a,b)=>a+b.valor*b.qtd,0),itens:[...carrinho]});
  Storage.set("historicoCompras",historico);
  carrinho=[];Storage.set("carrinho",carrinho);
  fecharCarrinho();
  atualizarHistorico();
}

/* Hist√≥rico */
function atualizarHistorico(){
  const a=$("historicoConteudo");
  a.innerHTML="";
  historico.forEach((c,i)=>{
    a.innerHTML+=`<p>Compra ${i+1} - R$ ${c.total.toFixed(2)}</p>`;
  });
}

/* Scanner */
async function iniciarScanner(){
  if(scannerAtivo) return;
  scannerAtivo=true;
  buffer=[];
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  $("video").srcObject=stream;
  await $("video").play();
  reader=new ZXing.BrowserMultiFormatReader();
  reader.decodeFromVideoElementContinuously($("video"),res=>{
    if(!res) return;
    buffer.push(res.text);
    if(buffer.length>repeticoes) buffer.shift();
    let ok=buffer.filter(v=>v===res.text).length;
    $("barraValidacaoInner").style.width=(ok/repeticoes*100)+"%";
    if(ok>=repeticoes) adicionarProduto(res.text);
  });
}

function adicionarProduto(codigo){
  scannerAtivo=false;
  let p=produtos.find(x=>x.codigo===codigo);
  if(p){
    let q=Number(prompt("Quantidade:"));
    if(q>0){
      let e=carrinho.find(i=>i.codigo===p.codigo);
      e?e.qtd+=q:carrinho.push({...p,qtd:q});
      Storage.set("carrinho",carrinho);
      abrirCarrinho();
    }
  }else alert("Produto n√£o cadastrado");
  buffer=[];
  scannerAtivo=true;
}

function pararScanner(){
  scannerAtivo=false;
  if(reader){reader.reset();reader=null;}
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  $("video").srcObject=null;
}

/* Gr√°fico */
function atualizarGrafico(){
  const c={};
  produtos.forEach(p=>c[p.categoria]=(c[p.categoria]||0)+1);
  if(chart) chart.destroy();
  chart=new Chart($("categoriaChart"),{
    type:"doughnut",
    data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:Object.keys(c).map((_,i)=>`hsl(${i*60},70%,60%)`)}]}
  });
}

atualizarProdutos();
atualizarCarrinho();
atualizarHistorico();
atualizarGrafico();
</script>
</body>
</html>
