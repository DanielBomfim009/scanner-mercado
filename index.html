<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de Código de Barras</title>
<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

let codeReader;
let videoElement;
let lastCodes = [];
let requiredMatches = 3;

function startScanner() {
    videoElement = document.getElementById("preview");
    codeReader = new BrowserMultiFormatReader();

    codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
        if (result) {
            const code = result.text;

            // salva leitura
            lastCodes.push(code);

            // mantém apenas últimas 3
            if (lastCodes.length > requiredMatches) {
                lastCodes.shift();
            }

            document.getElementById("status").innerText =
                "Lido: " + lastCodes.join(" | ");

            // verifica se as 3 últimas são iguais
            if (
                lastCodes.length === requiredMatches &&
                lastCodes.every(v => v === lastCodes[0])
            ) {
                document.getElementById("confirmado").innerText =
                    "✔ Código confirmado: " + code;

                // limpa para próxima leitura
                lastCodes = [];
            }
        }
    });
}

function stopScanner() {
    if (codeReader) {
        codeReader.reset();
        document.getElementById("status").innerText = "Scanner parado";
    }
}

window.onload = startScanner;
</script>
</head>

<body>

<h2>Scanner com validação tripla</h2>

<video id="preview" width="100%" style="max-width: 400px;"></video>

<p id="status">Iniciando câmera…</p>
<h3 id="confirmado" style="color: green;"></h3>

<button onclick="startScanner()">Iniciar</button>
<button onclick="stopScanner()">Parar</button>

</body>
</html>
