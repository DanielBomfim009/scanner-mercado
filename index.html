<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Compras do mÃªs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- QuaggaJS (scanner) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>

body{
  font-family: Arial;
  background:#f3f6ff;
  margin:0;
}

.container{
  max-width:900px;
  margin:auto;
  padding:16px;
}

.card{
  background:white;
  padding:16px;
  border-radius:16px;
  box-shadow:0 5px 16px rgba(0,0,0,.08);
  margin-top:14px;
}

h2{
  margin-top:0;
}

.logo{
  width:140px;
  height:140px;
  border-radius:50%;
  object-fit:cover;
  border:5px solid #2f7bff;
  display:block;
  margin:18px auto;
}

button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  color:white;
  font-size:16px;
  cursor:pointer;
}

.primary{
  background:#2165ff;
}

.stop{
  background:#707b87;
}

/* scanner video */
#scanner{
  width:100%;
  max-height:260px;
  border-radius:14px;
  object-fit:cover;
  background:black;
}

/* tabela */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  text-align:left;
}

/* inputs */
input,select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:15px;
}

.save{
  background:#10b164;
}
</style>
</head>

<body>

<div class="container">

<img src="logo.jpg" class="logo">

<h2>ğŸ›’ Compras do mÃªs</h2>

<div class="card">

<button class="primary" onclick="iniciarScanner()">ğŸ“· Abrir cÃ¢mera</button>
<br><br>
<button class="stop" onclick="pararScanner()">â¹ï¸ Parar</button>

<video id="scanner"></video>

<p><b>CÃ³digo detectado:</b> <span id="codigoDetectado">â€”</span></p>

</div>

<div class="card">
<h3>ğŸ“¦ Produtos cadastrados</h3>

<table border="1">
<thead>
<tr>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Tipo</th>
<th>PreÃ§o</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="listaProdutos"></tbody>
</table>
</div>

<div class="card">

<h3>âœï¸ EdiÃ§Ã£o de produto</h3>

<input id="editCodigo" placeholder="CÃ³digo" readonly>

<br><br>
<input id="editNome" placeholder="Nome">

<br><br>
<select id="editTipo">
<option value="UN">Unidade (UN)</option>
<option value="KG">Quilo (KG)</option>
</select>

<br><br>
<input id="editPreco" placeholder="PreÃ§o">

<br><br>
<button class="save" onclick="salvarEdicao()">ğŸ’¾ Salvar alteraÃ§Ãµes</button>

</div>

</div>

<script>

let scanning = false;

/* ------------------ LOCALSTORAGE ------------------ */

function getProdutos(){
  return JSON.parse(localStorage.getItem("produtos")||"[]");
}

function salvarProdutos(lista){
  localStorage.setItem("produtos",JSON.stringify(lista));
  renderTabela();
}

function renderTabela(){
  let tbody = document.getElementById("listaProdutos");
  tbody.innerHTML="";
  getProdutos().forEach(p=>{
    tbody.innerHTML+=`
      <tr>
        <td>${p.codigo}</td>
        <td>${p.nome}</td>
        <td>${p.tipo}</td>
        <td>${p.preco}</td>
        <td>
          <button onclick="editar('${p.codigo}')">âœï¸</button>
          <button onclick="excluir('${p.codigo}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
  });
}

/* ------------------ SCANNER ------------------ */

function iniciarScanner(){

  if(scanning) return;

  scanning=true;

  Quagga.init({
    inputStream:{
      name:"Live",
      type:"LiveStream",
      target:document.querySelector('#scanner')
    },
    decoder:{
      readers:["ean_reader","ean_13_reader","ean_8_reader","code_128_reader"]
    }
  },function(err){
    if(err){alert("Erro cÃ¢mera");return;}
    Quagga.start();
  });

  Quagga.onDetected(function(data){
    let code = data.codeResult.code;

    document.getElementById("codigoDetectado").innerText=code;

    // preenche automaticamente no formulÃ¡rio
    document.getElementById("editCodigo").value=code;

    let lista=getProdutos();
    let p = lista.find(x=>x.codigo==code);

    if(p){
      document.getElementById("editNome").value=p.nome;
      document.getElementById("editTipo").value=p.tipo;
      document.getElementById("editPreco").value=p.preco;
    }
  });
}

function pararScanner(){
  if(!scanning) return;
  Quagga.stop();
  scanning=false;
}

/* ------------------ CRUD ------------------ */

function editar(codigo){
  let p=getProdutos().find(x=>x.codigo==codigo);
  if(!p)return;

  document.getElementById("editCodigo").value=p.codigo;
  document.getElementById("editNome").value=p.nome;
  document.getElementById("editTipo").value=p.tipo;
  document.getElementById("editPreco").value=p.preco;
}

function excluir(codigo){
  let nova=getProdutos().filter(x=>x.codigo!=codigo);
  salvarProdutos(nova);
}

function salvarEdicao(){

  let codigo=document.getElementById("editCodigo").value;
  let nome=document.getElementById("editNome").value;
  let tipo=document.getElementById("editTipo").value;
  let preco=document.getElementById("editPreco").value;

  if(!codigo){alert("CÃ³digo nÃ£o preenchido");return;}

  let lista=getProdutos();

  let idx=lista.findIndex(x=>x.codigo==codigo);

  if(idx==-1){
    lista.push({codigo,nome,tipo,preco});
  }else{
    lista[idx]={codigo,nome,tipo,preco};
  }

  salvarProdutos(lista);
  alert("Salvo com sucesso!");
}

renderTabela();

</script>

</body>
</html>
