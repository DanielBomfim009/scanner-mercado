<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner EAN-13 com valida√ß√£o</title>

<script type="module">
import {
  BrowserMultiFormatReader,
  BarcodeFormat,
  DecodeHintType
} from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

let reader = null;
let scanning = false;
let lastCodes = [];
const requiredMatches = 3;

function isValidEAN13(code) {
    if (!/^[0-9]{13}$/.test(code)) return false;

    let sum = 0;
    for (let i = 0; i < 12; i++) {
        sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
    }
    let check = (10 - (sum % 10)) % 10;
    return check === parseInt(code[12]);
}

async function startScanner() {
    if (scanning) return;

    const video = document.getElementById("preview");
    document.getElementById("status").innerText = "Solicitando permiss√£o da c√¢mera...";

    try {
        // abre a c√¢mera primeiro (necess√°rio no Android)
        await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });

        const hints = new Map();
        hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.EAN_13]);

        reader = new BrowserMultiFormatReader(hints);

        reader.decodeFromVideoDevice(null, video, (result, err) => {
            if (result) {
                const code = result.text;
                document.getElementById("lido").innerText = "Lido: " + code;

                if (!isValidEAN13(code)) {
                    document.getElementById("status").innerText =
                      "‚ö†Ô∏è C√≥digo rejeitado (checksum inv√°lido)";
                    lastCodes = [];
                    return;
                }

                lastCodes.push(code);
                if (lastCodes.length > requiredMatches) lastCodes.shift();

                document.getElementById("status").innerText =
                    "Confirmando: " + lastCodes.join(" | ");

                if (
                    lastCodes.length === requiredMatches &&
                    lastCodes.every(v => v === lastCodes[0])
                ) {
                    document.getElementById("confirmado").innerText =
                        "‚úî C√≥digo confirmado: " + code;

                    lastCodes = [];

                    // beep
                    const beep = new Audio(
                      "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
                    );
                    beep.play();
                }
            }
        });

        scanning = true;
        document.getElementById("status").innerText = "üì∑ C√¢mera ligada, aponte para o c√≥digo de barras";

    } catch (e) {
        document.getElementById("status").innerText =
          "‚ùå Erro ao abrir c√¢mera: " + e.message;
    }
}

function stopScanner() {
    if (reader) {
        reader.reset();
        reader = null;
    }
    scanning = false;
    lastCodes = [];
    document.getElementById("status").innerText = "Scanner parado";
}
</script>

</head>

<body>

<h2>Scanner com valida√ß√£o tripla EAN-13</h2>

<video id="preview" width="100%" style="max-width:400px;"></video>

<p id="lido"></p>
<p id="status"></p>
<h3 id="confirmado" style="color:green;"></h3>

<button onclick="startScanner()">üì∑ Iniciar c√¢mera</button>
<button onclick="stopScanner()">üõë Parar</button>

</body>
</html>
