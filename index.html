<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner simples compatÃ­vel</title>

<style>
video{
  width:100%;
  max-width:420px;
  border:2px solid #444;
  border-radius:8px;
}
</style>

</head>
<body>

<h2>Scanner com validaÃ§Ã£o tripla</h2>

<video id="video" playsinline></video>

<p id="msg" style="color:red"></p>
<p id="lido"></p>
<p id="confirmado" style="color:green;font-weight:bold"></p>

<button onclick="iniciar()">ğŸ“· Iniciar cÃ¢mera</button>
<button onclick="parar()">ğŸ›‘ Parar</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let codeReader = null;
let stream = null;
let buffer = [];
const repeticoes = 3;

function validarEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  let sum = 0;
  for(let i=0;i<12;i++){
    sum += parseInt(code[i]) * (i%2===0?1:3);
  }
  let check = (10 - (sum % 10)) % 10;
  return check === parseInt(code[12]);
}

async function iniciar(){
  document.getElementById("msg").innerText = "Solicitando cÃ¢mera...";

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });

    document.getElementById("video").srcObject = stream;
    document.getElementById("video").play();

    codeReader = new ZXing.BrowserMultiFormatReader();

    codeReader.decodeFromVideoDevice(null, "video", (resultado, err)=>{
      if(resultado){
        const code = resultado.text;
        document.getElementById("lido").innerText = "Lido: " + code;

        if(!validarEAN13(code)){
          document.getElementById("msg").innerText = "âš ï¸ CÃ³digo rejeitado (checksum invÃ¡lido)";
          buffer = [];
          return;
        }

        buffer.push(code);
        if(buffer.length > repeticoes) buffer.shift();

        if(
          buffer.length === repeticoes &&
          buffer.every(v => v === buffer[0])
        ){
          document.getElementById("confirmado").innerText =
            "âœ” Confirmado: " + code;

          buffer = [];

          // beep
          new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
        }
      }
    });

    document.getElementById("msg").innerText = "CÃ¢mera iniciada âœ”";

  }catch(e){
    document.getElementById("msg").innerText =
      "âŒ ERRO: " + e.name + " â€” " + e.message;
  }
}

function parar(){
  if(codeReader){
    codeReader.reset();
  }
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  document.getElementById("msg").innerText = "Scanner parado";
}
</script>

</body>
</html>
