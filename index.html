<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de Compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#eef1f5;
}
.app{
  max-width:420px;
  margin:auto;
  background:#fff;
  min-height:100vh;
  padding:15px;
}
h2{text-align:center;margin:5px 0 10px}

#camera{
  width:100%;
  height:260px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

/* N√ÉO mexa nesses elementos */
#camera video,
#camera canvas{
  width:100% !important;
  height:100% !important;
  object-fit:cover;
}

button{
  width:100%;
  padding:12px;
  margin-top:8px;
  font-size:16px;
  border:none;
  border-radius:8px;
}
.start{background:#2ecc71;color:#fff}
.stop{background:#e74c3c;color:#fff}
.manage{background:#3498db;color:#fff}

.lista,.produtos{
  margin-top:10px;
  font-size:14px;
}
.item{
  background:#f2f2f2;
  padding:8px;
  border-radius:6px;
  margin-bottom:6px;
}
.total{
  margin-top:15px;
  font-size:20px;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>
<div class="app">
  <h2>üõí Compras do M√™s</h2>

  <div id="camera"></div>

  <button class="start" onclick="iniciarScanner()">‚ñ∂ Abrir C√¢mera</button>
  <button class="stop" onclick="pararScanner()">‚èπ Parar Scanner</button>
  <button class="manage" onclick="mostrarProdutos()">üì¶ Gerenciar Produtos</button>

  <div class="lista" id="lista"></div>
  <div class="total" id="total">Total: R$ 0,00</div>
  <div class="produtos" id="produtos"></div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")) || {};
let carrinho = [];
let total = 0;
let bloqueio = false;

function iniciarScanner(){
  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector("#camera"),
      constraints:{
        facingMode:"environment"
      }
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_13_reader",
        "code_128_reader"
      ]
    }
  },err=>{
    if(err){
      alert("Erro ao abrir c√¢mera");
      return;
    }
    Quagga.start();
  });

  Quagga.offDetected();
  Quagga.onDetected(data=>{
    if(bloqueio) return;
    bloqueio = true;

    processarCodigo(data.codeResult.code);

    setTimeout(()=>bloqueio=false,2000);
  });
}

function pararScanner(){
  Quagga.stop();
}

function processarCodigo(codigo){
  if(produtos[codigo]){
    let qtd = prompt(`Quantidade (${produtos[codigo].unidade})`);
    if(!qtd) return;

    let subtotal = qtd * produtos[codigo].preco;
    total += subtotal;

    carrinho.push(
      `${produtos[codigo].nome} - ${qtd} ${produtos[codigo].unidade} ‚Üí R$ ${subtotal.toFixed(2)}`
    );
    atualizarTela();
  }else{
    let nome = prompt("Nome do produto:");
    if(!nome) return;

    let preco = parseFloat(prompt("Pre√ßo"));
    if(!preco) return;

    let unidade = prompt("UN ou KG").toUpperCase();
    if(unidade !== "UN" && unidade !== "KG"){
      alert("Use UN ou KG");
      return;
    }

    produtos[codigo] = {nome,preco,unidade};
    localStorage.setItem("produtos",JSON.stringify(produtos));

    alert("Produto cadastrado! Escaneie novamente.");
  }
}

function atualizarTela(){
  document.getElementById("lista").innerHTML = carrinho.join("<br>");
  document.getElementById("total").innerText =
    `Total: R$ ${total.toFixed(2)}`;
}

function mostrarProdutos(){
  let html = "<h3>üì¶ Produtos Cadastrados</h3>";
  for(let c in produtos){
    let p = produtos[c];
    html += `
      <div class="item">
        <b>${p.nome}</b><br>
        C√≥digo: ${c}<br>
        R$ ${p.preco} | ${p.unidade}<br>
        <button onclick="editarProduto('${c}')">‚úèÔ∏è Editar</button>
        <button onclick="excluirProduto('${c}')">üóë Excluir</button>
      </div>`;
  }
  document.getElementById("produtos").innerHTML = html;
}

function editarProduto(c){
  let p = produtos[c];
  let nome = prompt("Nome:", p.nome);
  let preco = parseFloat(prompt("Pre√ßo:", p.preco));
  let unidade = prompt("UN ou KG:", p.unidade).toUpperCase();
  if(!nome || !preco || !['UN','KG'].includes(unidade)) return;

  produtos[c] = {nome,preco,unidade};
  localStorage.setItem("produtos",JSON.stringify(produtos));
  mostrarProdutos();
}

function excluirProduto(c){
  if(confirm("Excluir produto?")){
    delete produtos[c];
    localStorage.setItem("produtos",JSON.stringify(produtos));
    mostrarProdutos();
  }
}
</script>
</body>
</html>
