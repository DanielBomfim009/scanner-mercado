<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>GoL BUY SMART</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#3b7ddd" />

  <!-- Bibliotecas externas (ESPA√áOS REMOVIDOS!) -->
  <script src="https://unpkg.com/@zxing/library@0.21.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #3b7ddd;
      --secondary: #ffb703;
      --background: #eef3ff;
      --card: #fff;
      --danger: #ff3b3b;
      --sidebar-width: 220px;
      --transition-speed: 0.3s;
      --font-base: 16px;
      --radius: 18px;
      --shadow: 0 4px 18px rgba(0, 0, 0, 0.15);
    }

    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background: url('https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPOSITORIO/main/fungo.png') no-repeat center top;
      background-size: cover;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: var(--font-base);
    }

    /* Splash Screen */
    #splash {
      position: fixed;
      inset: 0;
      background: #1a1a1a;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #splash img {
      width: 300px;
      height: 300px;
      object-fit: contain;
    }
    #splash p {
      margin-top: 15px;
      font-size: 18px;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--primary);
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 60px;
      transition: transform var(--transition-speed);
      z-index: 100;
    }
    #sidebar.hide {
      transform: translateX(-100%);
    }
    #sidebar button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 14px 20px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border-radius: 8px;
    }
    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Hamburger */
    #hamburger {
      position: fixed;
      top: 12px;
      left: 12px;
      width: 50px;
      height: 50px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      z-index: 101;
      cursor: pointer;
      font-size: 28px;
      box-shadow: var(--shadow);
    }

    /* Content */
    #content {
      margin-left: var(--sidebar-width);
      flex: 1;
      padding: 20px 10px;
      transition: margin-left var(--transition-speed);
    }
    #content.full {
      margin-left: 0;
    }

    /* Views */
    .view {
      display: none;
      animation: fade 0.3s ease;
    }
    .view.active {
      display: block;
    }
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }

    /* Home */
    #home {
      text-align: center;
      padding-top: 20px;
    }
    #home .logo-home {
      width: 300px;
      height: 300px;
      object-fit: contain;
      margin: 0 auto 10px;
    }
    #home h2 {
      margin: 10px 0;
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
    }

    #orcamento {
      position: relative;
      max-width: 400px;
      margin: 20px auto;
    }
    #orcamento h3 {
      margin-bottom: 8px;
    }
    #orcamento input {
      width: 100%;
      padding: 12px 12px 12px 50px;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #orcamento::before {
      content: 'R$';
      position: absolute;
      left: 15px;
      top: 38px;
      color: #555;
      font-weight: bold;
    }

    #orcamentoBarra {
      height: 22px;
      background: #ccc;
      border-radius: 12px;
      margin-top: 8px;
      overflow: hidden;
    }
    #orcamentoBarraInner {
      height: 100%;
      width: 0%;
      background: var(--secondary);
      text-align: center;
      color: white;
      font-weight: bold;
      transition: width 0.5s;
    }

    /* Box */
    .box {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    /* Scanner */
    #scannerInfo {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    #camera {
      width: 100%;
      height: 250px;
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow);
    }
    #camera video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius);
    }
    .scan-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--secondary);
      animation: scan 2s linear infinite;
    }
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }

    /* Produtos */
    #produtosBox {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 16px;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    tr:nth-child(even) {
      background: #f3f3f3;
    }
    button.editBtn {
      background: var(--secondary);
      color: #000;
      margin-right: 5px;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    button.deleteBtn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Hist√≥rico */
    .historico-card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }
    .historico-card h4 {
      margin-bottom: 6px;
      color: var(--primary);
    }
    .historico-card details {
      margin-top: 6px;
    }
    .historico-card details ul {
      padding-left: 20px;
      margin: 0;
      max-height: 150px;
      overflow-y: auto;
    }

    /* Carrinho */
    #carrinhoIcone {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 70px;
      height: 70px;
      background: var(--primary);
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      z-index: 200;
    }
    #carrinhoIcone span {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 22px;
      height: 22px;
      background: red;
      color: #fff;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #modalCarrinho {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 1000;
    }
    #modalCarrinho .modal-content {
      background: #fff;
      width: 95%;
      max-width: 480px;
      margin: 40px auto;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    #modalCarrinho table {
      width: 100%;
      margin-bottom: 12px;
    }
    #modalCarrinho button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border: none;
      border-radius: 12px;
      color: white;
      background: var(--primary);
      cursor: pointer;
      font-weight: 700;
    }

    /* Cadastro */
    #cadastroBox {
      max-width: 400px;
      margin: 20px auto;
    }
    #cadastroBox input,
    #cadastroBox select,
    #cadastroBox button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #cadastroBox button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 700;
    }

    /* Gr√°fico scanner */
    #scannerChartBox {
      margin-top: 20px;
    }
    #barraValidacao {
      height: 22px;
      background: #ccc;
      border-radius: 12px;
      margin-top: 8px;
      overflow: hidden;
    }
    #barraValidacaoInner {
      height: 100%;
      width: 0%;
      background: var(--secondary);
      text-align: center;
      color: white;
      font-weight: bold;
      transition: width 0.5s;
    }
  </style>
</head>

<body>
  <!-- Splash Screen -->
  <div id="splash">
    <img src="logo.png" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
    <p>Bem-vindo ao seu app de compras inteligente</p>
  </div>

  <!-- Menu Hamburger -->
  <div id="hamburger">‚ò∞</div>

  <!-- Sidebar -->
  <div id="sidebar">
    <button onclick="irPara('home')">üè† Home</button>
    <button onclick="irPara('scanner')">üì∑ Scanner</button>
    <button onclick="irPara('produtos')">üì¶ Produtos</button>
    <button onclick="irPara('cadastro')">üìù Cadastro</button>
    <button onclick="irPara('historico')">üßæ Hist√≥rico</button>
  </div>

  <!-- Conte√∫do Principal -->
  <div id="content">
    <!-- Home -->
    <section id="home" class="view active">
      <img src="logo.png" class="logo-home" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
      <h2>Bem-vindo ao GoL BUY SMART</h2>

      <div id="orcamento" class="box">
        <h3>üí∞ Or√ßamento Mensal</h3>
        <input type="number" id="orcamentoInput" placeholder="Digite seu or√ßamento" />
        <div id="orcamentoBarra">
          <div id="orcamentoBarraInner">0%</div>
        </div>
        <p style="margin-top: 8px;">Gasto atual: R$ <span id="orcamentoGasto">0.00</span></p>
      </div>
    </section>

    <!-- Scanner -->
    <section id="scanner" class="view">
      <div class="box">
        <div id="camera">
          <video id="video" playsinline></video>
          <div class="scan-line"></div>
        </div>
        <div id="scannerInfo">
          <p>C√≥digo detectado: <span id="detected">‚Äî</span></p>
          <p>Total produtos cadastrados: <span id="totalProdutos">0</span></p>
          <div id="scannerChartBox">
            <canvas id="categoriaChart"></canvas>
          </div>
        </div>
        <div id="barraValidacao">
          <div id="barraValidacaoInner">0%</div>
        </div>
      </div>
    </section>

    <!-- Produtos -->
    <section id="produtos" class="view">
      <div id="produtosBox" class="box">
        <h2>Produtos Cadastrados</h2>
        <table id="produtosTable">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Cadastro -->
    <section id="cadastro" class="view">
      <div id="cadastroBox" class="box">
        <h2 id="cadastro-title">Cadastro de Produto</h2>
        <input id="codigoCadastro" placeholder="C√≥digo" />
        <input id="nomeCadastro" placeholder="Nome" />
        <select id="categoriaCadastro">
          <option value="Alimentos">Alimentos</option>
          <option value="Limpeza">Limpeza</option>
          <option value="Bebida">Bebida</option>
          <option value="Farm√°cia">Farm√°cia</option>
          <option value="Higiene">Higiene</option>
          <option value="Outros">Outros</option>
        </select>
        <select id="tipoCadastro">
          <option>UN</option>
          <option>KG</option>
        </select>
        <input id="valorCadastro" type="number" step="0.01" placeholder="Valor" />
        <button id="salvarCadastro">Salvar Produto</button>
      </div>
    </section>

    <!-- Hist√≥rico -->
    <section id="historico" class="view">
      <div class="box" id="historicoConteudo"></div>
    </section>
  </div>

  <!-- Carrinho -->
  <div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è<span id="badge">0</span></div>
  <div id="modalCarrinho">
    <div class="modal-content">
      <h3>Carrinho</h3>
      <table id="tabelaCarrinho"></table>
      <p id="total">Total: R$ 0,00</p>
      <button onclick="finalizarCompra()">Finalizar</button>
      <button onclick="fecharCarrinho()">Fechar</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Utilit√°rios
    const $ = id => document.getElementById(id);
    const Storage = {
      get: (k, f = []) => JSON.parse(localStorage.getItem(k)) || f,
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };

    // Dados iniciais
    let produtos = Storage.get("produtos");
    let carrinho = Storage.get("carrinho");
    let historico = Storage.get("historicoCompras");
    let orcamento = Storage.get("orcamento") || 0;
    let reader = null, stream = null, buffer = [], scannerAtivo = false;
    const repeticoes = 3;
    const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    let categoriaChart;

    // Splash Screen
    window.onload = () => {
      setTimeout(() => {
        $("splash").style.display = "none";
      }, 1500);
    };

    // Toggle Sidebar
    const sidebar = $("sidebar");
    const content = $("content");
    const hamburger = $("hamburger");
    hamburger.onclick = () => {
      sidebar.classList.toggle("hide");
      content.classList.toggle("full");
    };

    // Roteamento
    function irPara(tela) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      $(tela).classList.add("active");
      if (tela === "scanner") iniciarScanner();
      else pararScanner();
    }

    // Or√ßamento
    $("orcamentoInput").value = orcamento;
    $("orcamentoInput").addEventListener("input", () => {
      orcamento = Number($("orcamentoInput").value);
      localStorage.setItem("orcamento", orcamento);
      atualizarOrcamento();
    });

    function atualizarOrcamento() {
      const gasto = carrinho.reduce((a, b) => a + b.valor * b.qtd, 0);
      $("orcamentoGasto").innerText = gasto.toFixed(2);
      const pct = orcamento ? Math.min(100, (gasto / orcamento) * 100) : 0;
      const bar = $("orcamentoBarraInner");
      bar.style.width = pct + "%";
      bar.innerText = Math.round(pct) + "%";
    }

    // Produtos
    function atualizarProdutosTable() {
      let html = "";
      produtos.forEach((p, i) => {
        html += `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.nome}</td>
            <td>${p.categoria}</td>
            <td>${p.tipo}</td>
            <td>R$ ${p.valor.toFixed(2)}</td>
            <td>
              <button class="editBtn" onclick="editarProduto(${i})">‚úèÔ∏è</button>
              <button class="deleteBtn" onclick="excluirProduto(${i})">‚ùå</button>
            </td>
          </tr>`;
      });
      $("produtosTable").querySelector("tbody").innerHTML = html;
      $("totalProdutos").innerText = produtos.length;
    }

    function editarProduto(i) {
      // Atualiza o t√≠tulo para "Editar Produto"
      $("cadastro-title").innerText = "Editar Produto";
      
      // Preenche os campos com os dados do produto
      $("codigoCadastro").value = produtos[i].codigo;
      $("nomeCadastro").value = produtos[i].nome;
      $("categoriaCadastro").value = produtos[i].categoria;
      $("tipoCadastro").value = produtos[i].tipo;
      $("valorCadastro").value = produtos[i].valor;
      
      // Remove o produto da lista temporariamente
      produtos.splice(i, 1);
      Storage.set("produtos", produtos);
      
      // Vai para a view de cadastro
      irPara("cadastro");
    }

    function excluirProduto(i) {
      if (confirm("Excluir produto?")) {
        produtos.splice(i, 1);
        Storage.set("produtos", produtos);
        atualizarProdutosTable();
        atualizarScannerChart();
      }
    }

    $("salvarCadastro").onclick = () => {
      const novo = {
        codigo: $("codigoCadastro").value.trim(),
        nome: $("nomeCadastro").value.trim(),
        categoria: $("categoriaCadastro").value,
        tipo: $("tipoCadastro").value,
        valor: Number($("valorCadastro").value)
      };
      if (!novo.codigo || !novo.nome || !novo.valor) {
        alert("Preencha todos os campos");
        return;
      }
      produtos.push(novo);
      Storage.set("produtos", produtos);
      atualizarProdutosTable();
      atualizarScannerChart();
      
      // Reseta o t√≠tulo e volta para produtos
      $("cadastro-title").innerText = "Cadastro de Produto";
      irPara("produtos");
    };

    // Carrinho
    function atualizarCarrinho() {
      let total = 0;
      let html = "<tr><th>Nome</th><th>Qtd</th><th>Subtotal</th></tr>";
      carrinho.forEach(p => {
        const sub = p.valor * p.qtd;
        total += sub;
        html += `<tr><td>${p.nome}</td><td>${p.qtd}</td><td>R$ ${sub.toFixed(2)}</td></tr>`;
      });
      $("tabelaCarrinho").innerHTML = html;
      $("total").innerText = "Total: R$ " + total.toFixed(2);
      $("badge").innerText = carrinho.length;
      atualizarOrcamento();
    }

    function abrirCarrinho() {
      $("modalCarrinho").style.display = "block";
      atualizarCarrinho();
    }

    function fecharCarrinho() {
      $("modalCarrinho").style.display = "none";
    }

    function finalizarCompra() {
      if (!carrinho.length) {
        alert("Carrinho vazio");
        return;
      }
      const total = carrinho.reduce((a, b) => a + b.valor * b.qtd, 0);
      historico.push({
        data: new Date().toLocaleString("pt-BR"),
        total,
        itens: [...carrinho]
      });
      Storage.set("historicoCompras", historico);
      carrinho = [];
      Storage.set("carrinho", carrinho);
      atualizarCarrinho();
      atualizarHistorico();
      fecharCarrinho();
      alert("Compra finalizada!");
    }

    // Hist√≥rico
    function atualizarHistorico() {
      const area = $("historicoConteudo");
      area.innerHTML = "";
      if (!historico.length) {
        area.innerHTML = "<p>Nenhuma compra registrada.</p>";
        return;
      }
      historico.forEach((c, i) => {
        let itens = "";
        c.itens.forEach(it => {
          itens += `<li>${it.nome} ‚Äî ${it.qtd} x R$ ${it.valor.toFixed(2)} = R$ ${(it.qtd * it.valor).toFixed(2)}</li>`;
        });
        area.innerHTML += `
          <div class="historico-card">
            <h4>Compra ${i + 1}</h4>
            <small>${c.data}</small>
            <p>Total: R$ ${c.total.toFixed(2)}</p>
            <details><summary>Ver itens</summary><ul>${itens}</ul></details>
          </div>`;
      });
    }

    // Scanner
    async function iniciarScanner() {
      if (scannerAtivo) return;
      scannerAtivo = true;
      buffer = [];
      if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        $("video").srcObject = stream;
        await $("video").play();
      }
      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoElementContinuously($("video"), (res) => {
        if (!res || !scannerAtivo) return;
        const codigo = res.text.trim();
        buffer.push(codigo);
        if (buffer.length > repeticoes) buffer.shift();
        const ok = buffer.filter(v => v === codigo).length;
        $("detected").innerText = codigo;
        $("barraValidacaoInner").style.width = (ok / repeticoes * 100) + "%";
        $("barraValidacaoInner").innerText = Math.round(ok / repeticoes * 100) + "%";
        if (ok >= repeticoes) processarCodigo(codigo);
      });
    }

    function processarCodigo(codigo) {
      try {
        navigator.vibrate?.(50);
        scannerAtivo = false;
        beep.play();
        const produto = produtos.find(x => x.codigo === codigo);
        setTimeout(() => {
          if (produto) {
            const q = Number(prompt(`Produto: ${produto.nome}\nQuantidade:`));
            if (q > 0) {
              carrinho.push({ ...produto, qtd: q });
              Storage.set("carrinho", carrinho);
              abrirCarrinho();
            }
          } else {
            alert("Produto n√£o cadastrado.");
          }
          $("barraValidacaoInner").style.width = "0%";
          scannerAtivo = true;
          buffer = [];
          atualizarCarrinho();
        }, 300);
      } catch (e) {
        console.error(e);
        scannerAtivo = true;
      }
    }

    function pararScanner() {
      scannerAtivo = false;
      if (reader) reader.reset();
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      $("video").srcObject = null;
    }

    // Gr√°fico de categorias
    function atualizarScannerChart() {
      const categorias = {};
      produtos.forEach(p => {
        categorias[p.categoria] = (categorias[p.categoria] || 0) + 1;
      });
      if (categoriaChart) categoriaChart.destroy();
      const ctx = $("categoriaChart").getContext("2d");
      categoriaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categorias),
          datasets: [{
            data: Object.values(categorias),
            backgroundColor: ['#3b7ddd', '#ffb703', '#ff3b3b', '#6b6b6b', '#4caf50', '#9c27b0']
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Fechar modal com tecla Esc e clique fora
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $("modalCarrinho").style.display === 'block') {
        fecharCarrinho();
      }
    });

    $("modalCarrinho").addEventListener('click', (e) => {
      if (e.target === $("modalCarrinho")) {
        fecharCarrinho();
      }
    });

    // Inicializa√ß√£o
    atualizarHistorico();
    atualizarProdutosTable();
    atualizarCarrinho();
    atualizarScannerChart();
  </script>
</body>
</html>
