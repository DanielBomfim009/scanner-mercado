<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema com Scanner</title>

<!-- seus estilos normais podem ficar aqui -->
<link rel="stylesheet" href="styles.css">

<style>
/* área do scanner */
#camera-area{
    width: 100%;
    max-width: 420px;
    margin: 10px auto;
}
#interactive video{
    width: 100%;
    border-radius: 14px;
}
#resultado{
    font-size: 20px;
    text-align: center;
    margin-top: 10px;
}
</style>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

</head>

<body>

<header>
    <h1>Meu Sistema</h1>
</header>

<nav>
    <!-- seu menu normal continua aqui -->
</nav>

<main>

<section>
    <h2>Leitor de Código de Barras</h2>

    <div id="camera-area">
        <div id="interactive" class="viewport"></div>
    </div>

    <p id="resultado">Aponte a câmera para o código de barras</p>

    <button onclick="abrirCamera()">Abrir câmera</button>
    <button onclick="fecharCamera()">Fechar câmera</button>

    <audio id="beep">
        <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>

</section>

<section>
    <!-- resto do seu layout, tabelas, formulários, etc -->
</section>

</main>

<footer>
    <p>Sistema 2025</p>
</footer>

<script>

let ultimoCodigo = null;
let confirmacoes = 0;

// =============== ABRIR CÂMERA ===============
function abrirCamera(){

    navigator.mediaDevices.getUserMedia({video:true}).then(()=>{

        Quagga.init({
            inputStream:{
                name:"Live",
                type:"LiveStream",
                target: document.querySelector('#interactive'),
                constraints:{
                    facingMode: "environment"
                }
            },
            decoder:{
                readers:[
                    "ean_reader",
                    "ean_8_reader",
                    "code_128_reader",
                    "code_39_reader"
                ]
            },
            locate:true
        }, function(err){
            if(err){
                console.log(err);
                return;
            }
            Quagga.start();
        });

        // --------- DETECÇÃO COM PRECISÃO REFORÇADA -------
        Quagga.onDetected(function(result){

            let codigo = result.codeResult.code;

            // calcula erro médio dos segmentos
            let erros = result.codeResult.decodedCodes
                .map(c=>c.error)
                .filter(e=>e!==undefined);

            let mediaErro = erros.reduce((a,b)=>a+b,0) / erros.length;

            // exige boa qualidade
            if(mediaErro > 0.08){
                return;
            }

            // exige códigos repetidos iguais
            if(codigo === ultimoCodigo){
                confirmacoes++;
            } else {
                ultimoCodigo = codigo;
                confirmacoes = 1;
            }

            // só aceita com 3 confirmações consecutivas
            if(confirmacoes >= 3){

                document.getElementById("resultado").innerText =
                "Código detectado com sucesso: " + codigo;

                document.getElementById("beep").play();

                // aqui entra sua lógica:
                // ➜ consulta banco
                // ➜ se existir pergunta quantidade
                // ➜ se não existir vai para cadastro

                // pausa para não duplicar leitura
                confirmacoes = 0;
                ultimoCodigo = null;

                Quagga.pause();

                setTimeout(()=>{
                    Quagga.start();
                }, 1500);
            }

        });

    }).catch(()=>{
        alert("Permita o acesso à câmera no navegador.");
    });
}

// =============== FECHAR ===============
function fecharCamera(){
    Quagga.stop();
    document.getElementById("resultado").innerText = "Câmera desligada";
}

</script>

</body>
</html>
