<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Scanner Mercado</title>

<style>

body{
    font-family: Arial;
    background:#ffffff;
    margin:0;
}

/* TOPO ANTIGO */
.topo{
    text-align:center;
    margin-top:10px;
}

.topo img{
    width:130px;
    height:130px;
    border-radius:50%;
    object-fit:cover;

    /* profundidade */
    box-shadow:0 10px 25px rgba(0,0,0,0.35);
    border:3px solid #fff;
}

/* BLOCOS ANTIGOS */
.bloco{
    background:white;
    padding:15px;
    width:92%;
    margin:auto;
    border-radius:15px;
    box-shadow:0 0 10px rgba(0,0,0,0.15);
    margin-top:15px;
}

label{
    font-size:14px;
}

input, select{
    width:100%;
    padding:6px;
    border-radius:6px;
    border:1px solid #cfcfcf;
}

/* GRID ANTIGO LINHA IGUAL */
.linha{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:8px;
}

/* VIDEO ANTIGO */
#preview{
    width:100%;
    border-radius:12px;
    background:black;
}

/* BOT츾O PADR츾O */
button{
    background:#1a73e8;
    color:white;
    border:none;
    border-radius:15px;
    padding:8px 12px;
    margin-top:8px;
}

/* CARRINHO ANTIGO FLOATING */
.carrinho-btn{
    position:fixed;
    right:15px;
    bottom:15px;
    width:65px;
    height:65px;
    background:#1a73e8;
    color:white;
    font-size:28px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 5px 18px rgba(0,0,0,0.3);
}

/* MODAL ANTIGO */
.modal{
    position:fixed;
    left:0;
    top:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.6);
    display:none;
}

.modal-caixa{
    background:white;
    width:92%;
    margin:40px auto;
    border-radius:15px;
    padding:12px;
}

/* TABELA ANTIGA */
table{
    width:100%;
    border-collapse:collapse;
}

th, td{
    border-bottom:1px solid #ddd;
    padding:5px;
}

.total{
    text-align:right;
    font-weight:bold;
    margin-top:6px;
}

</style>
</head>

<body>

<div class="topo">
    <img src="logo.jpg">
</div>

<div class="bloco">
    <h3>Scanner de C칩digo de Barras</h3>
    <video id="preview"></video>
</div>

<div class="bloco">
    <h3>Cadastro / Edi칞칚o de Produto</h3>

    <div class="linha">
        <div>
            <label>C칩digo</label>
            <input id="codigo">
        </div>

        <div>
            <label>Nome</label>
            <input id="nome">
        </div>

        <div>
            <label>Valor</label>
            <input id="valor" type="number" step="0.01">
        </div>
    </div>

    <label>Tipo</label>
    <select id="tipo">
        <option>UN</option>
        <option>KG</option>
        <option>LT</option>
    </select>

    <button onclick="salvarProduto()">Salvar / Atualizar</button>
</div>

<!-- BOT츾O CARRINHO ORIGINAL -->
<div class="carrinho-btn" onclick="abrirCarrinho()">游</div>

<!-- MODAL -->
<div id="modal" class="modal">
    <div class="modal-caixa">
        <h3>Carrinho</h3>

        <table id="tabela"></table>

        <div id="total" class="total"></div>

        <button onclick="fecharCarrinho()">Fechar</button>
    </div>
</div>

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script>

let produtos = {};
let carrinho = [];

/* ========== SCANNER FUNCIONANDO SEM TELA PRETA ========== */

function iniciar(){

    Quagga.stop();

    Quagga.init({
        inputStream:{
            name:"Live",
            type:"LiveStream",
            target:document.querySelector('#preview'),
            constraints:{
                facingMode:"environment"   /* traseira */
            }
        },
        decoder:{
            readers:["ean_reader","ean_13_reader","code_128_reader"]
        }
    }, function(err){
        if(err){console.log(err);return;}
        Quagga.start();
    });

    let ultimo="";
    let repetido=0;

    Quagga.onDetected(function(e){

        let code = e.codeResult.code;

        if(code === ultimo){
            repetido++;
        } else {
            ultimo = code;
            repetido = 0;
        }

        if(repetido >= 2){
            Quagga.stop();
            tratarCodigo(code);
        }
    });
}

function tratarCodigo(code){

    // j치 existe
    if(produtos[code]){

        let qtd = prompt("Quantidade?");

        if(!qtd) { iniciar(); return;}

        carrinho.push({
            codigo:code,
            nome:produtos[code].nome,
            valor:produtos[code].valor,
            qtd:Number(qtd)
        });

        atualizarCarrinho();
        iniciar();
        return;
    }

    // n칚o cadastrado
    document.getElementById("codigo").value = code;
    alert("Produto n칚o cadastrado. Preencha abaixo para salvar.");
    iniciar();
}

/* ========== SALVAR PRODUTO ========== */

function salvarProduto(){

    let c = codigo.value;

    produtos[c] = {
        nome:nome.value,
        valor:Number(valor.value),
        tipo:tipo.value
    };

    alert("Salvo com sucesso");
}

/* ========== CARRINHO ========== */

function abrirCarrinho(){
    document.getElementById("modal").style.display="block";
    atualizarCarrinho();
}

function fecharCarrinho(){
    document.getElementById("modal").style.display="none";
}

function remover(i){
    carrinho.splice(i,1);
    atualizarCarrinho();
}

function atualizarCarrinho(){

    let tabela = document.getElementById("tabela");
    let total = 0;

    tabela.innerHTML = `
        <tr>
            <th>C칩digo</th>
            <th>Nome</th>
            <th>Qtd</th>
            <th>Valor</th>
            <th></th>
        </tr>
    `;

    carrinho.forEach((x,i)=>{

        let subtotal = x.valor * x.qtd;
        total += subtotal;

        tabela.innerHTML += `
        <tr>
            <td>${x.codigo}</td>
            <td>${x.nome}</td>
            <td>${x.qtd}</td>
            <td>R$ ${subtotal.toFixed(2)}</td>
            <td><button onclick="remover(${i})">Excluir</button></td>
        </tr>`;
    });

    document.getElementById("total").innerHTML =
        "Total: R$ " + total.toFixed(2);
}

window.onload = iniciar;

</script>

</body>
</html>
