<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de Código de Barras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h2>Scanner</h2>

<!-- Botões existentes -->
<button id="abrirCamera">Abrir câmera</button>
<button id="fecharCamera">Fechar câmera</button>

<!-- Vídeo existente -->
<video id="preview" width="100%" autoplay muted playsinline></video>

<!-- Campo onde aparece o código lido -->
<input type="text" id="resultado" placeholder="Resultado do código" />

<!-- Biblioteca ZXing -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<script>
let codeReader = null;
let stream = null;

// Abrir câmera e iniciar scan
document.getElementById("abrirCamera").addEventListener("click", async () => {
    try {
        // evita múltiplas leituras simultâneas
        if (codeReader) return;

        codeReader = new ZXingBrowser.BrowserMultiFormatReader();

        const videoElement = document.getElementById("preview");

        // solicita câmera traseira
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        videoElement.srcObject = stream;

        // iniciar decodificação contínua
        await codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
            if (result) {
                document.getElementById("resultado").value = result.getText();
            }
        });

    } catch (e) {
        alert("Erro ao abrir câmera: " + e.message);
        codeReader = null;
    }
});

// Fechar câmera
document.getElementById("fecharCamera").addEventListener("click", () => {
    try {
        if (codeReader) {
            codeReader.reset();
            codeReader = null;
        }
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        document.getElementById("preview").srcObject = null;
    } catch (e) {}
});
</script>

</body>
</html>
