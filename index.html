<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body{
    background:#eef3ff;
    font-family: Arial;
    margin:0;
}
.container{
    max-width:900px;
    margin:auto;
    padding:12px;
}
.logo{
    text-align:center;
    margin-top:10px;
}
.logo img{
    width:160px;
    height:160px;
    object-fit:cover;
    border-radius:50%;
    border:5px solid #ffffff;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.box{
    background:white;
    border-radius:18px;
    padding:16px;
    margin-top:15px;
    box-shadow:0 0 15px #00000010;
}
button{
    width:100%;
    padding:14px;
    border:none;
    font-size:16px;
    border-radius:12px;
    margin-top:8px;
}
.btnStart{ background:#2e6bff; color:white; }
.btnStop{ background:#6b6b6b; color:white; }

#camera{
    width:100%;
    height:260px;
    background:black;
    border-radius:18px;
    margin-top:10px;
    overflow:hidden;
    position:relative;
}
#camera video,
#camera canvas{
    width:100% !important;
    height:100% !important;
    object-fit:cover;
    position:absolute;
    top:0;
    left:0;
}

/* linha neon do scanner */
#scanLine{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:2px;
    background:red;
    box-shadow:0 0 12px red, 0 0 24px #ff0000;
    animation:scanMove 2.4s linear infinite;
    pointer-events:none;
}

@keyframes scanMove{
    0%{ top:0px; }
    50%{ top:240px; }
    100%{ top:0px; }
}

input, select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid #ccc;
    box-sizing:border-box;
    margin-top:6px;
}
table{
    width:100%;
    border-collapse:collapse;
}
td,th{
    padding:10px;
}
tr:nth-child(even){
    background:#f5f5f5;
}

#carrinhoIcone{
    position:fixed;
    right:18px;
    bottom:18px;
    width:70px;
    height:70px;
    border-radius:50%;
    background:#2e6bff;
    color:white;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    box-shadow:0 8px 20px rgba(0,0,0,.35);
    cursor:pointer;
}

.modal{
    position:fixed;
    left:0;
    top:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,.6);
    display:none;
}
.modal-content{
    background:white;
    width:92%;
    margin:40px auto;
    padding:12px;
    border-radius:18px;
}
.total{
    text-align:right;
    font-weight:bold;
    padding-top:10px;
}

/* tabela minimiz√°vel */
#areaProdutosConteudo{
    display:none;
}
.toggleBtn{
    background:#ffb703;
    color:#000;
}
</style>
</head>

<body>

<div class="container">

    <div class="logo">
        <img src="logo.jpg">
    </div>

    <h1 style="text-align:center">üõí Compras do m√™s üõçÔ∏è</h1>

    <!-- SCANNER -->
    <div class="box">
        <button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
        <button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>

        <div id="camera">
            <canvas id="freezeCanvas"></canvas>
            <div id="scanLine"></div>
        </div>

        <p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
    </div>

    <!-- lista produtos -->
    <div class="box">
        <h2>üì¶ Produtos cadastrados</h2>

        <button class="toggleBtn" onclick="toggleProdutos()">Mostrar / Ocultar</button>

        <div id="areaProdutosConteudo">
            <table id="produtosTable">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Pre√ßo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- cadastro -->
    <div class="box">
        <h2>‚úèÔ∏è Edi√ß√£o de produto</h2>

        <label>C√≥digo</label>
        <input id="codigo">

        <label>Nome</label>
        <input id="nome">

        <label>Tipo</label>
        <select id="tipo">
            <option>Unidade (UN)</option>
            <option>Peso (KG)</option>
        </select>

        <label>Valor</label>
        <input id="valor" type="number" step="0.01">

        <button onclick="salvarProduto()">Salvar</button>
    </div>

</div>

<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è</div>

<div id="modalCarrinho" class="modal">
  <div class="modal-content">
    <h2>Carrinho</h2>

    <table id="tabelaCarrinho">
        <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Qtd</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
    </table>

    <p id="total" class="total">Total: R$ 0,00</p>

    <button onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho = [];

/* minimizar lista */
function toggleProdutos(){
    let div = document.getElementById("areaProdutosConteudo");
    div.style.display = (div.style.display==="none"||div.style.display==="") ? "block" : "none";
}

/* tabela */
function atualizarTabela(){
    const tb=document.querySelector("#produtosTable tbody");
    tb.innerHTML="";
    produtos.forEach(p=>{
        let tr=document.createElement("tr");
        tr.innerHTML=\`<td>\${p.codigo}</td><td>\${p.nome}</td><td>\${p.tipo}</td><td>\${p.valor}</td>\`;
        tb.appendChild(tr);
    });
}
atualizarTabela();

/* salvar */
function salvarProduto(){
    let p={
        codigo:codigo.value,
        nome:nome.value,
        tipo:tipo.value,
        valor:Number(valor.value)
    };

    produtos = produtos.filter(x=>x.codigo!==p.codigo);
    produtos.push(p);

    localStorage.setItem("produtos",JSON.stringify(produtos));

    atualizarTabela();

    alert("Produto salvo");

    codigo.value="";
    nome.value="";
    valor.value="";
    tipo.selectedIndex=0;
}

/* carrinho */
function abrirCarrinho(){
    modalCarrinho.style.display="block";
    atualizarCarrinho();
}
function fecharCarrinho(){
    modalCarrinho.style.display="none";
}
function removerItem(i){
    carrinho.splice(i,1);
    atualizarCarrinho();
}
function atualizarCarrinho(){
    let tabela=document.getElementById("tabelaCarrinho");
    tabela.innerHTML=`
        <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Qtd</th>
            <th>Subtotal</th>
            <th></th>
        </tr>`;
    let total=0;

    carrinho.forEach((x,i)=>{
        let sub=x.valor*x.qtd;
        total+=sub;

        tabela.innerHTML+=\`
        <tr>
            <td>\${x.codigo}</td>
            <td>\${x.nome}</td>
            <td>\${x.qtd}</td>
            <td>R$ \${sub.toFixed(2)}</td>
            <td><button onclick="removerItem(\${i})">Excluir</button></td>
        </tr>\`;
    });

    totalEl.innerText="Total: R$ "+total.toFixed(2);
}

const totalEl=document.getElementById("total");

/* beep */
const beep=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

/* SCANNER */
let lendo=false;
let historicoLeituras=[];
let videoTrack=null;
let congelado=false;

/* congela imagem */
function congelarFrame(){
    const canvas=document.getElementById("freezeCanvas");
    const video=document.querySelector("#camera video");

    if(!video) return;

    const ctx=canvas.getContext("2d");
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;

    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    canvas.style.display="block";
    congelado=true;
}

/* limpa congelamento */
function limparCongelamento(){
    const canvas=document.getElementById("freezeCanvas");
    canvas.style.display="none";
    congelado=false;
}

function iniciarScanner(){
    if(lendo) return;
    lendo=true;
    limparCongelamento();

    try{ Quagga.stop(); }catch(e){}

    Quagga.init({
        inputStream:{
            name:"Live",
            type:"LiveStream",
            target:document.querySelector("#camera"),
            constraints:{
                facingMode:"environment",
                width:{ideal:1280},
                height:{ideal:720}
            }
        },
        locator:{
            patchSize:"medium",
            halfSample:true
        },
        locate:true,
        decoder:{
            readers:[
                "ean_reader",
                "ean_13_reader",
                "ean_8_reader",
                "code_128_reader",
                "upc_reader",
                "upc_e_reader"
            ]
        }
    },err=>{
        if(err){
            alert("Erro ao iniciar a c√¢mera");
            lendo=false;
            return;
        }
        Quagga.start();

        /* pega track p/ pausa */
        let stream=Quagga._cameraAccess?.stream;
        if(stream){
            videoTrack=stream.getVideoTracks()[0];
        }
    });

    historicoLeituras=[];

    Quagga.offDetected();
    Quagga.onDetected(res=>{

        if(congelado) return;
        if(!res.codeResult?.code) return;

        let code=res.codeResult.code.trim();

        /* valida 3 vezes iguais */
        historicoLeituras.push(code);
        if(historicoLeituras.length>6) historicoLeituras.shift();

        let ultimas = historicoLeituras.slice(-3);
        if(!(ultimas[0]===ultimas[1] && ultimas[2]===ultimas[1])) return;

        historicoLeituras=[];

        detected.innerText=code;

        beep.currentTime=0;
        beep.play().catch(()=>{});

        /* congela imagem da c√¢mera */
        congelarFrame();
        try{Quagga.stop();}catch(e){}

        let produto = produtos.find(p=>p.codigo==code);

        if(produto){

            let qtd = prompt("Produto: " + produto.nome + "\n\nQuantidade?");
            if(!qtd) return;

            carrinho.push({
                codigo:code,
                nome:produto.nome,
                valor:Number(produto.valor),
                qtd:Number(qtd)
            });

            atualizarCarrinho();
            abrirCarrinho();

        } else {
            codigo.value=code;
            alert("Produto n√£o cadastrado. Preencha abaixo.");
        }
    });
}

function pararScanner(){
    try{Quagga.stop();}catch(e){}
    lendo=false;
    historicoLeituras=[];
    limparCongelamento();
}

document.getElementById("startButton").onclick=iniciarScanner;
document.getElementById("stopButton").onclick=pararScanner;
</script>

</body>
</html>
