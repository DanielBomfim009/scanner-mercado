<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras do m√™s</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body{background:#eef3ff;font-family:Arial;margin:0;}
.container{max-width:900px;margin:auto;padding:12px;}
.logo{text-align:center;margin-top:10px;}
.logo img{width:160px;height:160px;object-fit:cover;border-radius:50%;border:5px solid #fff;box-shadow:0 10px 30px rgba(0,0,0,.35);}
.box{background:white;border-radius:18px;padding:16px;margin-top:15px;box-shadow:0 0 15px #00000010;}
button{width:100%;padding:14px;border:none;font-size:16px;border-radius:12px;margin-top:8px;}
.btnStart{background:#2e6bff;color:white;}
.btnStop{background:#6b6b6b;color:white;}

#camera{width:100%;height:260px;background:black;border-radius:18px;margin-top:10px;overflow:hidden;position:relative;}
#camera video{width:100%;height:100%;object-fit:cover;}

.scan-line{
  position:absolute;left:0;right:0;height:2px;
  background:red;box-shadow:0 0 10px red,0 0 20px red;
  animation:scan 2s linear infinite;
}
@keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}

input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px;}
table{width:100%;border-collapse:collapse;}
td,th{padding:10px;}
tr:nth-child(even){background:#f5f5f5;}

#carrinhoIcone{
  position:fixed;right:18px;bottom:18px;width:70px;height:70px;
  border-radius:50%;background:#2e6bff;color:white;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;box-shadow:0 8px 20px rgba(0,0,0,.35);cursor:pointer;
}

.modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;}
.modal-content{background:white;width:92%;margin:40px auto;padding:12px;border-radius:18px;}
.total{text-align:right;font-weight:bold;padding-top:10px;}

.subtotal{
  background:#e6edff;
  color:#1a3cff;
  padding:4px 8px;
  border-radius:6px;
  font-weight:bold;
}

.btn-trash{
  background:none;border:none;font-size:20px;cursor:pointer;color:#ff3b3b;
}
.btn-trash:hover{transform:scale(1.15);}
</style>
</head>

<body>

<div class="container">
<div class="logo"><img src="logo.jpg"></div>
<h1 style="text-align:center">üõí Compras do m√™s üõçÔ∏è</h1>

<div class="box">
<button class="btnStart" id="startButton">üì∏ Abrir c√¢mera</button>
<button class="btnStop" id="stopButton">‚èπÔ∏è Parar</button>

<div id="camera">
  <video id="video" playsinline></video>
  <div class="scan-line"></div>
</div>

<p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
</div>

</div>

<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è</div>

<div id="modalCarrinho" class="modal">
<div class="modal-content">
<h2>Carrinho</h2>
<table id="tabelaCarrinho"></table>
<p id="total" class="total">Total: R$ 0,00</p>
<button onclick="fecharCarrinho()">Fechar</button>
</div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")||"[]");
let carrinho = JSON.parse(localStorage.getItem("carrinho")||"[]");

let stream = null;
let reader = null;
let buffer = [];
let scannerAtivo = false;

const repeticoes = 3;
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

function abrirCarrinho(){
  modalCarrinho.style.display="block";
  atualizarCarrinho();
}
function fecharCarrinho(){
  modalCarrinho.style.display="none";
}

function atualizarCarrinho(){
  let total=0;
  tabelaCarrinho.innerHTML=`<tr><th>C√≥digo</th><th>Nome</th><th>Qtd</th><th>Subtotal</th><th></th></tr>`;
  carrinho.forEach((x,i)=>{
    let sub=x.valor*x.qtd; total+=sub;
    tabelaCarrinho.innerHTML+=`
    <tr>
      <td>${x.codigo}</td>
      <td>${x.nome}</td>
      <td>${x.qtd}</td>
      <td><span class="subtotal">R$ ${sub.toFixed(2)}</span></td>
      <td><button class="btn-trash" onclick="carrinho.splice(${i},1);localStorage.setItem('carrinho',JSON.stringify(carrinho));atualizarCarrinho()">üóëÔ∏è</button></td>
    </tr>`;
  });
  total.innerText="Total: R$ "+total.toFixed(2);
}

async function iniciarScanner(){
  if(scannerAtivo) return;

  scannerAtivo = true;
  buffer = [];

  const video = document.getElementById("video");

  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject = stream;
  await video.play();

  reader = new ZXing.BrowserMultiFormatReader();

  reader.decodeFromVideoElementContinuously(video,(res)=>{
    if(!res || !scannerAtivo) return;

    const code = res.text.trim();
    detected.innerText = code;

    buffer.push(code);
    if(buffer.length > repeticoes) buffer.shift();

    if(buffer.length === repeticoes && buffer.every(v=>v===code)){
      scannerAtivo = false;
      buffer = [];

      beep.currentTime = 0;
      beep.play();

      pararScanner();

      const produto = produtos.find(p=>p.codigo===code);

      if(produto){
        const qtd = prompt("Quantidade:");
        if(qtd){
          carrinho.push({codigo:code,nome:produto.nome,valor:produto.valor,qtd:Number(qtd)});
          localStorage.setItem("carrinho",JSON.stringify(carrinho));
          atualizarCarrinho();
          abrirCarrinho();
        }
      }else{
        alert("Produto n√£o cadastrado");
      }
    }
  });
}

function pararScanner(){
  if(reader){
    reader.reset();
    reader = null;
  }
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
}

startButton.onclick=iniciarScanner;
stopButton.onclick=pararScanner;
</script>

</body>
</html>
