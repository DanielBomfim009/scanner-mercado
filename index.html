<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>GoL BUY SMART</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#4361ee" />
<!-- PWA: Manifesto e √≠cones -->
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="logo.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<!-- Bibliotecas externas -->
<script src="https://unpkg.com/@zxing/library@0.21.2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
:root {
--primary: #4361ee;
--primary-dark: #3a56d4;
--primary-light: #4895ef;
--secondary: #3a56d4;
--success: #4ade80;
--danger: #f87171;
--background: #f8f9ff;
--card: #ffffff;
--text: #1e293b;
--text-muted: #64748b;
--border: #e2e8f0;
--radius: 20px;
--shadow: 0 10px 25px -5px rgba(67, 97, 238, 0.1);
--transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
/* Temas personaliz√°veis */
body.tema-verde {
--primary: #22c55e;
--primary-dark: #16a34a;
--primary-light: #4ade80;
--secondary: #16a34a;
}
body.tema-roxo {
--primary: #8b5cf6;
--primary-dark: #7c3aed;
--primary-light: #a78bfa;
--secondary: #7c3aed;
}
body.tema-laranja {
--primary: #fb923c;
--primary-dark: #f97316;
--primary-light: #fdba74;
--secondary: #f97316;
}
@media (prefers-color-scheme: dark) {
:root,
body.tema-verde,
body.tema-roxo,
body.tema-laranja {
--background: #0f172a;
--card: #1e293b;
--text: #f1f5f9;
--text-muted: #94a3b8;
--border: #334155;
--shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
}
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}
body {
background: var(--background);
display: flex;
min-height: 100vh;
overflow-x: hidden;
font-size: 16px;
color: var(--text);
}

/* ‚úÖ Esconde elementos durante o splash */
body.loading #hamburger,
body.loading #carrinhoIcone {
  display: none !important;
}

#splash {
position: fixed;
inset: 0;
background: #1e293b;
color: white;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 2000;
opacity: 1;
transition: opacity 0.5s;
}
#splash img {
width: 300px;
height: 300px;
object-fit: contain;
filter: drop-shadow(0 12px 28px rgba(0,0,0,0.4)) brightness(1.1);
z-index: 2001;
}
#splash p {
margin-top: 15px;
font-size: 18px;
font-weight: 600;
z-index: 2001;
text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ‚úÖ CORRE√á√ÉO SIDEBAR PARA IOS */
#sidebar {
position: fixed;
top: 0;
left: 0;
bottom: 0;
width: 220px;
background: var(--primary);
color: white;
display: flex;
flex-direction: column;
padding-top: 60px;
transition: left 0.3s ease;
z-index: 1100;
left: 0;
}
#sidebar.hide {
left: -220px;
}
#sidebar button {
background: none;
border: none;
color: white;
text-align: left;
padding: 16px 20px;
font-size: 17px;
font-weight: 600;
display: flex;
align-items: center;
gap: 12px;
cursor: pointer;
border-radius: 0 12px 12px 0;
width: 100%;
transition: var(--transition);
}
#sidebar button:hover {
background: rgba(255, 255, 255, 0.15);
padding-left: 28px;
}

/* ‚úÖ HAMBURGER VIS√çVEL */
#hamburger {
position: fixed;
top: 16px;
left: 16px;
width: 52px;
height: 52px;
background: var(--primary);
color: white;
display: flex;
align-items: center;
justify-content: center;
border-radius: 14px;
/* ‚úÖ z-index aumentado para sempre aparecer */
z-index: 3000;
cursor: pointer;
font-size: 28px;
box-shadow: var(--shadow);
transition: var(--transition);
font-weight: bold;
text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
#hamburger:hover {
transform: rotate(90deg);
background: var(--primary-light);
}

/* ‚úÖ CONTENT RESPONSIVO */
#content {
margin-left: 220px;
flex: 1;
padding: 24px 20px;
transition: margin-left 0.3s;
min-height: 100vh;
overflow-y: auto;
box-sizing: border-box;
}
#content.full {
margin-left: 0;
}

/* ‚úÖ VIEW COM ESPA√áO PARA CARRINHO */
.view {
display: none;
animation: fadeIn 0.3s ease;
padding-bottom: 100px; /* ‚úÖ Espa√ßo para carrinho */
overflow-x: hidden;
max-width: 100%;
}
.view.active {
display: block;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(8px); }
to { opacity: 1; transform: none; }
}

#orcamentoAlerta {
position: fixed;
top: 20px;
right: 20px;
background: var(--danger);
color: white;
padding: 12px 20px;
border-radius: 12px;
font-weight: 600;
box-shadow: 0 6px 16px rgba(0,0,0,0.2);
z-index: 1000;
opacity: 0;
transform: translateY(-20px);
transition: opacity 0.3s, transform 0.3s;
}
#orcamentoAlerta.show {
opacity: 1;
transform: translateY(0);
}
#home {
text-align: center;
padding-top: 20px;
}
#home .logo-home {
width: 280px;
height: 280px;
object-fit: contain;
margin: 0 auto 20px;
filter: drop-shadow(0 8px 16px rgba(67, 97, 238, 0.15));
}
#home h2 {
margin: 10px 0;
color: var(--primary);
font-weight: 800;
font-size: 1.8rem;
letter-spacing: -0.5px;
}
#temaContainer {
margin: 16px auto 24px;
max-width: 320px;
}
#temaSelector {
width: 100%;
padding: 10px 14px;
border-radius: 12px;
border: 1px solid var(--border);
background: var(--card);
color: var(--text);
font-size: 15px;
box-shadow: var(--shadow);
}
#orcamento {
position: relative;
max-width: 400px;
margin: 20px auto;
}
#orcamento h3 {
margin-bottom: 12px;
font-weight: 700;
color: var(--text);
}
.orcamento-input-container {
position: relative;
display: flex;
align-items: center;
width: 100%;
margin-top: 12px;
}
.real-prefix {
position: absolute;
left: 16px;
color: var(--text-muted);
font-weight: 700;
font-size: 18px;
pointer-events: none;
z-index: 1;
}
#orcamentoInput {
width: 100%;
padding: 14px 14px 14px 52px !important;
border-radius: 14px;
border: 1px solid var(--border);
font-size: 16px;
background: var(--card);
color: var(--text);
transition: var(--transition);
}
#orcamentoInput:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}
#orcamentoBarra {
height: 14px;
background: #e2e8f0;
border-radius: 7px;
margin-top: 12px;
overflow: hidden;
border: 1px solid var(--border);
}
#orcamentoBarraInner {
height: 100%;
width: 0%;
background: linear-gradient(90deg, var(--secondary), var(--primary-light));
border-radius: 7px;
text-align: center;
color: white;
font-weight: 700;
transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
position: relative;
}
#orcamentoBarraInner::after {
content: attr(data-pct);
position: absolute;
right: 8px;
top: 50%;
transform: translateY(-50%);
font-size: 11px;
text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.box {
background: var(--card);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 24px;
box-shadow: var(--shadow);
border: 1px solid var(--border);
transition: var(--transition);
width: 100%;
max-width: 100%;
overflow-x: auto;
}
.box:hover {
transform: translateY(-3px);
box-shadow: 0 14px 32px -8px rgba(0, 0, 0, 0.18);
}
#scannerInfo {
display: flex;
flex-direction: column;
gap: 16px;
margin-top: 20px;
}
#camera {
width: 100%;
height: 260px;
background: #000;
border-radius: var(--radius);
overflow: hidden;
position: relative;
box-shadow: var(--shadow);
}
#camera video {
width: 100%;
height: 100%;
object-fit: cover;
border-radius: var(--radius);
}
#camera .reiniciando {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.85);
color: white;
display: flex;
align-items: center;
justify-content: center;
font-size: 16px;
font-weight: 600;
border-radius: var(--radius);
z-index: 10;
opacity: 0;
pointer-events: none;
transition: opacity 0.2s;
}
.scan-overlay {
position: absolute;
top: 15%;
left: 15%;
width: 70%;
height: 70%;
border: 3px solid var(--secondary);
border-radius: 8px;
pointer-events: none;
box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
}
.scan-overlay::before,
.scan-overlay::after {
content: '';
position: absolute;
width: 32px;
height: 32px;
border: 3px solid var(--secondary);
}
.scan-overlay::before {
top: -3px; left: -3px;
border-right: none;
border-bottom: none;
}
.scan-overlay::after {
bottom: -3px; right: -3px;
border-left: none;
border-top: none;
}
.scan-line {
position: absolute;
top: 15%;
left: 15%;
width: 70%;
height: 4px;
background: var(--secondary);
box-shadow: 0 0 12px var(--secondary);
animation: scan 2.5s linear infinite;
}
@keyframes scan {
0% { top: 15%; }
50% { top: 85%; }
100% { top: 15%; }
}
#produtosBox {
overflow-x: auto;
width: 100%;
}
table {
width: 100%;
border-collapse: collapse;
margin-top: 12px;
font-size: 15px;
table-layout: fixed;
}
th, td {
padding: 12px 10px;
text-align: center;
border-bottom: 1px solid var(--border);
word-wrap: break-word;
overflow: hidden;
}
th {
font-weight: 700;
color: var(--text);
}
tr:last-child td {
border-bottom: none;
}
tr:nth-child(even) {
background: rgba(67, 97, 238, 0.03);
}
@media (prefers-color-scheme: dark) {
tr:nth-child(even) {
background: rgba(67, 97, 238, 0.08);
}
}
button.editBtn {
background: var(--success);
color: #000;
margin-right: 6px;
border: none;
padding: 8px 14px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: var(--transition);
}
button.editBtn:hover {
background: #ffcc33;
transform: translateY(-2px);
}
button.deleteBtn {
background: var(--danger);
color: white;
border: none;
padding: 8px 14px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: var(--transition);
}
button.deleteBtn:hover {
background: #ff6b6b;
transform: translateY(-2px);
}
.historico-card {
background: var(--card);
border-radius: 14px;
padding: 18px;
margin-bottom: 16px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
border: 1px solid var(--border);
}
.historico-card h4 {
margin-bottom: 8px;
color: var(--primary);
font-weight: 700;
}
.historico-card small {
color: var(--text-muted);
display: block;
margin-bottom: 10px;
}
.historico-card details {
margin-top: 8px;
}
.historico-card details ul {
padding-left: 24px;
margin: 8px 0;
max-height: 150px;
overflow-y: auto;
}
#carrinhoIcone {
position: fixed;
bottom: 24px;
right: 24px;
width: 72px;
height: 72px;
background: var(--secondary);
border-radius: 50%;
color: white;
display: flex;
align-items: center;
justify-content: center;
font-size: 28px;
cursor: pointer;
/* ‚úÖ z-index alto para sempre aparecer */
z-index: 3000;
box-shadow: 0 8px 20px rgba(58, 86, 212, 0.4);
transition: var(--transition);
}
#carrinhoIcone:hover {
transform: scale(1.12) rotate(10deg);
box-shadow: 0 10px 25px rgba(58, 86, 212, 0.6);
}
#carrinhoIcone span {
position: absolute;
top: -4px;
right: -4px;
width: 24px;
height: 24px;
background: var(--primary);
color: white;
border-radius: 50%;
font-size: 12px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 700;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#modalCarrinho {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.7);
display: none;
z-index: 1000;
align-items: center;
justify-content: center;
}
#modalCarrinho .modal-content {
background: var(--card);
width: 95%;
max-width: 480px;
margin: 40px auto;
padding: 28px;
border-radius: var(--radius);
box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
border: 1px solid var(--border);
transform: scale(0.95);
opacity: 0;
transition: transform 0.3s, opacity 0.3s;
}
#modalCarrinho.active .modal-content {
transform: scale(1);
opacity: 1;
}
#modalCarrinho table {
width: 100%;
margin-bottom: 16px;
}
#modalCarrinho button {
width: 100%;
padding: 14px;
margin-top: 12px;
border: none;
border-radius: 14px;
color: white;
background: var(--primary);
cursor: pointer;
font-weight: 700;
font-size: 17px;
transition: var(--transition);
}
#modalCarrinho button:hover {
background: var(--primary-light);
transform: translateY(-2px);
}
#cadastroBox {
max-width: 420px;
margin: 20px auto;
position: relative;
}
#cadastroBox h2 {
margin-bottom: 20px;
color: var(--primary);
text-align: center;
}
#cadastroBox input,
#cadastroBox select,
#cadastroBox button {
width: 100%;
padding: 14px;
margin-top: 10px;
border-radius: 14px;
border: 1px solid var(--border);
font-size: 16px;
background: var(--card);
color: var(--text);
transition: var(--transition);
}
#cadastroBox input:focus,
#cadastroBox select:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}
#cadastroBox button {
background: var(--primary);
color: white;
border: none;
font-weight: 700;
transition: var(--transition);
}
#cadastroBox button:hover {
background: var(--primary-light);
transform: translateY(-2px);
}
#scannerChartBox {
margin-top: 24px;
height: 200px;
}
#barraValidacao {
height: 14px;
background: #e2e8f0;
border-radius: 7px;
margin-top: 12px;
overflow: hidden;
border: 1px solid var(--border);
}
#barraValidacaoInner {
height: 100%;
width: 0%;
background: linear-gradient(90deg, var(--secondary), var(--primary-light));
border-radius: 7px;
text-align: center;
color: white;
font-weight: 700;
transition: width 0.5s;
position: relative;
}
#barraValidacaoInner::after {
content: attr(data-pct);
position: absolute;
right: 8px;
top: 50%;
transform: translateY(-50%);
font-size: 11px;
text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
@media (max-width: 768px) {
#sidebar { width: 200px; }
#content { margin-left: 200px; padding: 20px 16px; }
.box { padding: 20px; }
}
@media (max-width: 480px) {
#sidebar { width: 180px; left: -180px; }
#sidebar.hide { left: -180px; }
#content { margin-left: 180px; padding: 16px 12px; }
#home .logo-home { width: 240px; height: 240px; }
#hamburger { width: 48px; height: 48px; }
#orcamento input { font-size: 15px; }
.view { padding-bottom: 120px; }
#carrinhoIcone { bottom: 16px; right: 16px; width: 64px; height: 64px; }
}
@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.2); }
}
.quantidade-modal {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--card);
padding: 24px;
border-radius: 16px;
box-shadow: 0 12px 32px rgba(0,0,0,0.3);
z-index: 1100;
border: 1px solid var(--border);
text-align: center;
max-width: 320px;
width: 90vw;
}
.quantidade-modal input {
width: 100%;
padding: 12px;
margin: 12px 0;
border: 1px solid var(--border);
border-radius: 12px;
font-size: 18px;
text-align: center;
background: var(--card);
color: var(--text);
}
.quantidade-modal button {
background: var(--primary);
color: white;
border: none;
border-radius: 12px;
padding: 10px 20px;
font-weight: 600;
margin: 0 6px;
cursor: pointer;
transition: var(--transition);
}
.quantidade-modal button:hover {
background: var(--primary-light);
}
#overlayQuantidade {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.5);
z-index: 1050;
display: none;
}
</style>
</head>
<body class="loading">
<div id="splash">
<img src="logo.png" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
<p>Bem-vindo ao seu app de compras inteligente</p>
</div>
<div id="hamburger">‚ò∞</div>
<div id="sidebar">
<button onclick="irPara('home')">üè† Home</button>
<button onclick="irPara('scanner')">üì∑ Scanner</button>
<button onclick="irPara('produtos')">üì¶ Produtos</button>
<button onclick="irPara('cadastro')">üìù Cadastro</button>
<button onclick="irPara('historico')">üßæ Hist√≥rico</button>
</div>
<div id="orcamentoAlerta">‚ö†Ô∏è Or√ßamento excedido!</div>
<div id="content">
<section id="home" class="view active">
<img src="logo.png" class="logo-home" alt="GoL BUY SMART ‚Äì App de compras inteligente" />
<h2>Bem-vindo ao GoL BUY SMART</h2>
<div id="temaContainer">
<select id="temaSelector" onchange="mudarTema(this.value)">
<option value="padrao">Tema Padr√£o (Azul)</option>
<option value="verde">Tema Verde</option>
<option value="roxo">Tema Roxo</option>
<option value="laranja">Tema Laranja</option>
</select>
</div>
<div id="orcamento" class="box">
<h3>üí∞ Or√ßamento Mensal</h3>
<div class="orcamento-input-container">
<span class="real-prefix">R$</span>
<input type="number" id="orcamentoInput" placeholder="0,00" min="0" step="0.01" />
</div>
<div id="orcamentoBarra">
<div id="orcamentoBarraInner" data-pct="0%"></div>
</div>
<p style="margin-top: 12px; color: var(--text-muted);">
Gasto atual: <strong>R$ <span id="orcamentoGasto">0.00</span></strong>
</p>
</div>
</section>
<section id="scanner" class="view">
<div class="box">
<h2 style="text-align:center; margin-bottom:16px;">Scanner de Produtos</h2>
<div id="camera">
<video id="video" playsinline></video>
<div class="reiniciando" id="reiniciandoMensagem">Reiniciando c√¢mera...</div>
<div class="scan-overlay"></div>
<div class="scan-line"></div>
</div>
<div id="scannerInfo">
<p><strong>C√≥digo detectado:</strong> <span id="detected">‚Äî</span></p>
<p><strong>Total produtos cadastrados:</strong> <span id="totalProdutos">0</span></p>
<div id="scannerChartBox">
<canvas id="categoriaChart"></canvas>
</div>
</div>
<div id="barraValidacao">
<div id="barraValidacaoInner" data-pct="0%"></div>
</div>
</div>
</section>
<section id="produtos" class="view">
<div id="produtosBox" class="box">
<h2 style="margin-bottom:16px;">Produtos Cadastrados</h2>
<table id="produtosTable">
<thead>
<tr>
<th>C√≥digo</th>
<th>Nome</th>
<th>Categoria</th>
<th>Tipo</th>
<th>Valor</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<section id="cadastro" class="view">
<div id="cadastroBox" class="box">
<h2 id="cadastro-title">Cadastro de Produto</h2>
<input id="codigoCadastro" placeholder="C√≥digo" />
<input id="nomeCadastro" placeholder="Nome" />
<select id="categoriaCadastro">
<option value="Alimentos">Alimentos</option>
<option value="Limpeza">Limpeza</option>
<option value="Bebida">Bebida</option>
<option value="Farm√°cia">Farm√°cia</option>
<option value="Higiene">Higiene</option>
<option value="Outros">Outros</option>
</select>
<select id="tipoCadastro">
<option>UN</option>
<option>KG</option>
</select>
<input id="valorCadastro" type="number" step="0.01" placeholder="Valor" />
<button id="salvarCadastro">Salvar Produto</button>
</div>
</section>
<section id="historico" class="view">
<div class="box" id="historicoConteudo"></div>
</section>
</div>
<div id="carrinhoIcone" onclick="abrirCarrinho()">üõçÔ∏è<span id="badge">0</span></div>
<div id="modalCarrinho">
<div class="modal-content">
<h3 style="margin-bottom:16px; color: var(--primary);">Carrinho</h3>
<table id="tabelaCarrinho"></table>
<p id="total" style="font-weight:700; color: var(--primary); margin:16px 0;">Total: R$ 0,00</p>
<button onclick="finalizarCompra()">Finalizar</button>
<button onclick="fecharCarrinho()">Fechar</button>
</div>
</div>
<div id="overlayQuantidade"></div>
<div id="quantidadeModal" class="quantidade-modal" style="display:none;">
<h3 id="tituloQuantidade">Informe a quantidade</h3>
<input type="number" id="inputQuantidade" min="1" value="1" step="1" />
<div>
<button id="btnConfirmarQtd">Confirmar</button>
<button id="btnCancelarQtd">Cancelar</button>
</div>
</div>
<script>
const $ = id => document.getElementById(id);
const Storage = {
get: (k, f = []) => JSON.parse(localStorage.getItem(k)) || f,
set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
};
let produtos = Storage.get("produtos");
let carrinho = Storage.get("carrinho");
let historico = Storage.get("historicoCompras");
let orcamento = Storage.get("orcamento") || 0;
let reader = null, stream = null, buffer = [], scannerAtivo = false;
const repeticoes = 3;
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
// Carregar tema salvo
const temaSalvo = localStorage.getItem('tema') || 'padrao';
if (temaSalvo !== 'padrao') {
document.body.classList.add(`tema-${temaSalvo}`);
}
if ($("temaSelector")) {
$("temaSelector").value = temaSalvo;
}
function mudarTema(tema) {
document.body.className = document.body.className.replace(/tema-\w+/g, '').trim();
if (tema !== 'padrao') {
document.body.classList.add(`tema-${tema}`);
}
localStorage.setItem('tema', tema);
if (document.getElementById("scanner").classList.contains("active")) {
setTimeout(atualizarScannerChart, 100);
}
}
function normalizarCodigo(cod) {
return (cod || '').toString().trim().replace(/[\r\n\t\s]+/g, '');
}
function verificarOrcamento() {
const gasto = carrinho.reduce((a, b) => a + b.valor * b.qtd, 0);
const pct = orcamento ? (gasto / orcamento) * 100 : 0;
const alerta = $("orcamentoAlerta");
if (pct >= 90 && orcamento > 0) {
alerta.classList.add('show');
setTimeout(() => alerta.classList.remove('show'), 3000);
}
}
function solicitarQuantidade(produtoNome, callback) {
pararScanner();
$("tituloQuantidade").innerText = `Produto: ${produtoNome}\nInforme a quantidade`;
$("inputQuantidade").value = "1";
$("btnConfirmarQtd").onclick = () => {
const q = Number($("inputQuantidade").value);
fecharQuantidade();
if (q > 0) callback(q);
};
$("btnCancelarQtd").onclick = fecharQuantidade;
$("overlayQuantidade").style.display = "block";
$("quantidadeModal").style.display = "block";
}
function fecharQuantidade() {
$("overlayQuantidade").style.display = "none";
$("quantidadeModal").style.display = "none";
if (document.getElementById("scanner")?.classList.contains("active")) {
setTimeout(() => {
if (!scannerAtivo) iniciarScanner();
}, 300);
}
}
function iniciarApp() {
window.irPara = function(tela) {
document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
$(tela).classList.add("active");
if (tela === "scanner") {
setTimeout(() => iniciarScanner(), 100);
} else {
pararScanner();
}
};
const sidebar = $("sidebar");
const content = $("content");
const hamburger = $("hamburger");
hamburger.onclick = () => {
sidebar.classList.toggle("hide");
content.classList.toggle("full");
};
if ($("orcamentoInput")) {
$("orcamentoInput").value = orcamento;
$("orcamentoInput").addEventListener("input", () => {
orcamento = Number($("orcamentoInput").value);
localStorage.setItem("orcamento", orcamento);
atualizarOrcamento();
verificarOrcamento();
});
}
function atualizarOrcamento() {
const gasto = carrinho.reduce((a, b) => a + b.valor * b.qtd, 0);
$("orcamentoGasto").innerText = gasto.toFixed(2);
const pct = orcamento ? Math.min(100, (gasto / orcamento) * 100) : 0;
const bar = $("orcamentoBarraInner");
bar.style.width = pct + "%";
bar.setAttribute('data-pct', Math.round(pct) + '%');
}
function atualizarProdutosTable() {
let html = "";
produtos.forEach((p, i) => {
html += `
<tr>
<td>${p.codigo}</td>
<td>${p.nome}</td>
<td>${p.categoria}</td>
<td>${p.tipo}</td>
<td>R$ ${p.valor.toFixed(2)}</td>
<td>
<button class="editBtn" onclick="editarProduto(${i})">‚úèÔ∏è</button>
<button class="deleteBtn" onclick="excluirProduto(${i})">‚ùå</button>
</td>
</tr>`;
});
const tbody = $("produtosTable")?.querySelector("tbody");
if (tbody) tbody.innerHTML = html;
if ($("totalProdutos")) $("totalProdutos").innerText = produtos.length;
}
window.editarProduto = function(i) {
$("cadastro-title").innerText = "Editar Produto";
$("codigoCadastro").value = produtos[i].codigo;
$("nomeCadastro").value = produtos[i].nome;
$("categoriaCadastro").value = produtos[i].categoria;
$("tipoCadastro").value = produtos[i].tipo;
$("valorCadastro").value = produtos[i].valor;
produtos.splice(i, 1);
Storage.set("produtos", produtos);
irPara("cadastro");
};
window.excluirProduto = function(i) {
if (confirm("Excluir produto?")) {
produtos.splice(i, 1);
Storage.set("produtos", produtos);
atualizarProdutosTable();
atualizarScannerChart();
}
};
const salvarOriginal = () => {
const novo = {
codigo: $("codigoCadastro").value.trim(),
nome: $("nomeCadastro").value.trim(),
categoria: $("categoriaCadastro").value,
tipo: $("tipoCadastro").value,
valor: Number($("valorCadastro").value)
};
if (!novo.codigo || !novo.nome || !novo.valor || isNaN(novo.valor)) {
alert("Preencha todos os campos corretamente");
return;
}
produtos.push(novo);
Storage.set("produtos", produtos);
atualizarProdutosTable();
atualizarScannerChart();
$("codigoCadastro").value = "";
$("nomeCadastro").value = "";
$("valorCadastro").value = "";
$("categoriaCadastro").value = "Alimentos";
$("tipoCadastro").value = "UN";
$("cadastro-title").innerText = "Cadastro de Produto";
irPara("produtos");
};
if ($("salvarCadastro")) {
$("salvarCadastro").onclick = salvarOriginal;
}
function atualizarCarrinho() {
let total = 0;
let html = `<tr><th>Nome</th><th>Qtd</th><th>Subtotal</th><th>A√ß√£o</th></tr>`;
carrinho.forEach((p, idx) => {
const sub = p.valor * p.qtd;
total += sub;
html += `
<tr>
<td>${p.nome}</td>
<td>${p.qtd}</td>
<td>R$ ${sub.toFixed(2)}</td>
<td><button class="deleteBtn" style="padding:4px 8px;font-size:14px;" onclick="removerDoCarrinho(${idx})">üóëÔ∏è</button></td>
</tr>`;
});
if ($("tabelaCarrinho")) $("tabelaCarrinho").innerHTML = html;
if ($("total")) $("total").innerText = "Total: R$ " + total.toFixed(2);
if ($("badge")) $("badge").innerText = carrinho.length;
atualizarOrcamento();
verificarOrcamento();
const badge = $("badge");
if (badge) {
badge.style.animation = "pulse 0.5s";
setTimeout(() => badge.style.animation = "", 500);
}
}
window.removerDoCarrinho = function(idx) {
carrinho.splice(idx, 1);
Storage.set("carrinho", carrinho);
atualizarCarrinho();
};
window.abrirCarrinho = function() {
$("modalCarrinho").style.display = "flex";
setTimeout(() => $("modalCarrinho").classList.add("active"), 10);
atualizarCarrinho();
};
window.fecharCarrinho = function() {
$("modalCarrinho").classList.remove("active");
setTimeout(() => {
$("modalCarrinho").style.display = "none";
if (document.getElementById("scanner")?.classList.contains("active")) {
setTimeout(() => {
pararScanner();
iniciarScanner();
}, 300);
}
}, 300);
};
window.finalizarCompra = function() {
if (!carrinho.length) {
alert("Carrinho vazio");
return;
}
const total = carrinho.reduce((a, b) => a + b.valor * b.qtd, 0);
historico.push({
  data: new Date().toLocaleString("pt-BR"),
  total,
  itens: [...carrinho]
});
Storage.set("historicoCompras", historico);
carrinho = [];
Storage.set("carrinho", carrinho);
atualizarCarrinho();
atualizarHistorico();
fecharCarrinho();
alert("Compra finalizada!");
};
function atualizarHistorico() {
const area = $("historicoConteudo");
if (!area) return;
area.innerHTML = "";
if (!historico.length) {
area.innerHTML = "<p style='text-align:center; color:var(--text-muted);'>Nenhuma compra registrada.</p>";
return;
}
historico.forEach((c, i) => {
let itens = "";
c.itens.forEach(it => {
itens += `<li>${it.nome} ‚Äî ${it.qtd} x R$ ${it.valor.toFixed(2)} = R$ ${(it.qtd * it.valor).toFixed(2)}</li>`;
});
area.innerHTML += `
<div class="historico-card">
<h4>Compra ${i + 1}</h4>
<small>${c.data}</small>
<p><strong>Total:</strong> R$ ${c.total.toFixed(2)}</p>
<details><summary style="color:var(--primary); cursor:pointer;">Ver itens</summary><ul>${itens}</ul></details>
</div>`;
});
}
async function iniciarScanner() {
if (!document.getElementById("scanner")?.classList.contains("active")) {
scannerAtivo = false;
return;
}
if (scannerAtivo || !navigator.mediaDevices) return;
scannerAtivo = true;
buffer = [];
if (!stream) {
try {
const constraints = {
video: {
facingMode: "environment",
advanced: [{ focusMode: "continuous" }]
}
};
stream = await navigator.mediaDevices.getUserMedia(constraints);
const video = $("video");
if (video) {
video.srcObject = stream;
await video.play().catch(e => console.warn("Erro ao play:", e));
}
} catch (err) {
try {
stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
const video = $("video");
if (video) {
video.srcObject = stream;
await video.play().catch(e => console.warn("Erro fallback:", e));
}
} catch (e2) {
alert("‚ö†Ô∏è Permiss√£o da c√¢mera negada ou n√£o suportada.");
scannerAtivo = false;
return;
}
}
}
reader = new ZXing.BrowserMultiFormatReader();
reader.decodeFromVideoElementContinuously($("video"), (res) => {
if (!res?.text || !scannerAtivo) return;
const codigoBruto = res.text;
const codigoNormalizado = normalizarCodigo(codigoBruto);
if (!codigoNormalizado) return;
buffer.push(codigoNormalizado);
if (buffer.length > repeticoes) buffer.shift();
const ultimosIguais = buffer.filter(v => v === codigoNormalizado).length;
if ($("detected")) $("detected").innerText = codigoBruto;
if ($("barraValidacaoInner")) {
$("barraValidacaoInner").style.width = (ultimosIguais / repeticoes * 100) + "%";
$("barraValidacaoInner").setAttribute('data-pct', Math.round(ultimosIguais / repeticoes * 100) + '%');
}
if (ultimosIguais >= repeticoes) {
scannerAtivo = false;
reader.reset();
processarCodigo(codigoNormalizado);
}
});
}
function processarCodigo(codigoNormalizado) {
try {
navigator.vibrate?.(50);
beep.play().catch(e => console.warn("Beep n√£o reproduzido:", e));
const produto = produtos.find(p => normalizarCodigo(p.codigo) === codigoNormalizado);
if (produto) {
  setTimeout(() => {
    solicitarQuantidade(produto.nome, (q) => {
      carrinho.push({ ...produto, qtd: q });
      Storage.set("carrinho", carrinho);
      abrirCarrinho();
    });
  }, 100);
} else {
$("codigoCadastro").value = codigoNormalizado;
$("nomeCadastro").value = "";
$("valorCadastro").value = "";
$("cadastro-title").innerText = "Cadastro R√°pido";
irPara("cadastro");
const handlerRapido = () => {
const novo = {
codigo: $("codigoCadastro").value.trim(),
nome: $("nomeCadastro").value.trim(),
categoria: $("categoriaCadastro").value,
tipo: $("tipoCadastro").value,
valor: Number($("valorCadastro").value)
};
if (!novo.nome || !novo.valor || isNaN(novo.valor)) {
alert("Preencha nome e valor corretamente.");
return;
}
produtos.push(novo);
Storage.set("produtos", produtos);
solicitarQuantidade(novo.nome, (q) => {
if (q > 0) {
carrinho.push({ ...novo, qtd: q });
Storage.set("carrinho", carrinho);
}
$("codigoCadastro").value = "";
$("nomeCadastro").value = "";
$("valorCadastro").value = "";
$("categoriaCadastro").value = "Alimentos";
$("tipoCadastro").value = "UN";
$("cadastro-title").innerText = "Cadastro de Produto";
$("salvarCadastro").onclick = () => salvarOriginal();
atualizarProdutosTable();
atualizarScannerChart();
atualizarCarrinho();
fecharQuantidade();
irPara("scanner");
});
};
$("salvarCadastro").onclick = handlerRapido;
if ($("barraValidacaoInner")) {
$("barraValidacaoInner").style.width = "0%";
$("barraValidacaoInner").setAttribute('data-pct', '0%');
}
buffer = [];
}
} catch (e) {
console.error("Erro ao processar c√≥digo:", e);
buffer = [];
}
}
function pararScanner() {
scannerAtivo = false;
if (reader) reader.reset();
if (stream) {
stream.getTracks().forEach(t => t.stop());
stream = null;
}
const video = $("video");
if (video && video.srcObject) {
video.srcObject.getTracks?.().forEach(t => t.stop());
video.srcObject = null;
}
}
function atualizarScannerChart() {
const categorias = {};
produtos.forEach(p => {
categorias[p.categoria] = (categorias[p.categoria] || 0) + 1;
});
const chartBox = $("scannerChartBox");
if (!chartBox || chartBox.offsetWidth === 0 || chartBox.offsetHeight === 0) {
setTimeout(atualizarScannerChart, 100);
return;
}
const canvas = $("categoriaChart");
if (!canvas) return;
canvas.width = chartBox.offsetWidth;
canvas.height = chartBox.offsetHeight;
if (window.categoriaChart) {
window.categoriaChart.destroy();
}
const categoriasOrdenadas = Object.entries(categorias).sort((a, b) => b[1] - a[1]);
const labels = categoriasOrdenadas.map(([cat]) => cat);
const values = categoriasOrdenadas.map(([, val]) => val);
const rootStyles = getComputedStyle(document.documentElement);
const textColor = rootStyles.getPropertyValue('--text').trim();
const textMutedColor = rootStyles.getPropertyValue('--text-muted').trim();
const cores = [
'#4361ee', '#3a56d4', '#4895ef', '#f87171', '#6b6b6b', '#9c27b0',
'#06b6d4', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#ef4444'
];
try {
const ctx = canvas.getContext("2d");
window.categoriaChart = new Chart(ctx, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'N√∫mero de Produtos',
data: values,
backgroundColor: labels.map((_, i) => cores[i % cores.length]),
borderWidth: 0
}]
},
options: {
indexAxis: 'y',
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { display: false },
tooltip: {
titleColor: textColor,
bodyColor: textColor,
backgroundColor: rootStyles.getPropertyValue('--card').trim(),
borderColor: rootStyles.getPropertyValue('--border').trim(),
borderWidth: 1,
callbacks: {
label: (ctx) => ` ${ctx.parsed.x} produtos`
}
}
},
scales: {
x: {
beginAtZero: true,
grid: { color: 'rgba(0,0,0,0.05)' },
ticks: { color: textMutedColor }
},
y: {
grid: { display: false },
ticks: { color: textColor }
}
}
}
});
} catch (e) {
console.error("Erro ao criar gr√°fico:", e);
setTimeout(atualizarScannerChart, 200);
}
}
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
if ($("modalCarrinho")?.classList.contains("active")) {
fecharCarrinho();
}
if ($("quantidadeModal").style.display === "block") {
fecharQuantidade();
}
}
});
if ($("modalCarrinho")) {
$("modalCarrinho").addEventListener('click', (e) => {
if (e.target === $("modalCarrinho")) {
fecharCarrinho();
}
});
}
$("overlayQuantidade").addEventListener('click', fecharQuantidade);
atualizarHistorico();
atualizarProdutosTable();
atualizarCarrinho();
setTimeout(() => {
atualizarScannerChart();
}, 500);
}
if ($("scanner")) {
const observer = new MutationObserver(() => {
if ($("scanner").classList.contains("active")) {
setTimeout(atualizarScannerChart, 100);
}
});
observer.observe($("scanner"), { attributes: true, attributeFilter: ['class'] });
}
window.addEventListener('resize', () => {
if (document.getElementById("scanner")?.classList.contains("active")) {
setTimeout(atualizarScannerChart, 100);
}
});
window.addEventListener('DOMContentLoaded', () => {
const splash = $("splash");
if (splash) {
splash.style.background = '#1e293b';
setTimeout(() => {
splash.style.opacity = '0';
setTimeout(() => {
if (splash.parentNode) splash.remove();
document.body.classList.remove('loading');
iniciarApp();
}, 500);
}, 2000);
} else {
iniciarApp();
}
});
if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('service-worker.js').catch(console.warn);
});
}
</script>
</body>
</html>
