<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compras do m√™s</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#eef3ff;
  margin:0;
}

.container{
  max-width:900px;
  margin:auto;
  padding:14px;
}

/* LOGO NO TOPO */
.logo-box{
  width:130px;
  height:130px;
  border-radius:50%;
  overflow:hidden;
  border:4px solid #2f6bff;
  margin:14px auto 4px auto;
}
.logo-box img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* CARD GERAL */
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  margin-top:14px;
}

/* V√çDEO */
#videoContainer{
  width:100%;
  height:260px;
  background:#000;
  overflow:hidden;
  border-radius:16px;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* BOT√ïES */
button{
  width:100%;
  border:none;
  padding:12px;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  margin-top:8px;
}
.primary{background:#2563ff;color:#fff;}
.stop{background:#6b7280;color:#fff;}

/* INPUTS CORRIGIDOS ‚Äì n√£o escapam mais */
input,select{
  width:100%;
  border-radius:12px;
  border:1px solid #cfd3dd;
  padding:12px;
  font-size:15px;
  box-sizing:border-box;   /* <- impede sair do ret√¢ngulo */
  margin-top:8px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}

</style>
</head>

<body>

<div class="container">

<!-- LOGO .JPG solicitada -->
<div class="logo-box">
  <img src="logo.jpg">
</div>

<h1 style="text-align:center;">üõí Compras do m√™s</h1>

<!-- SCANNER -->
<div class="card">
  <button id="startBtn" class="primary">üì∑ Abrir c√¢mera</button>
  <button id="stopBtn" class="stop">‚èπ Parar</button>

  <div id="videoContainer">
    <video id="video" playsinline></video>
  </div>

  <p><b>C√≥digo detectado:</b> <span id="detectedCode">‚Äî</span></p>
</div>

<!-- TABELA PRODUTOS -->
<div class="card">
  <h2>üì¶ Produtos cadastrados</h2>

  <table>
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Pre√ßo</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="productTable"></tbody>
  </table>
</div>

<!-- EDI√á√ÉO / CADASTRO -->
<div class="card">
  <h2>‚úèÔ∏è Edi√ß√£o de produto</h2>

  <input id="codeInput" placeholder="C√≥digo" readonly>
  <input id="nameInput" placeholder="Nome">

  <select id="typeInput">
    <option value="UN">Unidade (UN)</option>
    <option value="KG">Quilo (KG)</option>
  </select>

  <input id="priceInput" type="number" step="0.01" placeholder="Pre√ßo">

  <button id="saveBtn" class="primary">üíæ Salvar altera√ß√µes</button>
</div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let codeReader = new ZXing.BrowserMultiFormatReader();
let stream = null;

let products = JSON.parse(localStorage.getItem("products") || "[]");
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

function saveData(){
  localStorage.setItem("products", JSON.stringify(products));
  localStorage.setItem("cart", JSON.stringify(cart));
}

function renderTable(){
  productTable.innerHTML = "";
  products.forEach((p,i)=>{
    productTable.innerHTML += `
      <tr>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>${p.type}</td>
        <td>${p.price}</td>
        <td>
          <button onclick="edit(${i})">Editar</button>
        </td>
      </tr>`;
  });
}
renderTable();

function edit(i){
  let p = products[i];
  codeInput.value = p.code;
  nameInput.value = p.name;
  typeInput.value = p.type;
  priceInput.value = p.price;
}

/* ====== SCANNER LOGIC NOVA ====== */

let lastCode = "";
let repeatCount = 0;

startBtn.onclick = async ()=>{

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"},
    audio:false
  });

  video.srcObject = stream;
  video.play();

  codeReader.decodeFromVideoDevice(null, "video", (result)=>{

    if(!result) return;

    // confirma 3 leituras iguais para precis√£o
    if(result.text === lastCode){
      repeatCount++;
    } else {
      repeatCount = 1;
      lastCode = result.text;
    }

    if(repeatCount < 3) return;

    const code = result.text;
    detectedCode.textContent = code;

    // verifica se j√° existe na base
    const found = products.find(p=>p.code == code);

    if(found){

      // perguntar quantidade
      let q = prompt("Produto encontrado: " + found.name + "\nDigite a quantidade para adicionar ao carrinho:");

      if(q && !isNaN(q)){
        q = Number(q);

        let item = cart.find(c=>c.code==code);
        if(item){
          item.quantity += q;
        }else{
          cart.push({
            code:code,
            name:found.name,
            price:Number(found.price),
            quantity:q
          });
        }

        saveData();
        alert("Adicionado ao carrinho!");
      }

    } else {
      // n√£o cadastrado ‚Üí prepara cadastro
      codeInput.value = code;
      nameInput.focus();
    }
  });
};

stopBtn.onclick = ()=>{
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  codeReader.reset();
};

/* ====== SALVAR PRODUTO ====== */

saveBtn.onclick = ()=>{

  let code = codeInput.value;
  let name = nameInput.value;
  let type = typeInput.value;
  let price = priceInput.value;

  if(!code){ alert("C√≥digo vazio"); return; }

  let existing = products.find(p=>p.code==code);

  if(existing){
    existing.name = name;
    existing.type = type;
    existing.price = price;
  }else{
    products.push({code,name,type,price});
  }

  saveData();
  renderTable();
  alert("Produto salvo!");
};
</script>

</body>
</html>
